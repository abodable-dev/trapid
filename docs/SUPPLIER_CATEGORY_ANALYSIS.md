# Supplier-Category Relationship Analysis

**Generated:** 2025-11-05
**Source:** `easybuildapp development Price Books(in).csv`
**Total Records Analyzed:** 5,501 items

---

## Executive Summary

### Key Statistics

- **Total Suppliers:** 126
- **Total Categories:** 89
- **Unique Supplier-Category Relationships:** 162
- **Total Price Book Items:** 5,129
- **Average Items per Supplier:** 40.7
- **Average Categories per Supplier:** 1.3

### Key Findings

1. **Most suppliers are highly specialized** (95% work in a single category)
2. **Only 2 suppliers work across 5+ categories:**
   - Pre Hung Doors (PHD): 5 categories
   - Bunnings: 9 categories
3. **Lovering Installations QLD dominates** with 1,483 items (28.9% of all items)
4. **TURN KEY category is the largest** with 1,464 items from a single supplier

---

## Top 30 Suppliers by Item Count

| Rank | Supplier | Total Items | Categories | Primary Category | % in Primary |
|------|----------|-------------|------------|------------------|--------------|
| 1 | Lovering Installations QLD | 1,483 | 3 | TURN KEY | 98.7% |
| 2 | Pre Hung Doors (PHD) | 555 | 5 | INTERNAL DOORS | 38.6% |
| 3 | Harvey Norman Commercial QLD | 353 | 2 | PLUMBING FITOFF GEAR | 90.7% |
| 4 | Bunnings | 193 | 9 | EXTERNAL CLADDING | 63.2% |
| 5 | Ausreo Pty Ltd | 163 | 1 | STEEL MESH | 100% |
| 6 | Civic Shower Screens & Wardrobes | 160 | 3 | MIRRORS | 41.9% |
| 7 | Fluid Building Approvals | 139 | 1 | PRIVATE CERTIFIER | 100% |
| 8 | TIMBER FRAME | 122 | 1 | TIMBER FRAME | 100% |
| 9 | QUICK SPEC | 111 | 1 | QUICK SPEC | 100% |
| 10 | NATIONAL TILES CO PTY LTD | 105 | 1 | TILE | 100% |
| 11 | Austral - Rochedale | 98 | 1 | BRICKS | 100% |
| 12 | Wayke Waterproofing. Ware | 85 | 2 | WET SEAL | 98.8% |
| 13 | Sunstate Garage Doors (Travis Voigt TA) | 84 | 1 | GARAGE DOORS | 100% |
| 14 | PLUMBER | 69 | 1 | PLUMBER | 100% |
| 15 | Tekna Carpentry | 68 | 1 | CARPENTER | 100% |
| 16 | Joii Roofing | 59 | 2 | ROOF | 98.3% |
| 17 | Tekna Site | 57 | 3 | SITE CLEAN | 66.7% |
| 18 | FENCING | 51 | 1 | FENCING | 100% |
| 19 | CONCRETOR | 49 | 1 | CONCRETOR | 100% |
| 20 | FLOOR COVERING | 47 | 1 | FLOOR COVERING | 100% |
| 21 | PAINTER | 46 | 1 | PAINTER | 100% |
| 22 | Survey Mark | 43 | 1 | SURVEYOR | 100% |
| 23 | SCAFFOLD | 42 | 1 | SCAFFOLD | 100% |
| 24 | Aspect Joinery Pty Ltd | 39 | 2 | CABINET MAKER | 97.4% |
| 25 | SOFFIT | 38 | 1 | SOFFIT | 100% |
| 26 | ReadyMix Concrete | 36 | 2 | DRIVEWAY | 55.6% |
| 27 | Hafele | 36 | 2 | PLUMBING FITOFF GEAR | 75.0% |
| 28 | LANDSCAPING | 35 | 2 | LANDSCAPING | 97.1% |
| 29 | TL Electrical | 34 | 2 | ELECTRICAL | 97.1% |
| 30 | Star Airconditioning | 33 | 1 | AIR CONDITIONING | 100% |

---

## Top 20 Categories by Item Count

| Rank | Category | Total Items | Suppliers | Top Supplier | Top Supplier Items |
|------|----------|-------------|-----------|--------------|-------------------|
| 1 | TURN KEY | 1,464 | 1 | Lovering Installations QLD | 1,464 |
| 2 | PLUMBING FITOFF GEAR | 348 | 3 | Harvey Norman Commercial QLD | 320 |
| 3 | INTERNAL DOORS | 214 | 1 | Pre Hung Doors (PHD) | 214 |
| 4 | STEEL MESH | 163 | 1 | Ausreo Pty Ltd | 163 |
| 5 | ENTRY DOORS | 152 | 1 | Pre Hung Doors (PHD) | 152 |
| 6 | PRIVATE CERTIFIER | 150 | 3 | Fluid Building Approvals | 139 |
| 7 | DOOR FURNITURE | 141 | 3 | Pre Hung Doors (PHD) | 124 |
| 8 | TIMBER FRAME | 124 | 2 | TIMBER FRAME | 122 |
| 9 | EXTERNAL CLADDING | 124 | 2 | Bunnings | 122 |
| 10 | TILE | 112 | 2 | NATIONAL TILES CO PTY LTD | 105 |
| 11 | QUICK SPEC | 111 | 1 | QUICK SPEC | 111 |
| 12 | BRICKS | 98 | 1 | Austral - Rochedale | 98 |
| 13 | WET SEAL | 88 | 4 | Wayke Waterproofing. Ware | 84 |
| 14 | PLUMBER | 84 | 2 | PLUMBER | 69 |
| 15 | GARAGE DOORS | 84 | 1 | Sunstate Garage Doors | 84 |
| 16 | APPLIANCES | 73 | 4 | Harvey Norman Commercial QLD | 33 |
| 17 | CABINET MAKER | 72 | 5 | Aspect Joinery Pty Ltd | 38 |
| 18 | CARPENTER | 71 | 4 | Tekna Carpentry | 68 |
| 19 | MIRRORS | 67 | 1 | Civic Shower Screens & Wardrobes | 67 |
| 20 | FIX-OUT MATERIALS | 65 | 2 | Pre Hung Doors (PHD) | 64 |

---

## Multi-Category Suppliers Analysis

### Suppliers Working Across 5+ Categories

Only **2 suppliers** (1.6%) work across 5 or more categories:

#### 1. Pre Hung Doors (PHD) - 5 Categories
- **INTERNAL DOORS:** 214 items (38.6%)
- **ENTRY DOORS:** 152 items (27.4%)
- **DOOR FURNITURE:** 124 items (22.3%)
- **FIX-OUT MATERIALS:** 64 items (11.5%)
- **SOFFIT:** 1 item (0.2%)

**Analysis:** Highly focused on doors and related materials

#### 2. Bunnings - 9 Categories
- **EXTERNAL CLADDING:** 122 items (63.2%)
- **BRICK HARDWARE:** 26 items (13.5%)
- **HARDWARE:** 20 items (10.4%)
- **SOFFIT:** 19 items (9.8%)
- **TIMBER FRAME:** 2 items (1.0%)
- **TRUSSES:** 1 item (0.5%)
- **FIX-OUT MATERIALS:** 1 item (0.5%)
- **CARPENTER:** 1 item (0.5%)
- **APPLIANCES:** 1 item (0.5%)

**Analysis:** General hardware supplier with broad but limited inventory in each category

### Suppliers Working Across 2-4 Categories

**7 suppliers** work across 2-4 categories:

1. **Lovering Installations QLD** (3 categories): TURN KEY, LETTERBOXES, CLOTHES LINES
2. **Civic Shower Screens & Wardrobes** (3 categories): MIRRORS, SHOWER SCREENS, WARDROBE DOORS
3. **Harvey Norman Commercial QLD** (2 categories): PLUMBING FITOFF GEAR, APPLIANCES
4. **Tekna Site** (3 categories): SITE CLEAN, SITE WORKS, MACHINERY
5. **Joii Landscaping** (4 categories): FENCING, LANDSCAPING, RETAINING WALL, CLOTHES LINES
6. **Joii Roofing** (2 categories): ROOF, SCAFFOLD

---

## Supplier Specialization Patterns

### Highly Specialized (95%+ in Primary Category)

**112 suppliers** (88.9%) are highly specialized, with 95% or more of their items in a single category.

**Examples:**
- Lovering Installations QLD: 98.7% in TURN KEY
- Wayke Waterproofing. Ware: 98.8% in WET SEAL
- Joii Roofing: 98.3% in ROOF
- Aspect Joinery Pty Ltd: 97.4% in CABINET MAKER
- LANDSCAPING: 97.1% in LANDSCAPING
- TL Electrical: 97.1% in ELECTRICAL

### Single-Category Suppliers (100%)

**105 suppliers** (83.3%) work exclusively in a single category.

---

## Implementation Recommendations

### Option A: JSON Field in Suppliers Table ✅ RECOMMENDED

**Advantages:**
- ✅ Suppliers table already exists with `trade_categories` field (TEXT)
- ✅ No new tables or migrations needed
- ✅ Fast to implement
- ✅ Easy to query primary category
- ✅ Supports complex category metadata (item counts, percentages)

**Structure:**
```json
{
  "trade_categories": [
    {
      "name": "INTERNAL DOORS",
      "item_count": 214,
      "percentage": 38.6,
      "is_primary": true
    },
    {
      "name": "ENTRY DOORS",
      "item_count": 152,
      "percentage": 27.4,
      "is_primary": false
    }
  ],
  "is_default_for_trades": "INTERNAL DOORS"
}
```

**Queries:**
```ruby
# Find suppliers for a category
Supplier.where("is_default_for_trades = ?", "PLUMBER")

# Find suppliers who work in a category (even if not primary)
Supplier.where("trade_categories LIKE ?", "%ELECTRICAL%")

# Get supplier's primary category
supplier.is_default_for_trades

# Get all categories for supplier with details
JSON.parse(supplier.trade_categories)
```

### Option B: Join Table (supplier_categories)

**Advantages:**
- More normalized database design
- Easier to query relationships
- Better for reporting

**Disadvantages:**
- ❌ Requires migration
- ❌ More complex queries
- ❌ Need to manage join records

**Not recommended** since Option A already exists and is simpler.

---

## Implementation Plan

### Step 1: Run the Rake Task

```bash
cd /Users/jakebaird/trapid/backend
rails suppliers:populate_categories
```

This will:
1. Parse the CSV file
2. Calculate categories for each supplier
3. Update/create supplier records
4. Store category data in `trade_categories` JSON field
5. Set `is_default_for_trades` to primary category

### Step 2: Verify Results

```bash
# Show suppliers by category
rails suppliers:show_by_category

# Show multi-category suppliers
rails suppliers:show_multi_category

# Export to JSON for review
rails suppliers:export_mapping
```

### Step 3: Update Application Logic

**Backend:**
- Add method to Supplier model to get categories
- Add scopes for querying by category
- Update API to return category information

**Frontend:**
- Display supplier categories in supplier detail view
- Add category filter to supplier selection
- Show primary category badge in supplier lists

---

## Example Usage

### Find Suppliers by Category

```ruby
# Primary category only
electricians = Supplier.where(is_default_for_trades: "ELECTRICAL")

# Any category (including secondary)
plumbing_suppliers = Supplier.where("trade_categories LIKE ?", "%PLUMBING%")
```

### Get Supplier Category Details

```ruby
supplier = Supplier.find_by(name: "Pre Hung Doors (PHD)")

# Primary category
supplier.is_default_for_trades
# => "INTERNAL DOORS"

# All categories with details
categories = JSON.parse(supplier.trade_categories)
# => [
#   {"name"=>"INTERNAL DOORS", "item_count"=>214, "percentage"=>38.6, "is_primary"=>true},
#   {"name"=>"ENTRY DOORS", "item_count"=>152, "percentage"=>27.4, "is_primary"=>false},
#   ...
# ]

# Get just category names
categories.map { |c| c['name'] }
# => ["INTERNAL DOORS", "ENTRY DOORS", "DOOR FURNITURE", "FIX-OUT MATERIALS", "SOFFIT"]
```

### Supplier Model Extensions

```ruby
# Add to app/models/supplier.rb
class Supplier < ApplicationRecord
  def categories
    return [] if trade_categories.blank?
    JSON.parse(trade_categories).map { |c| c['name'] }
  rescue JSON::ParserError
    []
  end

  def category_details
    return [] if trade_categories.blank?
    JSON.parse(trade_categories)
  rescue JSON::ParserError
    []
  end

  def primary_category
    is_default_for_trades
  end

  def works_in_category?(category_name)
    categories.include?(category_name)
  end

  def multi_category?
    categories.size > 1
  end

  # Scopes
  scope :for_category, ->(category) {
    where("is_default_for_trades = ? OR trade_categories LIKE ?",
          category, "%#{category}%")
  }

  scope :multi_category, -> {
    where("trade_categories LIKE '%is_primary%'
           AND trade_categories LIKE '%\"is_primary\":false%'")
  }

  scope :specialized, -> {
    where.not(trade_categories: nil)
         .where("(trade_categories::jsonb->0->>'percentage')::float >= 95")
  }
end
```

---

## API Endpoints to Add

### 1. Get Suppliers by Category

```
GET /api/v1/suppliers?category=ELECTRICAL

Response:
{
  "suppliers": [
    {
      "id": 29,
      "name": "TL Electrical",
      "primary_category": "ELECTRICAL",
      "categories": [
        {
          "name": "ELECTRICAL",
          "item_count": 33,
          "percentage": 97.1,
          "is_primary": true
        },
        {
          "name": "LIGHT FIT",
          "item_count": 1,
          "percentage": 2.9,
          "is_primary": false
        }
      ],
      "contact_person": null,
      "phone": null,
      "email": null
    }
  ]
}
```

### 2. Get All Categories

```
GET /api/v1/categories

Response:
{
  "categories": [
    {
      "name": "TURN KEY",
      "total_items": 1464,
      "supplier_count": 1,
      "top_supplier": "Lovering Installations QLD"
    },
    {
      "name": "PLUMBING FITOFF GEAR",
      "total_items": 348,
      "supplier_count": 3,
      "top_supplier": "Harvey Norman Commercial QLD"
    },
    ...
  ]
}
```

### 3. Get Supplier Category Details

```
GET /api/v1/suppliers/:id/categories

Response:
{
  "supplier": {
    "id": 2,
    "name": "Pre Hung Doors (PHD)",
    "primary_category": "INTERNAL DOORS"
  },
  "categories": [
    {
      "name": "INTERNAL DOORS",
      "item_count": 214,
      "percentage": 38.6,
      "is_primary": true
    },
    {
      "name": "ENTRY DOORS",
      "item_count": 152,
      "percentage": 27.4,
      "is_primary": false
    },
    ...
  ]
}
```

---

## Testing Queries

```ruby
# Rails console examples

# 1. Find all electricians
Supplier.where(is_default_for_trades: "ELECTRICAL")

# 2. Find all suppliers who do plumbing (primary or secondary)
Supplier.where("trade_categories LIKE ?", "%PLUMBING%")

# 3. Get category breakdown for a supplier
supplier = Supplier.find_by(name: "Bunnings")
JSON.parse(supplier.trade_categories)

# 4. Count suppliers per category
categories = Supplier.pluck(:is_default_for_trades).compact
categories.group_by(&:itself).transform_values(&:count).sort_by { |_, v| -v }

# 5. Find multi-category suppliers
Supplier.select { |s|
  s.trade_categories.present? && JSON.parse(s.trade_categories).size > 1
}

# 6. Find specialized suppliers (95%+ in primary)
Supplier.select { |s|
  next false if s.trade_categories.blank?
  categories = JSON.parse(s.trade_categories)
  primary = categories.find { |c| c['is_primary'] }
  primary && primary['percentage'] >= 95
}
```

---

## Files Generated

1. **supplier_categories_mapping.json** (126 suppliers)
   - Complete mapping of each supplier to their categories
   - Includes item counts and percentages
   - Sorted by total items

2. **category_suppliers_mapping.json** (89 categories)
   - Complete mapping of each category to suppliers
   - Includes top supplier per category
   - Sorted by total items

3. **supplier_category_relationships.json** (162 relationships)
   - Simple flat list of all supplier-category pairs
   - Includes item counts
   - Useful for database import

4. **backend/lib/tasks/populate_supplier_categories.rake**
   - Rake task to populate database
   - Multiple sub-tasks for analysis
   - Reusable for future updates

---

## Next Steps

1. ✅ **Run the rake task** to populate supplier categories
2. ✅ **Verify the data** using the show tasks
3. **Add model methods** for easy category access
4. **Update API** to expose category information
5. **Update frontend** to display and filter by categories
6. **Add category selection** when creating purchase orders
7. **Show recommended suppliers** based on item category

---

## Business Impact

### Benefits

1. **Better Supplier Selection:** Know which suppliers specialize in which categories
2. **Smarter Defaults:** Auto-suggest suppliers based on item category
3. **Supplier Management:** Track supplier capabilities and specializations
4. **Purchase Order Efficiency:** Route orders to appropriate suppliers
5. **Supplier Performance:** Compare suppliers within same categories
6. **Cost Analysis:** Analyze pricing across suppliers per category

### Use Cases

1. **Creating a Purchase Order:**
   - Select item category → System suggests relevant suppliers
   - Show suppliers ranked by specialization in that category

2. **Supplier Discovery:**
   - Search for suppliers by category
   - Filter by primary vs. secondary category expertise

3. **Price Comparison:**
   - Compare prices across suppliers in same category
   - Identify primary vs. secondary category pricing

4. **Supplier Reliability:**
   - Track performance by category
   - Identify best-in-category suppliers

---

## Maintenance

### Updating Categories

When new price book items are added:

```bash
# Re-run the rake task
rails suppliers:populate_categories
```

This will update existing suppliers and add new ones without duplicating data.

### Adding New Suppliers

New suppliers will automatically get categories assigned if they appear in the price book CSV.

### Manual Category Assignment

```ruby
supplier = Supplier.find_by(name: "New Supplier")
supplier.trade_categories = [
  {
    name: "ELECTRICAL",
    item_count: 50,
    percentage: 100.0,
    is_primary: true
  }
].to_json
supplier.is_default_for_trades = "ELECTRICAL"
supplier.save!
```

---

## Conclusion

The supplier-category relationship data reveals a highly specialized supplier ecosystem:

- **88.9% of suppliers** focus on a single category (95%+ of their items)
- **83.3% of suppliers** exclusively work in one category
- **Only 2 suppliers** work across 5+ categories (Bunnings and Pre Hung Doors)

**Recommendation:** Implement using the existing `trade_categories` JSON field in the Suppliers table. This provides:
- ✅ Zero migration overhead
- ✅ Rich metadata storage (item counts, percentages)
- ✅ Fast primary category lookup via `is_default_for_trades`
- ✅ Flexible querying for both primary and secondary categories

**Implementation Time:** < 30 minutes to run rake task and verify results.
