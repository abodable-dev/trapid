# TRAPID BIBLE - Development Rules

**Version:** 2.0.0
**Last Updated:** 2025-11-17 11:28 AEST
**Authority Level:** ABSOLUTE
**Audience:** Claude Code + Human Developers
**Source of Truth:** Database table `bible_rules` (this file is auto-generated)

---

## ğŸ”´ CRITICAL: Read This First

### This Document is "The Bible"

This file is the **absolute authority** for all Trapid development where chapters exist.

**This Bible Contains RULES ONLY:**
- âœ… MUST do this
- âŒ NEVER do that
- ğŸ”„ ALWAYS check X before Y
- ğŸ”’ Protected code patterns
- âš™ï¸ Configuration values that must match

**This file is AUTO-GENERATED from the database.**
- **DO NOT edit this file directly**
- Update rules via Trapid app â†’ Documentation page â†’ ğŸ“– Bible
- Export to markdown via: `bin/rails trapid:export_bible`

**For IMPLEMENTATION PATTERNS (code examples, how-to guides):**
- ğŸ”§ See [TRAPID_TEACHER.md](TRAPID_TEACHER.md)

**For KNOWLEDGE (how things work, bug history, why we chose X):**
- ğŸ“• See [TRAPID_LEXICON.md](TRAPID_LEXICON.md)

**For USER GUIDES (how to use features):**
- ğŸ“˜ See [TRAPID_USER_MANUAL.md](TRAPID_USER_MANUAL.md)

---

# Chapter 0: System-Wide Rules

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”§ TEACHER (HOW):     TRAPID_TEACHER.md Ch0    â”‚
â”‚ ğŸ“• LEXICON (BUGS):    TRAPID_LEXICON.md Ch0    â”‚
â”‚ ğŸ“˜ USER MANUAL (USE): TRAPID_USER_MANUAL.md Ch0 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

**Last Updated:** 2025-11-17 10:57 AEST

## RULE #0.1: Mandatory Chapter Reading Before Component Creation

âœ… MUST

âœ… **MUST complete all three documents:**

âŒ **NEVER leave a chapter partially complete**
- Bible without Lexicon = Rules without context (BAD)
- Bible without User Manual = No user-facing guide (BAD)
- Only Bible completed = INCOMPLETE Trinity (BAD)

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§0.1](TRAPID_TEACHER.md#01-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 0](TRAPID_LEXICON.md)

---

# Chapter 1: Authentication

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”§ TEACHER (HOW):     TRAPID_TEACHER.md Ch1    â”‚
â”‚ ğŸ“• LEXICON (BUGS):    TRAPID_LEXICON.md Ch1    â”‚
â”‚ ğŸ“˜ USER MANUAL (USE): TRAPID_USER_MANUAL.md Ch1 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

**Last Updated:** 2025-11-17 10:57 AEST

## RULE #1.1: JWT Token Handling

âœ… MUST

âœ… **MUST:**
- Use `JsonWebToken.encode` to create tokens
- Include `user_id` in payload
- Set expiration to 24 hours maximum
- Send token in `Authorization: Bearer <token>` header

âŒ **NEVER:**
- Store sensitive data in JWT payload (it's base64, not encrypted)
- Create tokens without expiration
- Share SECRET_KEY across environments
- Store tokens in localStorage (XSS vulnerable) - use httpOnly cookies on frontend

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§1.1](TRAPID_TEACHER.md#11-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 1](TRAPID_LEXICON.md)

---

---

## RULE #1.2: Password Security Requirements

âœ… MUST

âœ… **MUST enforce:**
- Minimum 12 characters (NOT 8, NOT 10)
- At least 1 uppercase letter [A-Z]
- At least 1 lowercase letter [a-z]
- At least 1 digit [0-9]
- At least 1 special character [!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]

âŒ **NEVER:**
- Log passwords (even hashed)
- Send passwords in API responses
- Store passwords in plain text
- Allow common passwords (implement dictionary check if needed)

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§1.2](TRAPID_TEACHER.md#12-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 1](TRAPID_LEXICON.md)

---

---

## RULE #1.3: Role-Based Access Control

âœ… MUST

âœ… **MUST:**
- Use predefined roles: `user`, `admin`, `product_owner`, `estimator`, `supervisor`, `builder`
- Check permissions via User model methods (`can_create_templates?`, `can_edit_schedule?`)
- Use `before_action :require_admin` for admin-only endpoints
- Set default role to `"user"` for new signups

âŒ **NEVER:**
- Create roles dynamically via API
- Store roles outside the enum
- Bypass permission checks with hardcoded user IDs
- Grant admin role automatically (even for @tekna.com.au emails)

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§1.3](TRAPID_TEACHER.md#13-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 1](TRAPID_LEXICON.md)

---

---

## RULE #1.4: Rate Limiting on Auth Endpoints

âœ… MUST

âœ… **MUST configure:**
- Auth endpoints: 5 requests per 20 seconds per IP
- Password reset: 3 requests per hour per email
- General API: 300 requests per 5 minutes per IP

âŒ **NEVER:**
- Disable rate limiting in production
- Use same limits for external vs internal APIs
- Skip rate limiting for "trusted" IPs (é™¤é explicitly whitelisted)

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§1.4](TRAPID_TEACHER.md#14-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 1](TRAPID_LEXICON.md)

---

---

## RULE #1.5: OAuth Integration Pattern

âœ… MUST

âœ… **MUST:**
- Use OmniAuth gem for all OAuth providers
- Store `provider`, `uid`, `oauth_token`, `oauth_expires_at` on User
- Generate random password for OAuth users (via `SecureRandom.hex`)
- Return JWT token after OAuth callback
- Validate OAuth tokens on every external API call

âŒ **NEVER:**
- Store OAuth refresh tokens in database (security risk)
- Share OAuth tokens across users
- Skip token expiration checks
- Use OAuth for internal user creation (only for login)

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§1.5](TRAPID_TEACHER.md#15-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 1](TRAPID_LEXICON.md)

---

---

## RULE #1.6: Password Reset Flow

âœ… MUST

âœ… **MUST:**
- Generate token via `SecureRandom.urlsafe_base64(32)`
- Store hashed token in database (NOT plain text)
- Set `reset_password_sent_at` timestamp
- Expire tokens after 2 hours
- Clear token after successful reset
- Send reset email with token URL

âŒ **NEVER:**
- Store tokens in plain text
- Reuse tokens across multiple resets
- Skip token expiration check
- Send token in API response (only via email)

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§1.6](TRAPID_TEACHER.md#16-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 1](TRAPID_LEXICON.md)

---

---

## RULE #1.7: Portal User Separation

âœ… MUST

âœ… **MUST:**
- Use separate `portal_users` table (NOT users table)
- Associate portal users with `Contact` record
- Implement account lockout for portal users (5 failed attempts = 30 min lockout)
- Log all portal user activities via `PortalAccessLog`
- Use `portal_type` enum: `'supplier'` or `'customer'`

âŒ **NEVER:**
- Mix portal users and admin users in same table
- Grant admin access to portal users
- Skip activity logging for portal users
- Allow portal users to access internal APIs

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§1.7](TRAPID_TEACHER.md#17-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 1](TRAPID_LEXICON.md)

---

---

## RULE #1.8: Login Activity Tracking

âœ… MUST

âœ… **MUST:**
- Update `last_login_at` timestamp on successful login
- Store in UTC timezone
- Track for both User and PortalUser
- Use for account activity monitoring

âŒ **NEVER:**
- Update on token refresh (only on actual login)
- Track in local timezone
- Skip updates (used for security monitoring)

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§1.8](TRAPID_TEACHER.md#18-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 1](TRAPID_LEXICON.md)

---

---

# Chapter 2: System Admin

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”§ TEACHER (HOW):     TRAPID_TEACHER.md Ch2    â”‚
â”‚ ğŸ“• LEXICON (BUGS):    TRAPID_LEXICON.md Ch2    â”‚
â”‚ ğŸ“˜ USER MANUAL (USE): TRAPID_USER_MANUAL.md Ch2 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

**Last Updated:** 2025-11-17 10:57 AEST

## RULE #2.1: Company Settings Singleton Pattern

âœ… MUST

âœ… **MUST implement as singleton:**

âœ… **MUST access via instance method:**

âŒ **NEVER:**
- Create multiple CompanySetting records (singleton = one record only)
- Hardcode configuration values instead of reading from settings
- Use `CompanySetting.first` (use `CompanySetting.instance`)
- Call `CompanySetting.create` manually (use `instance` method)

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§2.1](TRAPID_TEACHER.md#21-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 2](TRAPID_LEXICON.md)

---

---

## RULE #2.2: Timezone Handling - Backend Time Calculations

âœ… MUST

âœ… **MUST use CompanySetting timezone methods:**

âœ… **MUST use Time.use_zone context:**

âŒ **NEVER:**
- Use `Date.today` or `Time.now` without timezone context
- Store dates/times in UTC without timezone conversion
- Assume server timezone matches company timezone
- Use JavaScript `new Date()` for date calculations (see RULE #2.3)

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§2.2](TRAPID_TEACHER.md#22-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 2](TRAPID_LEXICON.md)

---

---

## RULE #2.3: Timezone Handling - Frontend Time Display

âœ… MUST

âœ… **MUST use Intl API with explicit timezone:**

âœ… **MUST import and use timezone utilities:**

âŒ **NEVER:**
- Use `Date.toLocaleDateString()` without timeZone parameter (uses browser timezone!)
- Use `Date.toLocaleString()` without explicit timezone
- Use date libraries without timezone configuration (moment.js, date-fns)
- Assume user's browser timezone matches company timezone

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§2.3](TRAPID_TEACHER.md#23-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 2](TRAPID_LEXICON.md)

---

---

## RULE #2.4: Working Days Configuration & Business Day Calculations

âœ… MUST

âœ… **MUST implement working_day? and business_day? methods:**

âœ… **MUST use in date calculations:**

âŒ **NEVER:**
- Hardcode working days as Monday-Friday only (some industries work Sundays, skip Saturdays)
- Use Rails' `business_day?` method (doesn't respect company settings)
- Calculate task dates without checking working_days
- Allow cascade to schedule tasks on non-working days (exception: locked tasks)

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§2.4](TRAPID_TEACHER.md#24-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 2](TRAPID_LEXICON.md)

---

---

## RULE #2.5: User Roles & Permission System

âœ… MUST

âœ… **MUST implement permission helper methods:**

âœ… **MUST check permissions in controllers:**

âŒ **NEVER:**
- Allow users to change their own role (admin-only operation)
- Grant permissions based on string matching role names
- Skip permission checks in controllers ("I'll handle it in the UI")
- Use role checking in frontend only (backend MUST validate)

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§2.5](TRAPID_TEACHER.md#25-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 2](TRAPID_LEXICON.md)

---

---

## RULE #2.6: Assignable Roles for Task Assignment

âœ… MUST

âœ… **MUST use assignable_role for task filtering:**

âŒ **NEVER:**
- Confuse system role (permissions) with assignable_role (task filtering)
- Use system role for task assignment
- Allow users with assignable_role: none to be assigned tasks
- Hardcode role names in task queries

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§2.6](TRAPID_TEACHER.md#26-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 2](TRAPID_LEXICON.md)

---

---

## RULE #2.7: Password Complexity Requirements

âœ… MUST

âœ… **MUST validate password complexity:**

âœ… **MUST generate random password for OAuth users:**

âŒ **NEVER:**
- Allow passwords shorter than 12 characters
- Allow passwords without uppercase, lowercase, digit, and special character
- Require OAuth users to set passwords (they don't use them)
- Store passwords in plain text (use bcrypt via has_secure_password)

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§2.7](TRAPID_TEACHER.md#27-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 2](TRAPID_LEXICON.md)

---

---

## RULE #2.8: Timezone Options Limitation

âœ… MUST

âœ… **MUST use this exact list:**

âœ… **MUST use select with these options:**

âŒ **NEVER:**
- Allow free-text timezone entry (validation nightmare)
- Show all 400+ IANA timezones (overwhelming, unnecessary)
- Use timezone abbreviations (AEST, AEDT - ambiguous)
- Default to UTC (construction companies operate in specific regions)

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§2.8](TRAPID_TEACHER.md#28-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 2](TRAPID_LEXICON.md)

---

---

## RULE #2.9: Working Days UI - Sunday Default True

âœ… MUST

âœ… **MUST initialize with Sunday = true:**

âœ… **MUST show checkboxes for all 7 days:**

âŒ **NEVER:**
- Hardcode Monday-Friday as only working days
- Hide Sunday checkbox (some companies DO work Sundays)
- Default all days to true (Saturday rarely worked)
- Prevent users from customizing working days

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§2.9](TRAPID_TEACHER.md#29-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 2](TRAPID_LEXICON.md)

---

---

# Chapter 3: Contacts

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”§ TEACHER (HOW):     TRAPID_TEACHER.md Ch3    â”‚
â”‚ ğŸ“• LEXICON (BUGS):    TRAPID_LEXICON.md Ch3    â”‚
â”‚ ğŸ“˜ USER MANUAL (USE): TRAPID_USER_MANUAL.md Ch3 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

**Last Updated:** 2025-11-17 10:57 AEST

## RULE #3.1: Contact Types are Multi-Select Arrays

âœ… MUST

âœ… **MUST:**
- Use `contact_types` as PostgreSQL array column
- Allow multiple types: `['customer', 'supplier']` for hybrid contacts
- Set `primary_contact_type` automatically if blank (first type in array)
- Validate types against `CONTACT_TYPES = ['customer', 'supplier', 'sales', 'land_agent']`
- Use array operations for querying: `where("'supplier' = ANY(contact_types)")`

âŒ **NEVER:**
- Use single contact_type field (legacy pattern)
- Store types as comma-separated strings
- Assume a contact has only one type
- Query with `contact_type =` (use array containment instead)

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§3.1](TRAPID_TEACHER.md#31-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 3](TRAPID_LEXICON.md)

---

---

## RULE #3.2: Bidirectional Relationships Require Reverse Sync

âœ… MUST

âœ… **MUST:**
- Create reverse relationship after creating forward relationship
- Update reverse relationship when forward is updated
- Delete reverse relationship when forward is deleted
- Use Thread-local flags to prevent infinite recursion: `Thread.current[:creating_reverse_relationship]`
- Validate unique relationship pairs: `[source_contact_id, related_contact_id]`
- Prevent self-relationships: `source_contact_id != related_contact_id`

âŒ **NEVER:**
- Create one-way relationships without reverse
- Allow circular reference loops during cascade updates
- Delete reverse relationship without checking Thread flag
- Allow duplicate relationships (same source + related pair)

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§3.2](TRAPID_TEACHER.md#32-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 3](TRAPID_LEXICON.md)

---

---

## RULE #3.3: Xero Sync Uses Priority-Based Fuzzy Matching

âœ… MUST

âœ… **MUST:**
- **Priority 1:** Match by `xero_id` (exact match)
- **Priority 2:** Match by `tax_number` (normalized ABN/ACN, 11 digits)
- **Priority 3:** Match by `email` (case-insensitive exact match)
- **Priority 4:** Fuzzy match by `full_name` using FuzzyMatch gem (>85% similarity threshold)
- Rate limit: 1.2 second delay between Xero API calls (60 req/min limit)
- Log all sync activities with metadata to `ContactActivity`
- Set `last_synced_at` timestamp on successful sync
- Clear `xero_sync_error` on success, set on failure
- Respect `sync_with_xero` flag (skip if false)

âŒ **NEVER:**
- Match only by name (too unreliable without fuzzy matching)
- Sync without rate limiting (will hit Xero API limits)
- Override manual `xero_id` links without confirmation
- Sync contacts with `sync_with_xero = false`
- Delete local contacts that don't exist in Xero

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§3.3](TRAPID_TEACHER.md#33-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 3](TRAPID_LEXICON.md)

---

---

## RULE #3.4: Contact Deletion MUST Check Purchase Order Dependencies

âœ… MUST

âœ… **MUST:**
- Check for linked suppliers via `contact.suppliers` association
- Check if suppliers have purchase orders: `suppliers.joins(:purchase_orders).distinct`
- Block deletion if ANY purchase orders exist
- Block deletion if ANY purchase orders have been paid or invoiced
- Return detailed error message listing suppliers and PO counts
- Allow deletion of contacts without supplier dependencies

âŒ **NEVER:**
- Delete contacts with active supplier relationships that have POs
- Cascade delete purchase orders when deleting contact
- Allow deletion without checking payment/invoice status
- Delete last contact from a construction/job

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§3.4](TRAPID_TEACHER.md#34-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 3](TRAPID_LEXICON.md)

---

---

## RULE #3.5: Contact Merge MUST Consolidate All Related Records

âœ… MUST

âœ… **MUST:**
- Merge `contact_types` arrays (union, no duplicates)
- Fill missing info from source to target (email, phone, address, etc.)
- Keep best `rating` if both are suppliers (higher wins)
- Combine `notes` with merge trail: `"[Merged from Contact #123] original notes"`
- Update foreign keys for: `PricebookItem`, `PurchaseOrder`, `PriceHistory`
- Delete source contacts after successful merge
- Log activity with "contact_merged" type and metadata
- Return updated target contact

âŒ **NEVER:**
- Overwrite target data with blank source data
- Merge without updating related records
- Delete source without logging activity
- Allow merge if validation fails on target

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§3.5](TRAPID_TEACHER.md#35-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 3](TRAPID_LEXICON.md)

---

---

## RULE #3.6: Portal Users MUST Have Secure Password Requirements

âœ… MUST

âœ… **MUST:**
- Minimum 12 characters
- At least one uppercase, lowercase, digit, and special character
- Lock account after 5 failed login attempts
- Lockout duration: 30 minutes
- Reset failed attempts counter on successful login
- Use `has_secure_password` with bcrypt
- Validate email uniqueness and `contact_id` uniqueness scoped to `portal_type`

âŒ **NEVER:**
- Allow weak passwords (<12 chars or missing character types)
- Store passwords in plain text
- Allow unlimited login attempts
- Share portal accounts across contacts

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§3.6](TRAPID_TEACHER.md#36-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 3](TRAPID_LEXICON.md)

---

---

## RULE #3.7: Primary Contact/Address/Person MUST Be Unique Per Contact

âœ… MUST

âœ… **MUST:**
- Validate `is_primary` uniqueness scoped to `contact_id` in before_save callback
- Automatically unmark other primaries when setting new primary
- Use database index on `[contact_id, is_primary]` for performance
- Ensure at least one contact remains on construction (cannot delete last)

âŒ **NEVER:**
- Allow multiple primary persons/addresses per contact
- Delete the only remaining contact from a construction
- Set `is_primary = true` without unmarking others

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§3.7](TRAPID_TEACHER.md#37-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 3](TRAPID_LEXICON.md)

---

---

## RULE #3.8: Contact Activity Logging MUST Track All Significant Changes

âœ… MUST

âœ… **MUST:**
- Log activity types: `created`, `updated`, `synced_from_xero`, `synced_to_xero`, `purchase_order_created`, `supplier_linked`, `contact_merged`
- Include `occurred_at` timestamp (required)
- Store structured metadata in JSONB column
- Use `ContactActivity.log_xero_sync` class method for Xero sync activities
- Combine with SMS messages in activity timeline endpoint

âŒ **NEVER:**
- Skip logging for "minor" updates (all changes matter)
- Log without `occurred_at` timestamp
- Store sensitive data in metadata (passwords, tokens, etc.)
- Delete activity records (archive only for compliance)

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§3.8](TRAPID_TEACHER.md#38-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 3](TRAPID_LEXICON.md)

---

---

# Chapter 4: Price Books

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”§ TEACHER (HOW):     TRAPID_TEACHER.md Ch4    â”‚
â”‚ ğŸ“• LEXICON (BUGS):    TRAPID_LEXICON.md Ch4    â”‚
â”‚ ğŸ“˜ USER MANUAL (USE): TRAPID_USER_MANUAL.md Ch4 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

**Last Updated:** 2025-11-17 10:57 AEST

## RULE #4.1: Price Changes MUST Create Price History Automatically

âœ… MUST

âœ… **MUST:**
- Use `after_update` callback to detect price changes
- Create PriceHistory with `old_price`, `new_price`, `change_reason`
- Set `price_last_updated_at` to current timestamp
- Track `changed_by_user_id` for audit trail
- Allow skipping via `skip_price_history_callback` flag when needed

âŒ **NEVER:**
- Update `current_price` without creating history
- Skip price history for "small" price changes
- Delete price history records (archive only)
- Allow price updates without tracking who made the change

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§4.1](TRAPID_TEACHER.md#41-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 4](TRAPID_LEXICON.md)

---

---

## RULE #4.2: Prevent Duplicate Price History - Unique Constraint + Time Window

âœ… MUST

âœ… **MUST:**
- Use unique index: `(pricebook_item_id, supplier_id, new_price, created_at)`
- Add custom validation preventing entries within 5 seconds
- Handle race conditions gracefully (return existing record)
- Log duplicate attempts for monitoring

âŒ **NEVER:**
- Rely only on application-level validation
- Allow duplicate price history from concurrent requests
- Fail hard on duplicate attempts (graceful degradation)

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§4.2](TRAPID_TEACHER.md#42-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 4](TRAPID_LEXICON.md)

---

---

## RULE #4.3: SmartPoLookupService - 6-Strategy Cascading Fallback

âœ… MUST

âœ… **MUST:**
- Execute strategies in priority order (most specific â†’ most general)
- Stop immediately on first match (don't continue searching)
- Track which strategy succeeded for analytics
- Collect warnings for all failed strategies

âŒ **NEVER:**
- Skip intermediate strategies
- Continue searching after finding a match
- Return multiple matches (return best only)
- Fail if early strategies miss (cascade to less specific)

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§4.3](TRAPID_TEACHER.md#43-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 4](TRAPID_LEXICON.md)

---

---

## RULE #4.4: Supplier Matching - Normalized Name Comparison with Business Suffix Removal

âœ… MUST

âœ… **MUST:**
- Remove business entity types: "Pty Ltd", "Limited", "Inc", "Corporation", "Co"
- Remove location identifiers: "Australia", "Australian", "Qld", "Queensland"
- Remove organizational terms: "Group", "Services", "& Associates"
- Lowercase and remove special characters
- Use Levenshtein distance for similarity scoring

âŒ **NEVER:**
- Match on raw supplier names without normalization
- Include business suffixes in similarity calculation
- Skip normalization for "exact" match detection
- Use case-sensitive comparison

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§4.4](TRAPID_TEACHER.md#44-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 4](TRAPID_LEXICON.md)

---

---

## RULE #4.5: Price Volatility Detection - Coefficient of Variation on 6-Month Window

âœ… MUST

âœ… **MUST:**
- Use rolling 6-month window of prices
- Calculate CV = (Standard Deviation / Mean) Ã— 100
- Classify: stable (<5%), moderate (5-15%), volatile (>15%)
- Require minimum 3 data points for valid calculation
- Return 'unknown' for insufficient data

âŒ **NEVER:**
- Use fixed time windows (calendar months/quarters)
- Calculate volatility on fewer than 3 price points
- Include prices older than 6 months
- Use absolute price change instead of percentage

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§4.5](TRAPID_TEACHER.md#45-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 4](TRAPID_LEXICON.md)

---

---

## RULE #4.6: Risk Scoring - Multi-Factor Weighted Calculation (0-100 Scale)

âœ… MUST

âœ… **MUST:**
- Calculate all 4 components independently
- Apply fixed weights (freshness=40%, reliability=20%, volatility=20%, missing=20%)
- Return score 0-100 with level: low/medium/high/critical
- Use database-level scoping for efficient filtering
- Cache calculation results for 1 hour

âŒ **NEVER:**
- Change weights without updating all documentation
- Skip any of the 4 components
- Return risk score without risk level
- Calculate risk client-side (compute server-side)

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§4.6](TRAPID_TEACHER.md#46-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 4](TRAPID_LEXICON.md)

---

---

## RULE #4.7: Bulk Updates - Transaction Wrapper with Price History Batch Creation

âœ… MUST

âœ… **MUST:**
- Wrap all updates in `ActiveRecord::Base.transaction`
- Batch create price histories in single insert
- Rollback entirely on any validation error
- Return detailed success/failure report per item
- Use `skip_price_history_callback` to prevent duplicate history

âŒ **NEVER:**
- Update items one-by-one without transaction
- Create price history one record at a time (N+1 performance issue)
- Continue processing after first error
- Commit partial updates

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§4.7](TRAPID_TEACHER.md#47-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 4](TRAPID_LEXICON.md)

---

---

## RULE #4.8: OneDrive Image Proxy - Cache Control with 1-Hour Expiry

âœ… MUST

âœ… **MUST:**
- Set `Cache-Control: public, max-age=3600` (1 hour)
- Store OneDrive `file_id` permanently (not URL)
- Refresh URL on each request via Microsoft Graph API
- Handle expired credentials gracefully (503 Service Unavailable)
- Return appropriate Content-Type from OneDrive metadata

âŒ **NEVER:**
- Store OneDrive direct URLs (expire after 1 hour)
- Cache beyond 1 hour (OneDrive credential lifespan)
- Proxy without Cache-Control header
- Return errors for missing images (return 404 gracefully)

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§4.8](TRAPID_TEACHER.md#48-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 4](TRAPID_LEXICON.md)

---

---

# Chapter 5: Jobs

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”§ TEACHER (HOW):     TRAPID_TEACHER.md Ch5    â”‚
â”‚ ğŸ“• LEXICON (BUGS):    TRAPID_LEXICON.md Ch5    â”‚
â”‚ ğŸ“˜ USER MANUAL (USE): TRAPID_USER_MANUAL.md Ch5 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

**Last Updated:** 2025-11-17 10:57 AEST

## RULE #5.1: Construction MUST Have At Least One Contact

âœ… MUST

âœ… **MUST:**
- Validate `must_have_at_least_one_contact` on update
- Allow creation without contacts (initial save)
- Require at least one contact before job can be used
- Show validation error if all contacts removed

âŒ **NEVER:**
- Allow Construction to exist without contacts after initial creation
- Skip contact validation on updates
- Delete all contacts without replacement

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§5.1](TRAPID_TEACHER.md#51-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 5](TRAPID_LEXICON.md)

---

---

## RULE #5.2: Live Profit Calculation - Dynamic Not Cached

âœ… MUST

âœ… **MUST:**
- Calculate `live_profit = contract_value - sum(all_purchase_orders.total)`
- Recalculate `profit_percentage = (live_profit / contract_value) * 100`
- Use `calculate_live_profit` and `calculate_profit_percentage` methods
- Return calculated values in API responses

âŒ **NEVER:**
- Store live_profit or profit_percentage in database
- Cache profit values (they change with every PO update)
- Use stale profit calculations

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§5.2](TRAPID_TEACHER.md#52-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 5](TRAPID_LEXICON.md)

---

---

## RULE #5.3: Task Dependencies - No Circular References

âœ… MUST

âœ… **MUST:**
- Validate `no_circular_dependencies` before saving TaskDependency
- Use graph traversal (BFS) to detect cycles
- Check entire predecessor chain for successor_task
- Reject dependency if circular reference detected

âŒ **NEVER:**
- Allow Task A â†’ B â†’ C â†’ A chains
- Skip circular dependency validation
- Allow self-dependencies (task depending on itself)

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§5.3](TRAPID_TEACHER.md#53-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 5](TRAPID_LEXICON.md)

---

---

## RULE #5.4: Task Status Transitions - Automatic Date Setting

âœ… MUST

âœ… **MUST:**
- Set `actual_start_date = Date.current` when status â†’ `in_progress` (if nil)
- Set `actual_end_date = Date.current` when status â†’ `complete`
- Set `progress_percentage = 100` when status â†’ `complete`
- Use `before_save :update_actual_dates` callback

âŒ **NEVER:**
- Allow `complete` status without actual_end_date
- Allow `in_progress` without actual_start_date
- Manually set these dates in controller

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§5.4](TRAPID_TEACHER.md#54-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 5](TRAPID_LEXICON.md)

---

---

## RULE #5.5: Task Spawning - Status-Based Child Task Creation

âœ… MUST

âœ… **MUST:**
- Spawn **subtasks** when parent status â†’ `in_progress`
- Spawn **photo task** when parent status â†’ `complete`
- Spawn **certificate task** when parent status â†’ `complete` (with cert_lag_days)
- Use `Schedule::TaskSpawner` service
- Set `spawned_type` field to identify task type
- Link via `parent_task_id`

âŒ **NEVER:**
- Create photo/cert tasks manually
- Spawn tasks without checking schedule_template_row configuration
- Skip TaskSpawner service

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§5.5](TRAPID_TEACHER.md#55-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 5](TRAPID_LEXICON.md)

---

---

## RULE #5.6: Schedule Cascade - Dependency-Based Date Propagation

âœ… MUST

âœ… **MUST:**
- Use `ScheduleCascadeService` to recalculate dependent task dates
- Respect dependency types (FS/SS/FF/SF)
- Apply lag_days to calculations
- Skip manually_positioned tasks (user-set dates)
- Recursively cascade to downstream tasks
- Use company timezone and working days

âŒ **NEVER:**
- Skip cascade when task dates change
- Ignore dependency types
- Override manually_positioned tasks
- Cascade to different projects

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§5.6](TRAPID_TEACHER.md#56-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 5](TRAPID_LEXICON.md)

---

---

## RULE #5.7: OneDrive Folder Creation - Async with Status Tracking

âœ… MUST

âœ… **MUST:**
- Use `CreateJobFoldersJob` background job
- Track status: `not_requested` â†’ `pending` â†’ `processing` â†’ `completed` / `failed`
- Use `onedrive_folder_creation_status` enum field
- Set `onedrive_folders_created_at` timestamp on completion
- Make idempotent (check if folders already exist)
- Use exponential backoff for retries

âŒ **NEVER:**
- Create folders synchronously in controller
- Skip status tracking
- Create duplicate folders
- Fail silently without updating status

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§5.7](TRAPID_TEACHER.md#57-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 5](TRAPID_LEXICON.md)

---

---

## RULE #5.8: Schedule Template Instantiation - All-or-Nothing Transaction

âœ… MUST

âœ… **MUST:**
- Use `ActiveRecord::Base.transaction` for all template instantiation
- Rollback entire operation if any task fails to create
- Rollback if dependency creation fails
- Rollback if date calculation fails
- Return `{ success: true/false, errors: [] }` response

âŒ **NEVER:**
- Create partial schedules (some tasks without others)
- Leave orphaned tasks if dependencies fail
- Continue after validation errors

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§5.8](TRAPID_TEACHER.md#58-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 5](TRAPID_LEXICON.md)

---

---

# Chapter 6: Estimates

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”§ TEACHER (HOW):     TRAPID_TEACHER.md Ch6    â”‚
â”‚ ğŸ“• LEXICON (BUGS):    TRAPID_LEXICON.md Ch6    â”‚
â”‚ ğŸ“˜ USER MANUAL (USE): TRAPID_USER_MANUAL.md Ch6 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

**Last Updated:** 2025-11-17 10:57 AEST

## RULE #6.1: Fuzzy Job Matching - Three-Tier Confidence Thresholds

âœ… MUST

âœ… **MUST:**
- Use Levenshtein distance + word matching + substring bonuses
- Auto-match at **â‰¥70% confidence** (high certainty)
- Suggest candidates at **50-70% confidence** (ambiguous)
- Return no match at **<50% confidence** (low similarity)
- Set `matched_automatically: true` for auto-matches
- Store `match_confidence_score` for all matches

âŒ **NEVER:**
- Auto-match below 70% confidence
- Skip confidence scoring
- Match without normalizing strings (lowercase, trim, remove special chars)
- Allow duplicate auto-matches

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§6.1](TRAPID_TEACHER.md#61-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 6](TRAPID_LEXICON.md)

---

---

## RULE #6.2: External API Key Security - SHA256 Hashing Only

âœ… MUST

âœ… **MUST:**
- Hash API keys with SHA256 before storage
- Validate incoming keys by hashing and comparing digests
- Store keys in `external_integrations` table
- Track usage with `last_used_at` timestamp
- Support key deactivation without deletion

âŒ **NEVER:**
- Store plaintext API keys in database
- Log API keys in server logs
- Return API keys in API responses
- Use reversible encryption (one-way hash only)

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§6.2](TRAPID_TEACHER.md#62-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 6](TRAPID_LEXICON.md)

---

---

## RULE #6.3: Estimate Import - Validate Before Auto-Matching

âœ… MUST

âœ… **MUST:**
- Validate `job_name` is present and non-empty
- Validate `materials` array has at least 1 item
- Validate each material has: `category`, `item`, `quantity`
- Return 422 Unprocessable Entity for invalid data
- Log validation errors with request details

âŒ **NEVER:**
- Attempt to match with missing job_name
- Create estimate with zero line items
- Skip validation on external API endpoint
- Create estimate with nil or zero quantities

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§6.3](TRAPID_TEACHER.md#63-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 6](TRAPID_LEXICON.md)

---

---

## RULE #6.4: PO Generation from Estimate - Transaction Safety

âœ… MUST

âœ… **MUST:**
- Wrap entire conversion in `ActiveRecord::Base.transaction`
- Rollback if any PO creation fails
- Rollback if any line item creation fails
- Rollback if supplier lookup fails critically
- Mark estimate as `imported` only on successful commit

âŒ **NEVER:**
- Create partial POs (some categories succeed, others fail)
- Leave estimate in `matched` status if POs were created
- Continue after critical errors
- Create POs without line items

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§6.4](TRAPID_TEACHER.md#64-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 6](TRAPID_LEXICON.md)

---

---

## RULE #6.5: AI Plan Review - Async Processing Required

âœ… MUST

âœ… **MUST:**
- Enqueue `AiReviewJob` for all plan reviews
- Create `EstimateReview` record with `status: 'pending'` immediately
- Return review_id to client for polling
- Update status to `processing` â†’ `completed` / `failed`
- Set timeout of 5 minutes for Claude API call

âŒ **NEVER:**
- Run plan review in synchronous HTTP request
- Block API response waiting for Claude
- Skip background job for "small" reviews
- Leave review in `processing` status indefinitely

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§6.5](TRAPID_TEACHER.md#65-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 6](TRAPID_LEXICON.md)

---

---

## RULE #6.6: Line Item Categorization - Normalized Category Matching

âœ… MUST

âœ… **MUST:**
- Normalize categories to lowercase before grouping
- Map common variations: "plumbing" = "plumber" = "plumb"
- Use category normalization service
- Handle nil/blank categories with "Uncategorized" group
- Store original category in line item, use normalized for matching

âŒ **NEVER:**
- Group POs by case-sensitive categories ("Plumbing" â‰  "plumbing")
- Skip category normalization in SmartPoLookupService
- Create separate POs for "Electrical" and "electrical"
- Fail import if category is missing

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§6.6](TRAPID_TEACHER.md#66-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 6](TRAPID_LEXICON.md)

---

---

## RULE #6.7: Estimate Status State Machine - Strict Transitions

âœ… MUST

âœ… **MUST:**
- Start at `pending` status on creation
- Transition to `matched` when linked to construction
- Transition to `imported` when POs generated
- Allow `rejected` from any state
- Prevent reverse transitions (no imported â†’ matched)

âŒ **NEVER:**
- Skip `matched` status and go directly to `imported`
- Mark as `imported` before POs are created
- Change status back from `imported` to `pending`
- Allow PO generation from `pending` status

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§6.7](TRAPID_TEACHER.md#67-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 6](TRAPID_LEXICON.md)

---

---

# Chapter 7: AI Plan Review

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”§ TEACHER (HOW):     TRAPID_TEACHER.md Ch7    â”‚
â”‚ ğŸ“• LEXICON (BUGS):    TRAPID_LEXICON.md Ch7    â”‚
â”‚ ğŸ“˜ USER MANUAL (USE): TRAPID_USER_MANUAL.md Ch7 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

**Last Updated:** 2025-11-17 10:57 AEST

## RULE #7.1: Estimate Must Be Matched to Construction

âœ… MUST

âœ… **MUST:**
- Validate `estimate.construction_id` is present before starting review
- Return 422 status with clear error message if not matched
- Show "Match to Job" button in UI if unmatched

âŒ **NEVER:**
- Allow AI review on unmatched estimates
- Start review without construction context

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§7.1](TRAPID_TEACHER.md#71-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 7](TRAPID_LEXICON.md)

---

---

## RULE #7.2: OneDrive Plan Folder Structure

âœ… MUST

âœ… **MUST search folders:**

âŒ **NEVER:**
- Search entire OneDrive (security risk)
- Use different folder names without updating constant
- Skip folder validation

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§7.2](TRAPID_TEACHER.md#72-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 7](TRAPID_LEXICON.md)

---

---

## RULE #7.3: PDF File Size Limit

âœ… MUST

âœ… **MUST:**
- Check file size before download
- Skip files > 20MB
- Return error if NO valid PDFs found after filtering

âŒ **NEVER:**
- Attempt to send files > 20MB to Claude API
- Download large files unnecessarily
- Proceed without plan documents

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§7.3](TRAPID_TEACHER.md#73-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 7](TRAPID_LEXICON.md)

---

---

## RULE #7.4: Async Processing with Background Jobs

âœ… MUST

âœ… **MUST:**
- Return 202 Accepted immediately with review_id
- Enqueue AiReviewJob with estimate_id
- Set initial status to 'pending', update to 'processing' in job
- Frontend MUST poll for status (every 5 seconds recommended)

âŒ **NEVER:**
- Process review synchronously (causes request timeout)
- Block HTTP request waiting for Claude API response
- Assume review completes instantly

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§7.4](TRAPID_TEACHER.md#74-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 7](TRAPID_LEXICON.md)

---

---

## RULE #7.5: Claude API Model and Prompt Structure

âœ… MUST

âœ… **MUST:**
- Use exact model ID: `claude-3-5-sonnet-20241022`
- Send PDFs as base64-encoded documents with MIME type `application/pdf`
- Request JSON response format with specific schema
- Include estimate line items in prompt for comparison context
- Set max_tokens to 4096 minimum

âŒ **NEVER:**
- Use older Claude models (lack PDF support)
- Send PDFs as text (loses formatting)
- Omit response format instructions
- Exceed token limits with oversized prompts

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§7.5](TRAPID_TEACHER.md#75-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 7](TRAPID_LEXICON.md)

---

---

## RULE #7.6: Discrepancy Detection Logic

âœ… MUST

âœ… **MUST categorize as:**

âœ… **MUST use fuzzy matching:**
- Remove non-alphanumeric characters from item descriptions
- Case-insensitive comparison
- Match by category + description

âŒ **NEVER:**
- Require exact string match (causes false negatives)
- Ignore category in matching (causes false positives)
- Use < 10% threshold for mismatches (too strict)

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§7.6](TRAPID_TEACHER.md#76-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 7](TRAPID_LEXICON.md)

---

---

## RULE #7.7: Confidence Score Calculation

âœ… MUST

âœ… **MUST calculate:**

âœ… **MUST store:**
- `confidence_score` - Final score (0-100)
- `items_matched` - Count of matched items
- `items_mismatched` - Count of quantity mismatches
- `items_missing` - Count of missing items
- `items_extra` - Count of extra items

âŒ **NEVER:**
- Return confidence > 100 or < 0
- Use equal penalty weights for all discrepancy types
- Skip confidence calculation

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§7.7](TRAPID_TEACHER.md#77-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 7](TRAPID_LEXICON.md)

---

---

## RULE #7.8: Error Handling and Status Updates

âœ… MUST

âœ… **MUST handle errors:**
- `NoConstructionError` - Estimate not matched
- `OneDriveNotConnectedError` - OneDrive credential missing
- `PDFNotFoundError` - No valid PDFs in plan folders
- `FileTooLargeError` - All PDFs exceed 20MB limit
- `Anthropic::Error` - Claude API errors (rate limit, auth, etc.)
- `StandardError` - Generic catch-all

âœ… **MUST update review record:**

âŒ **NEVER:**
- Leave review in 'processing' state on error (orphaned record)
- Expose sensitive error details to client
- Retry automatically without user intervention

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§7.8](TRAPID_TEACHER.md#78-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 7](TRAPID_LEXICON.md)

---

---

## RULE #7.9: Prevent Duplicate Processing Reviews

âœ… MUST

âœ… **MUST check:**
- Query for existing review with `status: processing`
- Return 422 error if found
- Allow new review only if previous is completed/failed

âŒ **NEVER:**
- Allow concurrent reviews on same estimate
- Overwrite existing processing review

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§7.9](TRAPID_TEACHER.md#79-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 7](TRAPID_LEXICON.md)

---

---

# Chapter 8: Purchase Orders

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”§ TEACHER (HOW):     TRAPID_TEACHER.md Ch8    â”‚
â”‚ ğŸ“• LEXICON (BUGS):    TRAPID_LEXICON.md Ch8    â”‚
â”‚ ğŸ“˜ USER MANUAL (USE): TRAPID_USER_MANUAL.md Ch8 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

**Last Updated:** 2025-11-17 10:57 AEST

## RULE #8.1: PO Number Generation - Race Condition Protection

âŒ NEVER

âŒ **NEVER generate PO numbers without lock**

âœ… **ALWAYS use `pg_advisory_xact_lock` in transaction**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§8.1](TRAPID_TEACHER.md#81-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 8](TRAPID_LEXICON.md)

---

---

## RULE #8.2: Status State Machine

âŒ NEVER

âŒ **NEVER skip status steps**

âœ… **ALWAYS validate transitions**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§8.2](TRAPID_TEACHER.md#82-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 8](TRAPID_LEXICON.md)

---

---

## RULE #8.3: Payment Status Calculation

âŒ NEVER

âŒ **NEVER set `payment_status` directly**

âœ… **ALWAYS use `determine_payment_status(amount)`**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§8.3](TRAPID_TEACHER.md#83-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 8](TRAPID_LEXICON.md)

---

---

## RULE #8.4: Smart Lookup - Supplier Selection Priority

âŒ NEVER

âŒ **NEVER randomly select supplier**

âœ… **ALWAYS use SmartPoLookupService priority cascade**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§8.4](TRAPID_TEACHER.md#84-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 8](TRAPID_LEXICON.md)

---

---

## RULE #8.5: Line Items - Totals Calculation

âŒ NEVER

âŒ **NEVER save PO without recalculating totals**

âœ… **ALWAYS use `before_save` callback**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§8.5](TRAPID_TEACHER.md#85-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 8](TRAPID_LEXICON.md)

---

---

## RULE #8.6: Schedule Task Linking

âŒ NEVER

âŒ **NEVER link without unlinking previous**

âœ… **ALWAYS use transaction for task linking**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§8.6](TRAPID_TEACHER.md#86-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 8](TRAPID_LEXICON.md)

---

---

## RULE #8.7: Price Drift Monitoring

âŒ NEVER

âŒ **NEVER ignore price drift**

âœ… **ALWAYS calculate drift percentage**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§8.7](TRAPID_TEACHER.md#87-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 8](TRAPID_LEXICON.md)

---

---

# Chapter 9: Gantt

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”§ TEACHER (HOW):     TRAPID_TEACHER.md Ch9    â”‚
â”‚ ğŸ“• LEXICON (BUGS):    TRAPID_LEXICON.md Ch9    â”‚
â”‚ ğŸ“˜ USER MANUAL (USE): TRAPID_USER_MANUAL.md Ch9 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

**Last Updated:** 2025-11-17 10:57 AEST

## RULE #9.1: Predecessor ID Conversion

âŒ NEVER

âŒ **NEVER use sequence_order directly in predecessor lookups**

âœ… **ALWAYS convert:** `predecessor_id = sequence_order + 1`

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§9.1](TRAPID_TEACHER.md#91-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 9](TRAPID_LEXICON.md)

---

---

## RULE #9.2: isLoadingData Lock Timing

âŒ NEVER

âŒ **NEVER reset isLoadingData in drag handler**

âœ… **ALWAYS reset in useEffect with 1000ms timeout**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§9.2](TRAPID_TEACHER.md#92-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 9](TRAPID_LEXICON.md)

---

---

## RULE #9.3: Company Settings - Working Days & Timezone

âŒ NEVER

âŒ **NEVER hardcode working days or ignore company timezone**

âœ… **ALWAYS read from:** `company_settings.working_days` and `company_settings.timezone`

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§9.3](TRAPID_TEACHER.md#93-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 9](TRAPID_LEXICON.md)

---

---

## RULE #9.4: Lock Hierarchy

âŒ NEVER

âŒ **NEVER cascade to locked tasks**

âœ… **ALWAYS check all 5 locks before cascade**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§9.4](TRAPID_TEACHER.md#94-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 9](TRAPID_LEXICON.md)

---

---

## RULE #9.5: Task Heights Configuration

âœ… MUST

âœ… **MUST set all three to same value:**

âŒ **NEVER have mismatched height values**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§9.5](TRAPID_TEACHER.md#95-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 9](TRAPID_LEXICON.md)

---

---

## RULE #9.6: Auto-Scheduling

âŒ NEVER

âŒ **NEVER enable:** `gantt.config.auto_scheduling = true`

âœ… **ALWAYS set:** `gantt.config.auto_scheduling = false`

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§9.6](TRAPID_TEACHER.md#96-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 9](TRAPID_LEXICON.md)

---

---

## RULE #9.7: API Pattern - Single Update + Cascade Response

âŒ NEVER

âŒ **NEVER make multiple API calls for cascade updates**

âœ… **ALWAYS use:** Single update + cascade response pattern

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§9.7](TRAPID_TEACHER.md#97-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 9](TRAPID_LEXICON.md)

---

---

## RULE #9.8: useRef Anti-Loop Flags

âœ… MUST

âœ… **MUST use all 7 useRef flags correctly:**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§9.8](TRAPID_TEACHER.md#98-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 9](TRAPID_LEXICON.md)

---

---

## RULE #9.9: Predecessor Format

âŒ NEVER

âŒ **NEVER save without predecessor_ids**

âœ… **ALWAYS include predecessor_ids in every update**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§9.9](TRAPID_TEACHER.md#99-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 9](TRAPID_LEXICON.md)

---

---

## RULE #9.10: Cascade Triggers

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§9.10](TRAPID_TEACHER.md#910-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 9](TRAPID_LEXICON.md)

---

---

## RULE #9.11: Debounced Render Pattern

âŒ NEVER

âŒ **NEVER call gantt.render() directly**

âœ… **ALWAYS use debounced render:**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§9.11](TRAPID_TEACHER.md#911-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 9](TRAPID_LEXICON.md)

---

---

## RULE #9.12: Column Documentation - CC_UPDATE Table

âŒ NEVER

âŒ **NEVER change Schedule Master columns without updating CC_UPDATE table**

âœ… **ALWAYS update NewFeaturesTab.jsx when column implementation changes**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§9.12](TRAPID_TEACHER.md#912-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 9](TRAPID_LEXICON.md)

---

---

# Chapter 10: Tasks

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”§ TEACHER (HOW):     TRAPID_TEACHER.md Ch10    â”‚
â”‚ ğŸ“• LEXICON (BUGS):    TRAPID_LEXICON.md Ch10    â”‚
â”‚ ğŸ“˜ USER MANUAL (USE): TRAPID_USER_MANUAL.md Ch10 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

**Last Updated:** 2025-11-17 10:57 AEST

## RULE #10.1: Task Status Lifecycle & Automatic Date Updates

âœ… MUST

âœ… **MUST update dates automatically:**

âŒ **NEVER:**
- Allow status to skip lifecycle stages (not_started â†’ complete without in_progress)
- Overwrite existing actual dates when status changes again
- Leave progress_percentage < 100 when status is complete

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§10.1](TRAPID_TEACHER.md#101-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 10](TRAPID_LEXICON.md)

---

---

## RULE #10.2: Task Dependencies & Circular Dependency Prevention

âœ… MUST

âœ… **MUST validate:**

âŒ **NEVER:**
- Allow task to depend on itself (self-dependency)
- Allow circular chains (A depends on B, B depends on C, C depends on A)
- Allow cross-project dependencies
- Allow duplicate dependencies (same predecessor + successor pair)

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§10.2](TRAPID_TEACHER.md#102-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 10](TRAPID_LEXICON.md)

---

---

## RULE #10.3: Automatic Task Spawning from Templates

âœ… MUST

âœ… **MUST implement via TaskSpawner service:**

âœ… **MUST trigger spawning on status changes:**

âŒ **NEVER:**
- Spawn tasks multiple times (check if already spawned)
- Spawn tasks without checking template configuration
- Create circular parent-child relationships
- Skip sequence ordering for subtasks (causes display chaos)

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§10.3](TRAPID_TEACHER.md#103-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 10](TRAPID_LEXICON.md)

---

---

## RULE #10.4: Supervisor Checklist Template-to-Instance Flow

âœ… MUST

âœ… **MUST copy templates to instances during job instantiation:**

âŒ **NEVER:**
- Share checklist items across tasks (each task gets own copies)
- Allow checklist item deletion after task starts
- Skip category validation (required for filtering)
- Store User FK for completed_by (store username string for flexibility)

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§10.4](TRAPID_TEACHER.md#104-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 10](TRAPID_LEXICON.md)

---

---

## RULE #10.5: Response Type Validation & Photo Upload

âœ… MUST

âœ… **MUST validate before marking complete:**

âœ… **MUST use Cloudinary for photo storage:**

âŒ **NEVER:**
- Allow completion without required response data
- Store photos in Rails backend (use Cloudinary)
- Skip folder organization in Cloudinary (use job-specific folders)
- Allow checklist item updates after completion (completed_at is immutable)

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§10.5](TRAPID_TEACHER.md#105-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 10](TRAPID_LEXICON.md)

---

---

## RULE #10.6: Auto-Complete Predecessors Feature

âœ… MUST

âœ… **MUST implement via callback:**

âœ… **MUST show checkbox in task form:**

âŒ **NEVER:**
- Auto-complete tasks with incomplete subtasks (check has_subtasks)
- Skip audit trail (add completion_notes explaining auto-completion)
- Allow infinite recursion (predecessors don't trigger their own predecessors)
- Auto-complete milestones (they should be explicitly completed)

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§10.6](TRAPID_TEACHER.md#106-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 10](TRAPID_LEXICON.md)

---

---

## RULE #10.7: Materials Status Calculation

âœ… MUST

âœ… **MUST include in task serialization:**

âœ… **MUST show status badges:**

âŒ **NEVER:**
- Store materials_status in database (always calculate)
- Show materials status for tasks without critical_po flag
- Allow task to start if materials_status = 'delayed' (warn user)
- Skip materials check during schedule cascade calculations

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§10.7](TRAPID_TEACHER.md#107-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 10](TRAPID_LEXICON.md)

---

---

## RULE #10.8: Sequence Order for Task Display

âœ… MUST

âœ… **MUST set sequence on creation:**

âœ… **MUST index for efficient sorting:**

âŒ **NEVER:**
- Use random sequence numbers (breaks visual grouping)
- Allow gaps larger than 1.0 between top-level tasks
- Use sequence > 9.9 for subtasks (use 9 or fewer subtasks per parent)
- Resort entire project when adding one task (use smart insertion)

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§10.8](TRAPID_TEACHER.md#108-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 10](TRAPID_LEXICON.md)

---

---

## RULE #10.9: Task Update Audit Trail

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§10.9](TRAPID_TEACHER.md#109-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 10](TRAPID_LEXICON.md)

---

---

## RULE #10.10: Duration Days Validation

âœ… MUST

âœ… **MUST validate:**

âŒ **NEVER:**
- Allow duration_days = 0 (causes same-day start/end, confusing)
- Allow negative durations (logically impossible)
- Skip duration validation on updates
- Use decimal durations (always integer days)

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§10.10](TRAPID_TEACHER.md#1010-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 10](TRAPID_LEXICON.md)

---

---

## RULE #10.11: Tags System for Flexible Categorization

âœ… MUST

âœ… **MUST use GIN index for efficient queries:**

âœ… **MUST include tags in serialization:**

âŒ **NEVER:**
- Store tags as comma-separated string (use JSONB array)
- Allow duplicate tags in array
- Skip GIN index (queries will be slow)
- Use tags for data that should be proper associations (e.g., don't tag "assigned_to_john", use assigned_to FK)

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§10.11](TRAPID_TEACHER.md#1011-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 10](TRAPID_LEXICON.md)

---

---

# Chapter 11: Weather

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”§ TEACHER (HOW):     TRAPID_TEACHER.md Ch11    â”‚
â”‚ ğŸ“• LEXICON (BUGS):    TRAPID_LEXICON.md Ch11    â”‚
â”‚ ğŸ“˜ USER MANUAL (USE): TRAPID_USER_MANUAL.md Ch11 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

**Last Updated:** 2025-11-17 10:57 AEST

## RULE #11.1: Unique Holidays Per Region

âœ… MUST

âœ… **MUST:**
- Validate uniqueness: `validates :date, uniqueness: { scope: :region }`
- Use region codes: QLD, NSW, VIC, SA, WA, TAS, NT, NZ
- Store date in UTC (no time component)

âŒ **NEVER:**
- Allow duplicate holidays for same date + region
- Use inconsistent region codes
- Store holidays with time components

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§11.1](TRAPID_TEACHER.md#111-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 11](TRAPID_LEXICON.md)

---

---

## RULE #11.2: Rain Log - One Entry Per Construction Per Day

âœ… MUST

âœ… **MUST:**
- Enforce uniqueness at database level: `UNIQUE(construction_id, date)`
- Check for existing log before auto-creation
- Use `find_or_initialize_by` pattern for updates

âŒ **NEVER:**
- Create multiple rain logs for same job + date
- Override existing automatic logs without checking source
- Allow future-dated rain logs

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§11.2](TRAPID_TEACHER.md#112-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 11](TRAPID_LEXICON.md)

---

---

## RULE #11.3: Rainfall Severity Auto-Calculation

âœ… MUST

âœ… **MUST calculate severity as:**
- Light: `< 5mm`
- Moderate: `5mm to 15mm`
- Heavy: `> 15mm`

âœ… **MUST:**
- Auto-calculate on create if `rainfall_mm` present
- Recalculate on update if `rainfall_mm` changes
- Allow nil severity if `rainfall_mm` is nil or 0

âŒ **NEVER:**
- Allow manual severity override without rainfall_mm
- Use different thresholds without updating constants
- Skip calculation for automatic entries

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§11.3](TRAPID_TEACHER.md#113-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 11](TRAPID_LEXICON.md)

---

---

## RULE #11.4: Manual Rain Logs Require Notes

âœ… MUST

âœ… **MUST:**
- Validate presence: `validates :notes, presence: true, if: :source_manual?`
- Display notes in UI for audit trail
- Include who created the entry (`created_by_user_id`)

âŒ **NEVER:**
- Allow blank notes for manual entries
- Skip audit trail for manual modifications
- Allow automatic entries to have editable notes

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§11.4](TRAPID_TEACHER.md#114-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 11](TRAPID_LEXICON.md)

---

---

## RULE #11.5: Weather API - Historical Data Only

âœ… MUST

âœ… **MUST:**
- Validate date is not in future before API call
- Use `Date.yesterday` for automatic checks
- Raise `ArgumentError` if future date provided

âŒ **NEVER:**
- Call weather API for today or future dates
- Use weather forecasts (not historical data)
- Proceed with API call if date validation fails

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§11.5](TRAPID_TEACHER.md#115-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 11](TRAPID_LEXICON.md)

---

---

## RULE #11.6: Location Extraction Priority

âœ… MUST

âœ… **MUST follow priority:**

âŒ **NEVER:**
- Use random location extraction order
- Fail silently if location cannot be determined
- Use company address as fallback (wrong location)

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§11.6](TRAPID_TEACHER.md#116-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 11](TRAPID_LEXICON.md)

---

---

## RULE #11.7: Gantt Integration - Working Day Calculation

âœ… MUST

âœ… **MUST:**
- Load company `working_days` configuration
- Load `PublicHoliday` dates for relevant region (3-year range)
- Skip task to next working day if lands on weekend OR holiday
- Respect lock hierarchy (locked tasks can stay on holidays)

âŒ **NEVER:**
- Check only weekends without holidays
- Check only holidays without weekends
- Override locked task dates
- Use different holiday lookups across services

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§11.7](TRAPID_TEACHER.md#117-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 11](TRAPID_LEXICON.md)

---

---

## RULE #11.8: Weather API Response Storage

âœ… MUST

âœ… **MUST:**
- Store complete API JSON response
- Include location confirmation data
- Preserve all weather metrics (temp, condition, etc.)
- Use for future analysis and verification

âŒ **NEVER:**
- Store only rainfall value
- Discard API response after extraction
- Modify API response before storage

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§11.8](TRAPID_TEACHER.md#118-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 11](TRAPID_LEXICON.md)

---

---

# Chapter 12: OneDrive

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”§ TEACHER (HOW):     TRAPID_TEACHER.md Ch12    â”‚
â”‚ ğŸ“• LEXICON (BUGS):    TRAPID_LEXICON.md Ch12    â”‚
â”‚ ğŸ“˜ USER MANUAL (USE): TRAPID_USER_MANUAL.md Ch12 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

**Last Updated:** 2025-11-17 10:57 AEST

## RULE #12.1: Organization-Wide Authentication

âŒ NEVER

âŒ **NEVER require each user to authenticate separately**

âœ… **ALWAYS store single credential for entire organization**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§12.1](TRAPID_TEACHER.md#121-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 12](TRAPID_LEXICON.md)

---

---

## RULE #12.2: Folder Template System

âŒ NEVER

âŒ **NEVER hardcode folder names**

âœ… **ALWAYS respect template customizations**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§12.2](TRAPID_TEACHER.md#122-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 12](TRAPID_LEXICON.md)

---

---

## RULE #12.3: Root Folder Management

âŒ NEVER

âŒ **NEVER create folders at OneDrive root level**

âœ… **ALWAYS use `root_folder_id` from credential**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§12.3](TRAPID_TEACHER.md#123-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 12](TRAPID_LEXICON.md)

---

---

## RULE #12.4: Pricebook Image Sync

âŒ NEVER

âŒ **NEVER rely solely on OneDrive for image display**

âœ… **ALWAYS upload to Cloudinary after OneDrive upload**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§12.4](TRAPID_TEACHER.md#124-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 12](TRAPID_LEXICON.md)

---

---

## RULE #12.5: File Upload Chunking

âŒ NEVER

âŒ **NEVER use simple upload for files >4MB**

âœ… **ALWAYS use resumable upload session**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§12.5](TRAPID_TEACHER.md#125-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 12](TRAPID_LEXICON.md)

---

---

# Chapter 13: Outlook

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”§ TEACHER (HOW):     TRAPID_TEACHER.md Ch13    â”‚
â”‚ ğŸ“• LEXICON (BUGS):    TRAPID_LEXICON.md Ch13    â”‚
â”‚ ğŸ“˜ USER MANUAL (USE): TRAPID_USER_MANUAL.md Ch13 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

**Last Updated:** 2025-11-17 10:57 AEST

## RULE #13.1: Organization-Wide Singleton OAuth Credential

âœ… MUST

âœ… **MUST implement as singleton:**

âœ… **MUST auto-refresh tokens before expiration:**

âŒ **NEVER:**
- Store multiple Outlook credentials (one organization = one credential)
- Store tokens unencrypted
- Let tokens expire without auto-refresh
- Hardcode token expiration buffer (always use 5-minute safety margin)

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§13.1](TRAPID_TEACHER.md#131-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 13](TRAPID_LEXICON.md)

---

---

## RULE #13.2: Four-Strategy Email-to-Job Matching

âœ… MUST

âœ… **MUST implement all 4 strategies:**

âœ… **MUST auto-assign on email creation:**

âŒ **NEVER:**
- Skip matching strategies (must try all 4 in order)
- Match to inactive/archived jobs
- Auto-assign to wrong construction (false positive worse than nil)
- Allow email creation without attempting match

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§13.2](TRAPID_TEACHER.md#132-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 13](TRAPID_LEXICON.md)

---

---

## RULE #13.3: Microsoft Graph API Usage Pattern

âœ… MUST

âœ… **MUST use Graph API v1.0:**

âœ… **MUST request these scopes:**

âŒ **NEVER:**
- Use Outlook REST API v2.0 (deprecated, use Graph API)
- Request more scopes than needed (principle of least privilege)
- Skip $select parameter (bandwidth waste - emails can be large)
- Use synchronous API calls without pagination

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§13.3](TRAPID_TEACHER.md#133-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 13](TRAPID_LEXICON.md)

---

---

## RULE #13.4: Email Threading Support via Message-ID

âœ… MUST

âœ… **MUST include threading fields:**

âœ… **MUST populate threading fields:**

âŒ **NEVER:**
- Allow duplicate message_id (unique constraint required)
- Skip message_id extraction (breaks threading)
- Store references as array (use text with space-separated values per RFC 2822)

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§13.4](TRAPID_TEACHER.md#134-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 13](TRAPID_LEXICON.md)

---

---

## RULE #13.5: Webhook Support for Email Services

âœ… MUST

âœ… **MUST implement webhook receiver:**

âŒ **NEVER:**
- Return error status for webhook (email providers will retry, causing duplicates)
- Skip duplicate detection (check message_id uniqueness)
- Process webhook synchronously (use background job for heavy parsing)

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§13.5](TRAPID_TEACHER.md#135-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 13](TRAPID_LEXICON.md)

---

---

## RULE #13.6: Inbound-Only Architecture (Current Limitation)

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§13.6](TRAPID_TEACHER.md#136-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 13](TRAPID_LEXICON.md)

---

---

# Chapter 14: Chat

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”§ TEACHER (HOW):     TRAPID_TEACHER.md Ch14    â”‚
â”‚ ğŸ“• LEXICON (BUGS):    TRAPID_LEXICON.md Ch14    â”‚
â”‚ ğŸ“˜ USER MANUAL (USE): TRAPID_USER_MANUAL.md Ch14 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

**Last Updated:** 2025-11-17 10:57 AEST

## RULE #14.1: ChatMessage Multi-Channel Architecture

âœ… MUST

âœ… **MUST define channel types:**

âœ… **MUST route messages correctly:**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§14.1](TRAPID_TEACHER.md#141-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 14](TRAPID_LEXICON.md)

---

---

## RULE #14.2: Message-to-Job Linking

âœ… MUST

âœ… **MUST provide save-to-job endpoints:**

âœ… **MUST include construction_id foreign key:**

âœ… **MUST allow bulk conversation saving:**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§14.2](TRAPID_TEACHER.md#142-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 14](TRAPID_LEXICON.md)

---

---

## RULE #14.3: SMS Twilio Integration

âœ… MUST

âœ… **MUST centralize Twilio operations:**

âœ… **MUST handle incoming SMS webhooks:**

âœ… **MUST support Australian phone formats:**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§14.3](TRAPID_TEACHER.md#143-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 14](TRAPID_LEXICON.md)

---

---

## RULE #14.4: SMS Status Tracking

âœ… MUST

âœ… **MUST define status states:**

âœ… **MUST accept Twilio status webhooks:**

âœ… **MUST show status icons:**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§14.4](TRAPID_TEACHER.md#144-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 14](TRAPID_LEXICON.md)

---

---

## RULE #14.5: Unread Message Tracking

âœ… MUST

âœ… **MUST add read timestamp:**

âœ… **MUST provide unread count endpoint:**

âœ… **MUST poll for unread count:**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§14.5](TRAPID_TEACHER.md#145-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 14](TRAPID_LEXICON.md)

---

---

## RULE #14.6: Message Polling (No WebSockets)

âœ… MUST

âœ… **MUST poll at 3-second intervals:**

âœ… **MUST poll SMS messages:**

âŒ **NEVER use WebSockets:**
- WebSocket infrastructure not implemented
- ActionCable not configured
- All real-time updates via polling

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§14.6](TRAPID_TEACHER.md#146-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 14](TRAPID_LEXICON.md)

---

---

## RULE #14.7: Contact-SMS Fuzzy Matching

âœ… MUST

âœ… **MUST support partial phone matches:**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§14.7](TRAPID_TEACHER.md#147-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 14](TRAPID_LEXICON.md)

---

---

## RULE #14.8: Message Deletion Authorization

âœ… MUST

âœ… **MUST verify ownership:**

âŒ **NEVER allow:**
- Admins deleting other users' messages (not implemented)
- Bulk message deletion without ownership check
- Deletion of messages saved to jobs without audit trail

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§14.8](TRAPID_TEACHER.md#148-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 14](TRAPID_LEXICON.md)

---

---

## RULE #14.9: Email Ingestion Storage

âœ… MUST

âœ… **MUST store email metadata:**

âœ… **MUST include fields:**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§14.9](TRAPID_TEACHER.md#149-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 14](TRAPID_LEXICON.md)

---

---

## RULE #14.10: Authentication Placeholder - CRITICAL TODO

âœ… MUST

âœ… **MUST implement proper authentication:**

âŒ **NEVER use in production:**
- `User.first` placeholder
- Hardcoded user IDs
- Session-less chat without auth

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§14.10](TRAPID_TEACHER.md#1410-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 14](TRAPID_LEXICON.md)

---

---

# Chapter 15: Xero

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”§ TEACHER (HOW):     TRAPID_TEACHER.md Ch15    â”‚
â”‚ ğŸ“• LEXICON (BUGS):    TRAPID_LEXICON.md Ch15    â”‚
â”‚ ğŸ“˜ USER MANUAL (USE): TRAPID_USER_MANUAL.md Ch15 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

**Last Updated:** 2025-11-17 10:57 AEST

## RULE #15.1: OAuth Token Management

âŒ NEVER

âŒ **NEVER store API keys in plaintext**

âœ… **ALWAYS encrypt tokens using ActiveRecord Encryption**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§15.1](TRAPID_TEACHER.md#151-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 15](TRAPID_LEXICON.md)

---

---

## RULE #15.2: Two-Way Contact Sync

âŒ NEVER

âŒ **NEVER assume single-direction sync**

âœ… **ALWAYS check `sync_with_xero` flag before syncing**

âœ… **ALWAYS update `last_synced_at` timestamp**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§15.2](TRAPID_TEACHER.md#152-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 15](TRAPID_LEXICON.md)

---

---

## RULE #15.3: Invoice Matching

âŒ NEVER

âŒ **NEVER sync payments without invoice match**

âœ… **ALWAYS validate invoice total vs PO total**

âœ… **ALWAYS store `xero_invoice_id` on PurchaseOrder**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§15.3](TRAPID_TEACHER.md#153-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 15](TRAPID_LEXICON.md)

---

---

## RULE #15.4: Webhook Signature Verification

âŒ NEVER

âŒ **NEVER process webhooks without signature verification**

âœ… **ALWAYS use `XERO_WEBHOOK_KEY` from environment**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§15.4](TRAPID_TEACHER.md#154-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 15](TRAPID_LEXICON.md)

---

---

## RULE #15.5: Rate Limiting & Error Handling

âŒ NEVER

âŒ **NEVER retry immediately on 429 errors**

âœ… **ALWAYS implement exponential backoff**

âœ… **ALWAYS log failed requests for debugging**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§15.5](TRAPID_TEACHER.md#155-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 15](TRAPID_LEXICON.md)

---

---

## RULE #15.6: Tax Rates & Chart of Accounts

âŒ NEVER

âŒ **NEVER hardcode tax codes**

âœ… **ALWAYS fetch from Xero and cache locally**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§15.6](TRAPID_TEACHER.md#156-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 15](TRAPID_LEXICON.md)

---

---

## RULE #15.7: Background Job Processing

âŒ NEVER

âŒ **NEVER sync contacts in HTTP request**

âœ… **ALWAYS use `XeroContactSyncJob` via Solid Queue**

âœ… **ALWAYS provide job progress tracking**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§15.7](TRAPID_TEACHER.md#157-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 15](TRAPID_LEXICON.md)

---

---

## RULE #15.8: Payment Sync Workflow

âŒ NEVER

âŒ **NEVER create Xero payment before local Payment record**

âœ… **ALWAYS link Payment to PurchaseOrder**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§15.8](TRAPID_TEACHER.md#158-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 15](TRAPID_LEXICON.md)

---

---

# Chapter 16: Payments

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”§ TEACHER (HOW):     TRAPID_TEACHER.md Ch16    â”‚
â”‚ ğŸ“• LEXICON (BUGS):    TRAPID_LEXICON.md Ch16    â”‚
â”‚ ğŸ“˜ USER MANUAL (USE): TRAPID_USER_MANUAL.md Ch16 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

**Last Updated:** 2025-11-17 10:57 AEST

## RULE #16.1: Payment Model Structure

âœ… MUST

âœ… **MUST include core fields:**

âœ… **MUST use DECIMAL(15,2) for precision:**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§16.1](TRAPID_TEACHER.md#161-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 16](TRAPID_LEXICON.md)

---

---

## RULE #16.2: Automatic Payment Status Updates

âœ… MUST

âœ… **MUST trigger on payment save/destroy:**

âœ… **MUST define payment status states:**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§16.2](TRAPID_TEACHER.md#162-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 16](TRAPID_LEXICON.md)

---

---

## RULE #16.3: Xero Invoice Fuzzy Matching

âœ… MUST

âœ… **MUST implement matching hierarchy:**

âœ… **MUST update PO with invoice data:**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§16.3](TRAPID_TEACHER.md#163-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 16](TRAPID_LEXICON.md)

---

---

## RULE #16.4: Xero Payment Sync

âœ… MUST

âœ… **MUST validate and sync:**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§16.4](TRAPID_TEACHER.md#164-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 16](TRAPID_LEXICON.md)

---

---

## RULE #16.5: Payment Method Enum

âœ… MUST

âœ… **MUST restrict to valid methods:**

âœ… **MUST provide method selector:**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§16.5](TRAPID_TEACHER.md#165-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 16](TRAPID_LEXICON.md)

---

---

## RULE #16.6: Financial Precision with DECIMAL(15,2)

âœ… MUST

âœ… **MUST use DECIMAL type:**

âœ… **MUST validate precision:**

âŒ **NEVER use FLOAT:**
- Causes rounding errors in currency calculations
- Example: `0.1 + 0.2 = 0.30000000000000004` (FLOAT)
- DECIMAL: `0.10 + 0.20 = 0.30` (exact)

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§16.6](TRAPID_TEACHER.md#166-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 16](TRAPID_LEXICON.md)

---

---

## RULE #16.7: Payment Status Badge Display

âœ… MUST

âœ… **MUST use semantic colors:**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§16.7](TRAPID_TEACHER.md#167-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 16](TRAPID_LEXICON.md)

---

---

## RULE #16.8: Payment Summary Calculation

âœ… MUST

âœ… **MUST include summary:**

âœ… **MUST show summary prominently:**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§16.8](TRAPID_TEACHER.md#168-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 16](TRAPID_LEXICON.md)

---

---

## RULE #16.9: Budget Variance Tracking

âœ… MUST

âœ… **MUST calculate variances:**

âœ… **MUST highlight overages:**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§16.9](TRAPID_TEACHER.md#169-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 16](TRAPID_LEXICON.md)

---

---

## RULE #16.10: Cascade Delete Payments

âœ… MUST

âœ… **MUST set dependent: :destroy:**

âŒ **NEVER orphan payments:**
- Deleting PO without deleting payments breaks referential integrity
- Payment without PO is meaningless
- Use `dependent: :destroy` not `dependent: :nullify`

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§16.10](TRAPID_TEACHER.md#1610-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 16](TRAPID_LEXICON.md)

---

---

# Chapter 17: Workflows

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”§ TEACHER (HOW):     TRAPID_TEACHER.md Ch17    â”‚
â”‚ ğŸ“• LEXICON (BUGS):    TRAPID_LEXICON.md Ch17    â”‚
â”‚ ğŸ“˜ USER MANUAL (USE): TRAPID_USER_MANUAL.md Ch17 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

**Last Updated:** 2025-11-17 10:57 AEST

## RULE #17.1: Solid Queue Background Job System

âœ… MUST

âœ… **MUST configure Solid Queue:**

âœ… **MUST inherit from ApplicationJob:**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§17.1](TRAPID_TEACHER.md#171-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 17](TRAPID_LEXICON.md)

---

---

## RULE #17.2: Workflow State Machine

âœ… MUST

âœ… **MUST implement state machine:**

âœ… **MUST auto-advance on step completion:**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§17.2](TRAPID_TEACHER.md#172-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 17](TRAPID_LEXICON.md)

---

---

## RULE #17.3: Idempotent Background Jobs

âœ… MUST

âœ… **MUST check completion status:**

âœ… **MUST verify record doesn't exist:**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§17.3](TRAPID_TEACHER.md#173-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 17](TRAPID_LEXICON.md)

---

---

## RULE #17.4: Price Update Automation

âœ… MUST

âœ… **MUST implement price application:**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§17.4](TRAPID_TEACHER.md#174-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 17](TRAPID_LEXICON.md)

---

---

## RULE #17.5: Model Callback Automation

âœ… MUST

âœ… **MUST update dependent data:**

âœ… **MUST trigger child creation:**

âœ… **MUST track changes:**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§17.5](TRAPID_TEACHER.md#175-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 17](TRAPID_LEXICON.md)

---

---

## RULE #17.6: Job Status Tracking

âœ… MUST

âœ… **MUST provide status visibility:**

âœ… **MUST show percentage:**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§17.6](TRAPID_TEACHER.md#176-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 17](TRAPID_LEXICON.md)

---

---

## RULE #17.7: Batch Processing with Rate Limiting

âœ… MUST

âœ… **MUST batch and throttle:**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§17.7](TRAPID_TEACHER.md#177-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 17](TRAPID_LEXICON.md)

---

---

## RULE #17.8: Workflow Metadata Storage

âœ… MUST

âœ… **MUST support all workflow types:**

âœ… **MUST collect metadata:**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§17.8](TRAPID_TEACHER.md#178-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 17](TRAPID_LEXICON.md)

---

---

# Chapter 18: Custom Tables

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”§ TEACHER (HOW):     TRAPID_TEACHER.md Ch18    â”‚
â”‚ ğŸ“• LEXICON (BUGS):    TRAPID_LEXICON.md Ch18    â”‚
â”‚ ğŸ“˜ USER MANUAL (USE): TRAPID_USER_MANUAL.md Ch18 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

**Last Updated:** 2025-11-17 10:57 AEST

## RULE #18.1: Dynamic Table Creation Pattern

âœ… MUST

âœ… **MUST use auto-generated unique name:**

âœ… **MUST create ActiveRecord model at runtime:**

âŒ **NEVER:**
- Use table names without prefix
- Allow reserved names: `["user", "users", "table", "tables", "column", "columns", "record", "records"]`
- Reuse database_table_name across tables

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§18.1](TRAPID_TEACHER.md#181-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 18](TRAPID_LEXICON.md)

---

---

## RULE #18.2: Column Type System

âœ… MUST

âœ… **MUST map column types correctly:**

âœ… **MUST use TableBuilder for physical schema changes:**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§18.2](TRAPID_TEACHER.md#182-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 18](TRAPID_LEXICON.md)

---

---

## RULE #18.3: Formula Evaluation System

âœ… MUST

âœ… **MUST support curly brace references:**

âœ… **MUST evaluate formulas safely:**

âœ… **MUST flag columns with cross-table refs:**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§18.3](TRAPID_TEACHER.md#183-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 18](TRAPID_LEXICON.md)

---

---

## RULE #18.4: Lookup Column Pattern

âœ… MUST

âœ… **MUST create associations dynamically:**

âœ… **MUST batch-load related records:**

âœ… **MUST return id + display value:**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§18.4](TRAPID_TEACHER.md#184-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 18](TRAPID_LEXICON.md)

---

---

## RULE #18.5: Record CRUD with Formula Calculation

âœ… MUST

âœ… **MUST calculate formulas on save:**

âœ… **MUST transform computed values on read:**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§18.5](TRAPID_TEACHER.md#185-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 18](TRAPID_LEXICON.md)

---

---

## RULE #18.6: Table Deletion Safety

âœ… MUST

âœ… **MUST validate before deletion:**

âœ… **MUST drop database table:**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§18.6](TRAPID_TEACHER.md#186-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 18](TRAPID_LEXICON.md)

---

---

## RULE #18.7: Column Validation Rules

âœ… MUST

âœ… **MUST enforce validation rules:**

âœ… **MUST validate record data before save:**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§18.7](TRAPID_TEACHER.md#187-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 18](TRAPID_LEXICON.md)

---

---

## RULE #18.8: Foreign Key Constraints

âœ… MUST

âœ… **MUST add foreign keys for lookups:**

âŒ **NEVER use on_delete: :cascade** for lookup columns (data loss risk)

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§18.8](TRAPID_TEACHER.md#188-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 18](TRAPID_LEXICON.md)

---

---

# Chapter 19: UI/UX

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”§ TEACHER (HOW):     TRAPID_TEACHER.md Ch19    â”‚
â”‚ ğŸ“• LEXICON (BUGS):    TRAPID_LEXICON.md Ch19    â”‚
â”‚ ğŸ“˜ USER MANUAL (USE): TRAPID_USER_MANUAL.md Ch19 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

**Last Updated:** 2025-11-17 11:26 AEST

## RULE #19.1: Standard Table Component Usage

âœ… MUST

âœ… **MUST ask user before creating ANY table:**

âŒ **NEVER:**
- Create table without asking user
- Choose on behalf of user
- Create "basic" custom table (use DataTable instead)

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§19.1](TRAPID_TEACHER.md#191-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 19](TRAPID_LEXICON.md)

---

---

## RULE #19.2: Table Header Requirements

âœ… MUST

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§19.2](TRAPID_TEACHER.md#192-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 19](TRAPID_LEXICON.md)

---

---

## RULE #19.3: Column Search/Filter Requirements (REQUIRED)

âœ… MUST

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§19.3](TRAPID_TEACHER.md#193-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 19](TRAPID_LEXICON.md)

---

---

## RULE #19.4: Column Resizing Standards

âœ… MUST

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§19.4](TRAPID_TEACHER.md#194-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 19](TRAPID_LEXICON.md)

---

---

## RULE #19.5: Column Reordering Standards

âŒ NEVER

âŒ **NEVER:**
- Put entire header in one onClick handler
- Make drag handle sortable
- Forget `e.stopPropagation()` on drag handle

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§19.5](TRAPID_TEACHER.md#195-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 19](TRAPID_LEXICON.md)

---

---

## RULE #19.5A: Column Visibility Toggle (REQUIRED)

âŒ NEVER

âŒ **NEVER:**
- Allow hiding ALL columns
- Hide actions column
- Forget localStorage persistence

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§19.5A](TRAPID_TEACHER.md#195a-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 19](TRAPID_LEXICON.md)

---

---

## RULE #19.5B: Column Width Persistence (REQUIRED)

âœ… MUST

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§19.5B](TRAPID_TEACHER.md#195b-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 19](TRAPID_LEXICON.md)

---

---

## RULE #19.6: Scroll Behavior Standards

âœ… MUST

âœ… **MUST implement for scrollable tables:**
- Use `flex` layout with `flex-1 min-h-0 flex flex-col` on container
- Scrollable area: `overflow-y-scroll overflow-x-auto`
- Sync horizontal scroll between main container and sticky scrollbar via refs
- Track scrollWidth with `ResizeObserver` for dynamic updates
- Custom scrollbar styling via webkit pseudo-elements
- Thin scrollbars: `scrollbar-width: thin` for Firefox

âŒ **NEVER:**
- Use `overflow: hidden` on flex containers (prevents scrolling)
- Forget `min-h-0` on flex children (causes overflow issues)
- Skip scroll sync between container and sticky scrollbar
- Use inline scroll handlers without refs (performance issue)

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§19.6](TRAPID_TEACHER.md#196-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 19](TRAPID_LEXICON.md)

---

---

## RULE #19.7: Column Width Standards

âœ… MUST

âœ… **MUST set widths consistently:**
- `<th>`: `style={{ width: `${width}px`, minWidth: `${width}px` }}`
- `<td>`: `style={{ width: `${width}px`, minWidth: `${width}px`, maxWidth: `${width}px` }}`

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§19.7](TRAPID_TEACHER.md#197-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 19](TRAPID_LEXICON.md)

---

---

## RULE #19.8: Cell Content Standards

âœ… MUST

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§19.8](TRAPID_TEACHER.md#198-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 19](TRAPID_LEXICON.md)

---

---

## RULE #19.9: Row Interaction Standards

âœ… MUST

âœ… **MUST implement:**
- Selection column minimum width: 50px (never smaller)
- Selection column always visible (exclude from visibility toggles)
- Selection column excluded from column reordering (always leftmost)

âŒ **NEVER:**
- Add explicit size classes to checkboxes (`h-4 w-4` OK, but browser default preferred)
- Make selection column draggable
- Include selection column in columnOrder state
- Allow selection column to be hidden via visibility toggles
- Allow selection column to be reordered (must stay leftmost)

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§19.9](TRAPID_TEACHER.md#199-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 19](TRAPID_LEXICON.md)

---

---

## RULE #19.10: Column Visibility Standards

âœ… MUST

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§19.10](TRAPID_TEACHER.md#1910-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 19](TRAPID_LEXICON.md)

---

---

## RULE #19.11: Search & Filter UI Standards

âœ… MUST

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§19.11](TRAPID_TEACHER.md#1911-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 19](TRAPID_LEXICON.md)

---

---

## RULE #19.11A: Table Toolbar Layout Standards (REQUIRED)

âŒ NEVER

âŒ **NEVER:**
- Put search on right side
- Use different button heights
- Stack toolbar vertically
- Add gap between search and first button

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§19.11A](TRAPID_TEACHER.md#1911a-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 19](TRAPID_LEXICON.md)

---

---

## RULE #19.12: Empty States

âœ… MUST

âœ… **MUST differentiate:**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§19.12](TRAPID_TEACHER.md#1912-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 19](TRAPID_LEXICON.md)

---

---

## RULE #19.13: State Persistence Standards

âœ… MUST

âœ… **MUST persist to localStorage:**

âŒ **NEVER:**
- Use generic keys (collision risk)
- Persist without try/catch
- Forget defaults

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§19.13](TRAPID_TEACHER.md#1913-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 19](TRAPID_LEXICON.md)

---

---

## RULE #19.14: Sorting Standards

âœ… MUST

âœ… **MUST support:**
- Primary/secondary sort
- 3-state cycle: asc â†’ desc â†’ none

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§19.14](TRAPID_TEACHER.md#1914-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 19](TRAPID_LEXICON.md)

---

---

## RULE #19.15: Dark Mode Requirements

âŒ NEVER

âŒ **NEVER:**
- Use light-mode-only colors
- Use pure white/black (use gray-50/gray-900)

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§19.15](TRAPID_TEACHER.md#1915-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 19](TRAPID_LEXICON.md)

---

---

## RULE #19.16: Performance Standards

âœ… MUST

âœ… **MUST memoize when:**
- Filtering large datasets (>100 rows)
- Sorting complex data
- Computing derived values

âŒ **NEVER:**
- Filter/sort without memoization
- Create inline functions in map()

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§19.16](TRAPID_TEACHER.md#1916-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 19](TRAPID_LEXICON.md)

---

---

## RULE #19.17: Accessibility Standards

âœ… MUST

âœ… **MUST support:**
- Tab through interactive elements
- Enter/Space to trigger actions
- `scope="col"` on `<th>` elements
- `aria-label` on icon-only buttons
- Semantic HTML (`<table>`, `<thead>`, `<tbody>`)
- `sr-only` text for icons

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§19.17](TRAPID_TEACHER.md#1917-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 19](TRAPID_LEXICON.md)

---

---

## RULE #19.18: Testing Considerations

âœ… MUST

âœ… **MUST verify:**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§19.18](TRAPID_TEACHER.md#1918-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 19](TRAPID_LEXICON.md)

---

---

## RULE #19.19: URL State Management

âœ… MUST

âœ… **MUST sync URL for:**
- Active tab selection (always)
- Filter/search queries (optional, for sharing)
- Pagination state
- Sort state (optional)

âŒ **NEVER:**
- Store tab state only in component
- Break browser back button
- Use push for every state change

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§19.19](TRAPID_TEACHER.md#1919-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 19](TRAPID_LEXICON.md)

---

---

## RULE #19.20: Search Functionality Standards

âœ… MUST

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§19.20](TRAPID_TEACHER.md#1920-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 19](TRAPID_LEXICON.md)

---

---

## RULE #19.21: Form Standards

âœ… MUST

âœ… **MUST include for all inputs:**
- Label with `htmlFor` matching input `id`
- Dark mode styling
- Focus states (indigo ring)
- Error state styling

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§19.21](TRAPID_TEACHER.md#1921-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 19](TRAPID_LEXICON.md)

---

---

## RULE #19.22: Modal & Drawer Standards

âœ… MUST

âœ… **MUST include:**
- Close button (top-right)
- Dark mode support

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§19.22](TRAPID_TEACHER.md#1922-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 19](TRAPID_LEXICON.md)

---

---

## RULE #19.23: Toast Notification Standards

âœ… MUST

âœ… **MUST use Toast for:**
- Success confirmations
- Error messages
- Warning notifications
- Info messages

âŒ **NEVER:**
- Show technical errors to users
- Use toasts for critical errors (use modal)
- Stack multiple toasts
- Show longer than 5 seconds

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§19.23](TRAPID_TEACHER.md#1923-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 19](TRAPID_LEXICON.md)

---

---

## RULE #19.24: Loading State Standards

âœ… MUST

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§19.24](TRAPID_TEACHER.md#1924-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 19](TRAPID_LEXICON.md)

---

---

## RULE #19.25: Button & Action Standards

âœ… MUST

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§19.25](TRAPID_TEACHER.md#1925-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 19](TRAPID_LEXICON.md)

---

---

## RULE #19.26: Status Badge Standards

âœ… MUST

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§19.26](TRAPID_TEACHER.md#1926-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 19](TRAPID_LEXICON.md)

---

---

## RULE #19.27: Empty State Standards

âœ… MUST

âœ… **MUST differentiate:**

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§19.27](TRAPID_TEACHER.md#1927-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 19](TRAPID_LEXICON.md)

---

---

## RULE #19.28: Navigation Standards

âœ… MUST

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§19.28](TRAPID_TEACHER.md#1928-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 19](TRAPID_LEXICON.md)

---

---

## RULE #19.29: Chapter 19 Documentation Maintenance (REQUIRED)

âœ… MUST

âœ… **MUST update Chapter 19 when:**
- Adding new table features
- Modifying existing table patterns
- Creating new components
- Changing standard UI patterns
- Adding new requirements
- Discovering missing features

âŒ **NEVER:**
- Make table changes without updating Chapter 19
- Create custom patterns not documented
- Skip timestamp update
- Forget to commit Bible with code

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§19.29](TRAPID_TEACHER.md#1929-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 19](TRAPID_LEXICON.md)

---

---

## RULE #19.30: Touch Target Sizes & Click Areas

âŒ NEVER

âŒ **NEVER:**
- Create interactive elements < 44px without compensating padding
- Place elements closer than 8px
- Assume mouse users only

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§19.30](TRAPID_TEACHER.md#1930-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 19](TRAPID_LEXICON.md)

---

---

## RULE #19.31: Data-Dense Table Layout Pattern

âœ… MUST

âœ… **MUST use compact layout for data-heavy tables:**
- Compact padding on rows and headers
- Cell truncation with hover tooltips
- Row expansion for full content

âŒ **NEVER:**
- Use spacious padding (`py-6`) for data-dense tables
- Skip expansion mechanism for truncated content

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§19.31](TRAPID_TEACHER.md#1931-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 19](TRAPID_LEXICON.md)

---

---

## RULE #19.32: Zebra Striping (Alternating Row Colors)

âœ… MUST

âœ… **MUST use zebra striping for wide tables (> 7 columns):**
- Alternating row colors for horizontal tracking
- Sufficient contrast in both light and dark modes
- Maintain pattern when filtering/sorting

âŒ **NEVER:**
- Use too subtle colors (insufficient contrast)
- Remove zebra on hover (both should be visible)
- Use zebra on narrow tables (< 5 columns)

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§19.32](TRAPID_TEACHER.md#1932-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 19](TRAPID_LEXICON.md)

---

---

## RULE #19.33: Sticky Horizontal Scrollbar Pattern

âœ… MUST

âœ… **MUST ALWAYS:**

1. **MUST use ref flags** to prevent infinite scroll loops:
   - `isScrollingStickyRef` - Set when sticky scrollbar scrolls
   - `isScrollingMainRef` - Set when main container scrolls
   - Check flags at start of handlers and return early if set

2. **MUST hide native horizontal scrollbar** when using custom sticky scrollbar:
   [Code example - see code_example field]
   [Code example - see code_example field]

3. **MUST measure actual table element** for scrollbar width:
   [Code example - see code_example field]

4. **MUST position sticky scrollbar** with `position: sticky` and `bottom: 0`

5. **MUST use ResizeObserver** to update scrollbar on column resize

âŒ **NEVER:**

1. **NEVER use placeholder values** in scroll loop - causes infinite loops
2. **NEVER measure container scrollWidth** - use actual table offsetWidth instead
3. **NEVER use overflow-x-hidden** on main container - breaks horizontal scrolling
4. **NEVER forget to sync scrollLeft** in both directions (main â†” sticky)

ğŸ“‹ **Implementation Checklist:**

- [ ] Scroll loop prevention refs created (`isScrollingStickyRef`, `isScrollingMainRef`)
- [ ] Main scroll handler syncs to sticky scrollbar
- [ ] Sticky scroll handler syncs to main container
- [ ] ResizeObserver updates scrollbar width on changes
- [ ] Native horizontal scrollbar hidden (CSS + inline styles)
- [ ] Sticky scrollbar positioned with `position: sticky, bottom: 0`
- [ ] Table has `minWidth` based on sum of column widths
- [ ] Default column widths ensure horizontal overflow on most screens

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§19.33](TRAPID_TEACHER.md#1933-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 19, Â§19.33](TRAPID_LEXICON.md)

---

### Code Example

```
   .container::-webkit-scrollbar:horizontal {
     display: none !important;
     height: 0 !important;
   }
   

---

   style={{ scrollbarWidth: 'none', msOverflowStyle: 'none' }}
   

---

   const table = container.querySelector('table')
   const actualTableWidth = table ? table.offsetWidth : scrollWidth
   
```

---

## RULE #19.34: Modern Table Header Aesthetics

âœ… MUST

âœ… **MUST apply glass-morphism effect to table headers:**
- Semi-transparent background with backdrop blur
- Subtle shadow and borders
- Small font size with medium weight
- Subtle colors in light and dark modes

âŒ **NEVER:**
- Use solid opaque backgrounds (loses modern effect)
- Use heavy font weights (`font-bold`, `font-semibold`)
- Use bright or saturated header colors

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§19.34](TRAPID_TEACHER.md#1934-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 19](TRAPID_LEXICON.md)

---

---

## RULE #19.35: Table Border Framing

âœ… MUST

âœ… **MUST add complete border framing for full-width tables:**
- Left and right borders on `<table>` element
- Consistent border colors in light and dark modes
- Provides visual container boundary

âŒ **NEVER:**
- Skip borders on full-width tables
- Use incomplete framing (border-b or border-t only)
- Apply borders to container div instead of table element

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§19.35](TRAPID_TEACHER.md#1935-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 19](TRAPID_LEXICON.md)

---

---

## RULE #19.36: Expand/Collapse Row Details Pattern

âœ… MUST

âœ… **MUST implement for tables with detailed content:**
- Expand icon with click entire row to toggle
- Expanded row spans all columns with visual separation
- Use `Set` for tracking expansion state (performance)
- Properly formatted content in expanded view

âŒ **NEVER:**
- Make only icon clickable (bad UX)
- Use array for expandedRows (slow lookup)
- Skip colSpan (content constrained to first column)
- Forget click event propagation on nested elements

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§19.36](TRAPID_TEACHER.md#1936-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 19](TRAPID_LEXICON.md)

---

---

# Chapter 20: Agents

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”§ TEACHER (HOW):     TRAPID_TEACHER.md Ch20    â”‚
â”‚ ğŸ“• LEXICON (BUGS):    TRAPID_LEXICON.md Ch20    â”‚
â”‚ ğŸ“˜ USER MANUAL (USE): TRAPID_USER_MANUAL.md Ch20 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

**Last Updated:** 2025-11-17 10:57 AEST

## RULE #20.1: Agent Definitions Are Database-Driven

âœ… MUST

âœ… **MUST:**
- Store all agent metadata in database
- Update run history after each agent execution
- Use API endpoints to manage agents
- Track success/failure rates
- Maintain agent priority order

âŒ **NEVER:**
- Hardcode agent configurations in code
- Skip recording agent runs
- Modify `.claude/agents/*.md` files without updating database
- Create agents without database entries

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§20.1](TRAPID_TEACHER.md#201-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 20](TRAPID_LEXICON.md)

---

---

## RULE #20.2: Agent Invocation Protocol

âœ… MUST

âœ… **MUST:**
- Check if agent exists and is active
- Record run start timestamp
- Execute agent task
- Record success or failure with details
- Return comprehensive result

âŒ **NEVER:**
- Invoke inactive agents
- Skip recording run results
- Return vague error messages
- Execute agents without user context

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§20.2](TRAPID_TEACHER.md#202-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 20](TRAPID_LEXICON.md)

---

---

## RULE #20.3: Run History Tracking

âœ… MUST

âœ… **MUST:**
- Record total_runs, successful_runs, failed_runs
- Store last_run_at timestamp
- Save last_status and last_message
- Include detailed last_run_details (JSONB)
- Calculate success_rate automatically

âŒ **NEVER:**
- Skip recording runs
- Overwrite historical run data
- Record runs for testing/debugging
- Fake success/failure status

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§20.3](TRAPID_TEACHER.md#203-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 20](TRAPID_LEXICON.md)

---

---

## RULE #20.4: Agent Types and Specialization

âœ… MUST

âœ… **MUST:**
- Assign agent_type: `development`, `diagnostic`, `deployment`, or `planning`
- Define clear focus area (e.g., "Rails API Backend Development")
- Specify tools available to agent
- Document when to use each agent
- Provide example invocations

âŒ **NEVER:**
- Create overlapping agent responsibilities
- Use generic agent for specialized tasks
- Skip documenting agent capabilities
- Create agents without clear purpose

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§20.4](TRAPID_TEACHER.md#204-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 20](TRAPID_LEXICON.md)

---

---

## RULE #20.5: Agent Priority and Display Order

âœ… MUST

âœ… **MUST:**
- Set priority field (0-100)
- Display agents sorted by: priority DESC, name ASC
- Show active agents first
- Hide inactive agents from main list

âŒ **NEVER:**
- Display agents alphabetically only
- Show inactive agents in main list
- Change priority without reason

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§20.5](TRAPID_TEACHER.md#205-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 20](TRAPID_LEXICON.md)

---

---

## RULE #20.6: Agent Shortcuts and Invocation

âœ… MUST

âœ… **MUST:**
- Support `run {agent-id}` (e.g., `run backend-developer`)
- Support shortened versions (e.g., `backend dev`, `gantt`)
- Document shortcuts in `example_invocations` field
- Parse user input case-insensitively

âŒ **NEVER:**
- Require exact agent_id match
- Skip documenting shortcuts
- Create conflicting shortcuts

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§20.6](TRAPID_TEACHER.md#206-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 20](TRAPID_LEXICON.md)

---

---

## RULE #20.7: Recently Run Check (Smart Testing)

âœ… MUST

âœ… **MUST:**
- Check `last_run_at` timestamp
- Compare to threshold (e.g., 60 minutes)
- Skip redundant tests if recent successful run
- ALWAYS re-run if last run failed
- Ask user if uncertain

âŒ **NEVER:**
- Skip tests without checking recency
- Ignore failed runs in recency check
- Use stale results without user awareness

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§20.7](TRAPID_TEACHER.md#207-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 20](TRAPID_LEXICON.md)

---

---

## RULE #20.8: Shortcut Clarity - AgentShortcutsTab Updates

âœ… MUST

âœ… **MUST:**
- Update `frontend/src/components/settings/AgentShortcutsTab.jsx` when adding new shortcuts
- Add new shortcuts to the `baseCommands` array
- Ensure shortcuts match agent file definitions exactly
- Use sequential IDs (avoid duplicates)
- Document the shortcut pattern in the command field
- Follow the format: `{ id: N, command: 'What Claude executes', shortcut: 'what user types, comma-separated' }`

âŒ **NEVER:**
- Leave shortcuts undocumented
- Create duplicate IDs in baseCommands array
- Use shortcuts that contradict agent definitions
- Hardcode shortcuts outside the table

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§20.8](TRAPID_TEACHER.md#208-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 20](TRAPID_LEXICON.md)

---

---

## RULE #20.9: Creating New Agents - Complete Checklist

âœ… MUST

âœ… **MUST UPDATE (4 files):**

âŒ **NEVER:**
- Create an agent in only one location
- Skip updating run-history.json
- Forget to add to the controllers fallback list
- Miss updating the frontend component

**ğŸ“– Implementation:** See [TRAPID_TEACHER.md Â§20.9](TRAPID_TEACHER.md#209-)
**ğŸ“• Bug History:** See [TRAPID_LEXICON.md Chapter 20](TRAPID_LEXICON.md)

---

---

