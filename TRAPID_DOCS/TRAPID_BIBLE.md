# TRAPID BIBLE - Development Rules

**Version:** 2.0.0
**Last Updated:** 2025-11-17 22:19 AEST
**Authority Level:** ABSOLUTE
**Audience:** Claude Code + Human Developers
**Source of Truth:** Database table `bible_rules` (this file is auto-generated)

---

## üî¥ CRITICAL: Read This First

### This Document is "The Bible"

This file is the **absolute authority** for all Trapid development where chapters exist.

**This Bible Contains RULES ONLY:**
- ‚úÖ MUST do this
- ‚ùå NEVER do that
- üîÑ ALWAYS check X before Y
- üîí Protected code patterns
- ‚öôÔ∏è Configuration values that must match

**This file is AUTO-GENERATED from the database.**
- **DO NOT edit this file directly**
- Update rules via Trapid app ‚Üí Documentation page ‚Üí üìñ Bible
- Export to markdown via: `bin/rails trapid:export_bible`

**For IMPLEMENTATION PATTERNS (code examples, how-to guides):**
- üîß See [TRAPID_TEACHER.md](TRAPID_TEACHER.md)

**For KNOWLEDGE (how things work, bug history, why we chose X):**
- üìï See [TRAPID_LEXICON.md](TRAPID_LEXICON.md)

**For USER GUIDES (how to use features):**
- üìò See [TRAPID_USER_MANUAL.md](TRAPID_USER_MANUAL.md)

---

# Chapter 1: Overview & System-Wide Rules

**Last Updated:** 2025-11-18 02:29 AEST

## RULE #1.1: Documentation Maintenance

üìñ Rule

When to Update Bible:
‚úÖ MUST update Bible when:
1. Adding a new coding rule (MUST/NEVER/ALWAYS pattern)
2. Discovering a protected code pattern
3. Adding a critical configuration value
4. Finding a bug-causing violation

‚ùå DO NOT update Bible for:
- Bug discoveries (goes in Lexicon)
- Architecture explanations (goes in Lexicon)
- Performance optimizations (goes in Lexicon unless it creates a new RULE)


## RULE #1.10: Section Numbers Must Be Unique Within Chapter + Category

‚úÖ Must

‚úÖ **MUST ensure section numbers are unique within each chapter + category combination:**
- Each section number can only be used ONCE per chapter per category
- Bible, Teacher, and Lexicon each have independent section numbering
- Example: Bible RULE #21.10, Teacher ¬ß21.10, and Lexicon ¬ß21.10 can all coexist

‚ùå **NEVER reuse section numbers within same chapter + category:**
- Invalid: Two Bible entries both using RULE #21.10 (same chapter, same category)
- Invalid: Two Teacher entries both using ¬ß0.2 (same chapter, same category)

‚úÖ **VALID - different categories can share section numbers:**
- Bible RULE #21.10 AND Teacher ¬ß21.10 (different categories) ‚úÖ
- Bible RULE #0.2 AND Teacher ¬ß0.2 (different categories) ‚úÖ

**Why this matters:**
- Each Trinity category has its own documentation structure
- Section numbers reference entries within their own category
- Database constraints should enforce uniqueness on (chapter_number, section_number, category)

**How to implement:**
- Add unique index: CREATE UNIQUE INDEX idx_trinity_unique_section ON trinity(chapter_number, section_number, category)
- Model validation: validates :section_number, uniqueness: { scope: [:chapter_number, :category] }


## RULE #1.11: Chapter Assignment - Where to Place New Rules

‚úÖ Must

‚úÖ **MUST place rules in the correct chapter:**

**Chapter 1: System-Wide Rules**
- Trinity documentation workflow and meta-rules
- Trinity entry types and section numbering
- Code quality standards
- API response formats
- Database migration rules
- Documentation maintenance
- General application patterns
- Example: RULE #1.8 (Always Fetch Trinity Before Modifying Code)
- Example: RULE #1.9 (Section Numbers Must Be Purely Numeric)

**Chapters 2-21: Feature-Specific Rules**
- Chapter 2: Authentication & Users
- Chapter 3: System Administration
- Chapter 4: Contacts & Relationships
- Chapter 5: Price Books & Suppliers
- Chapter 6: Jobs & Construction Management
- Chapter 7: Estimates & Quoting
- Chapter 8: AI Plan Review
- Chapter 9: Purchase Orders
- Chapter 10: Gantt & Schedule Master
- Chapter 11: Project Tasks & Checklists
- Chapter 12: Weather & Public Holidays
- Chapter 13: OneDrive Integration
- Chapter 14: Outlook/Email Integration
- Chapter 15: Chat & Communications
- Chapter 16: Xero Accounting Integration
- Chapter 17: Payments & Financials
- Chapter 18: Workflows & Automation
- Chapter 19: Custom Tables & Formulas
- Chapter 20: UI/UX Standards & Patterns
- Chapter 21: Agent System & Automation

‚ùå **NEVER:**
- Create Chapter 0 (all system-wide rules go in Chapter 1)
- Put feature-specific rules in Chapter 1
- Create rules in wrong feature chapters (e.g., Gantt rules in Chapter 4)

**How to decide:**
1. Is this a system-wide rule or Trinity meta-rule? ‚Üí Chapter 1
2. Is this feature-specific? ‚Üí Find matching chapter (2-21)
3. Unsure? Ask which chapter it belongs in


## RULE #1.12: Never Guess - Always Ask

‚ùå Never

‚ùå **NEVER guess what the user wants:**
- When user asks "anything else we should remove" ‚Üí Ask specific clarifying questions
- When user says "can we take this out" ‚Üí Ask which specific parts they mean
- When given vague requests ‚Üí List options and ask user to choose
- When uncertain about intent ‚Üí Present alternatives and ask for confirmation

‚úÖ **ALWAYS ask explicitly:**
- "Would you like me to remove X?"
- "Do you mean A, B, or C?"
- "Should I proceed with option 1 or option 2?"
- "Which of these would you prefer?"

**Why this matters:**
User gave feedback "please dont guess" when Claude assumed user wanted to remove a line without asking first. Guessing wastes user time when Claude guesses wrong.


## RULE #1.13: Single Source of Truth - Eliminate Data Duplication

‚úÖ Must

‚úÖ **MUST identify and eliminate multiple sources of truth:**

**The Problem:**
When the same data exists in multiple places, they inevitably drift out of sync, causing:
- Conflicting information
- Unclear which source is authoritative
- Bugs when one source is updated but not others
- Maintenance burden keeping everything synchronized

**How to Identify:**
Look for the same information stored in:
- Database tables AND configuration files
- Environment variables AND database records
- Markdown files AND database tables
- Frontend constants AND backend database
- Multiple database tables with overlapping data

**MUST Fix Pattern:**
1. **Identify the single source of truth** (usually database)
2. **Make other locations read from the source** (via API, query, import)
3. **Remove duplication** - delete redundant copies
4. **Document the authority** - which source is canonical

**Example - General Pattern:**
‚ùå **BAD (Multiple sources of truth):**
- User roles in database AND hardcoded in frontend
- Configuration in .env AND database settings table
- Feature flags in code AND database

‚úÖ **GOOD (Single source of truth):**
- Database is the ONLY source of truth
- Frontend reads from API (not hardcoded)
- Code imports from authoritative source

**When duplication is acceptable:**
- Performance caching (with clear expiry/invalidation)
- Offline/backup copies (with sync mechanism)
- Derived/computed data (with clear calculation source)

**Document it:**
Always add comment showing which source is authoritative:
```javascript
// Source of truth: database settings table
// This component reads from API /api/v1/settings
```

‚ùå **NEVER:**
- Create duplicate data without clear authority
- Assume manual sync will stay consistent
- Store same data in multiple writeable locations


## RULE #1.2: Code Quality Standards

üìñ Rule

‚ùå NEVER commit code with:
- Console.log statements (use proper logging)
- Commented-out code (delete it)
- TODO comments without GitHub issues
- Hardcoded credentials or API keys

‚úÖ ALWAYS:
- Use environment variables for secrets
- Write descriptive commit messages
- Run linter before committing
- Test locally before pushing


## RULE #1.3: API Response Format

üìñ Rule

‚úÖ ALWAYS return consistent JSON:

Success response:
{ success: true, data: { ... }, message: "Optional" }

Error response:
{ success: false, error: "Error message", details: { ... } }


## RULE #1.4: Database Migrations

üìñ Rule

‚ùå NEVER:
- Modify existing migrations after deployment
- Delete migrations that have run in production
- Add columns manually without migrations

‚úÖ ALWAYS:
- Create new migration to fix issues
- Test migrations with db:rollback
- Add indexes for foreign keys
- Create migrations for ALL schema changes


## RULE #1.5: Agent Maintenance & Learning

üìñ Rule

When an agent fails to catch a bug:
1. Update agent definition in .claude/agents/
2. Document in Lexicon Chapter 0
3. Update Bible if it reveals a new RULE

‚úÖ ALWAYS ask: "Could an agent have prevented this?"
‚ùå NEVER let the same class of bug happen twice


## RULE #1.6: Documentation Authority Hierarchy

üìñ Rule

Authority Order (Highest to Lowest):
1. TRAPID_BIBLE.md - ABSOLUTE AUTHORITY for protected features
2. CLAUDE.md - META INSTRUCTIONS for AI behavior
3. TRAPID_LEXICON.md - REFERENCE for bug history
4. Code comments - IMPLEMENTATION DETAILS


## RULE #1.7: Trinity Database Sync

‚úÖ Must

‚úÖ MUST

The Trinity system (Bible + Lexicon + Teacher combined) is **DATABASE-FIRST**.

**Source of Truth:** Trinity database table (PostgreSQL)
**Markdown Files:** Auto-generated exports for git history and offline reference ONLY

**Architecture:**
- Database ‚Üí API ‚Üí Frontend UI (primary use)
- Database ‚Üí Export ‚Üí Markdown files (backup/git only)

**DO NOT:**
- ‚ùå Read markdown files for rules (always use API)
- ‚ùå Edit markdown files directly (use UI or database)
- ‚ùå Trust markdown as source of truth (may be stale)

**ALWAYS:**
- ‚úÖ Fetch from /api/v1/trinity APIs for real-time data
- ‚úÖ Edit via UI (stores in database)
- ‚úÖ Export to markdown for git commit backups

**Fetch from Trinity API:**
```bash
# Get all Bible rules
curl https://trapid-backend-447058022b51.herokuapp.com/api/v1/trinity?category=bible

# Get all Lexicon entries
curl https://trapid-backend-447058022b51.herokuapp.com/api/v1/trinity?category=lexicon

# Get all Teacher guides  
curl https://trapid-backend-447058022b51.herokuapp.com/api/v1/trinity?category=teacher

# Get specific chapter
curl https://trapid-backend-447058022b51.herokuapp.com/api/v1/trinity?category=bible&chapter=21
```

**Export to Markdown (for git backup):**
```bash
# Export Bible to TRAPID_BIBLE.md
bin/rails trapid:export_bible

# Export Lexicon to TRAPID_LEXICON.md
bin/rails trapid:export_lexicon

# Export Teacher to TRAPID_TEACHER.md
bin/rails trapid:export_teacher
```

**Import from Markdown (restore from backup):**
```bash
# Import Bible from TRAPID_BIBLE.md
bin/rails trapid:import_bible

# Import Lexicon from TRAPID_LEXICON.md
bin/rails trapid:import_lexicon

# Import Teacher from TRAPID_TEACHER.md
bin/rails trapid:import_teacher
```

**Workflow:**
1. Edit via UI ‚Üí Updates trinity table
2. Run export task ‚Üí Generates markdown file
3. Commit markdown file to git (backup)
4. Other developers: Pull ‚Üí Database is already synced (no import needed)

**Validation:**
- Use /trinity-sync-validator agent to verify sync
- Trinity table is ALWAYS authoritative
- Markdown exports are snapshots for git history


## RULE #1.8: Always Fetch Trinity Before Modifying Code

üîÑ Always

‚úÖ **ALWAYS fetch Trinity Bible/Lexicon/Teacher when:**
- User mentions a feature name
- Working on files related to a specific chapter
- User reports a bug
- Adding new functionality
- Modifying existing code

‚ùå **NEVER:**
- Modify feature code without fetching Bible rules for that chapter
- Change values or patterns mentioned in Bible rules
- Skip reading Protected Code Patterns
- "Optimize" or "simplify" code without checking Bible first

**Chapter ‚Üí Feature mapping:**
- Chapter 7: Gantt Chart, Schedule Master, cascade, dependencies
- Chapter 15: Xero, accounting, invoice sync
- Chapter 19: Table Pattern, UI components, modals, forms
- Chapter 20: UI/UX Standards & Patterns
- Chapter 21: Agent System & Automation


## RULE #1.9: Section Numbers Must Be Purely Numeric

‚úÖ Must

‚úÖ **MUST use only digits and dots in section numbers:**
- Valid: 0.1, 19.11, 21.9
- Valid: Single decimal point only (X.Y format)

‚ùå **NEVER use letters or suffixes in section numbers:**
- Invalid: 0.1A, 19.11A, 21.9a
- Invalid: 0.1-beta, 19.11v2
- Invalid: Any non-numeric characters

**Why this matters:**
Section numbers are used for sorting, filtering, and API queries. Adding letters breaks numeric sorting and makes API filtering unpredictable.

**If you need to add content between existing sections:**
- Option 1: Renumber subsequent sections (e.g., insert 19.6, renumber old 19.6 ‚Üí 19.7, old 19.7 ‚Üí 19.8)
- Option 2: Use decimal increments (19.6, then 19.7, NOT 19.6A)
- Option 3: Add as next available number and reorder manually


# Chapter 2: Authentication & Users

**Last Updated:** 2025-11-17 22:19 AEST

## RULE #2.1: JWT Token Handling

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Use `JsonWebToken.encode` to create tokens
- Include `user_id` in payload
- Set expiration to 24 hours maximum
- Send token in `Authorization: Bearer <token>` header

‚ùå **NEVER:**
- Store sensitive data in JWT payload (it's base64, not encrypted)
- Create tokens without expiration
- Share SECRET_KEY across environments
- Store tokens in localStorage (XSS vulnerable) - use httpOnly cookies on frontend


---


## RULE #2.2: Password Security Requirements

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST enforce:**
- Minimum 12 characters (NOT 8, NOT 10)
- At least 1 uppercase letter [A-Z]
- At least 1 lowercase letter [a-z]
- At least 1 digit [0-9]
- At least 1 special character [!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]

‚ùå **NEVER:**
- Log passwords (even hashed)
- Send passwords in API responses
- Store passwords in plain text
- Allow common passwords (implement dictionary check if needed)


---


## RULE #2.3: Role-Based Access Control

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Use predefined roles: `user`, `admin`, `product_owner`, `estimator`, `supervisor`, `builder`
- Check permissions via User model methods (`can_create_templates?`, `can_edit_schedule?`)
- Use `before_action :require_admin` for admin-only endpoints
- Set default role to `"user"` for new signups

‚ùå **NEVER:**
- Create roles dynamically via API
- Store roles outside the enum
- Bypass permission checks with hardcoded user IDs
- Grant admin role automatically (even for @tekna.com.au emails)


---


## RULE #2.4: Rate Limiting on Auth Endpoints

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST configure:**
- Auth endpoints: 5 requests per 20 seconds per IP
- Password reset: 3 requests per hour per email
- General API: 300 requests per 5 minutes per IP

‚ùå **NEVER:**
- Disable rate limiting in production
- Use same limits for external vs internal APIs
- Skip rate limiting for "trusted" IPs (Èô§Èùû explicitly whitelisted)


---


## RULE #2.5: OAuth Integration Pattern

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Use OmniAuth gem for all OAuth providers
- Store `provider`, `uid`, `oauth_token`, `oauth_expires_at` on User
- Generate random password for OAuth users (via `SecureRandom.hex`)
- Return JWT token after OAuth callback
- Validate OAuth tokens on every external API call

‚ùå **NEVER:**
- Store OAuth refresh tokens in database (security risk)
- Share OAuth tokens across users
- Skip token expiration checks
- Use OAuth for internal user creation (only for login)


---


## RULE #2.6: Password Reset Flow

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Generate token via `SecureRandom.urlsafe_base64(32)`
- Store hashed token in database (NOT plain text)
- Set `reset_password_sent_at` timestamp
- Expire tokens after 2 hours
- Clear token after successful reset
- Send reset email with token URL

‚ùå **NEVER:**
- Store tokens in plain text
- Reuse tokens across multiple resets
- Skip token expiration check
- Send token in API response (only via email)


---


## RULE #2.7: Portal User Separation

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Use separate `portal_users` table (NOT users table)
- Associate portal users with `Contact` record
- Implement account lockout for portal users (5 failed attempts = 30 min lockout)
- Log all portal user activities via `PortalAccessLog`
- Use `portal_type` enum: `'supplier'` or `'customer'`

‚ùå **NEVER:**
- Mix portal users and admin users in same table
- Grant admin access to portal users
- Skip activity logging for portal users
- Allow portal users to access internal APIs


---


## RULE #2.8: Login Activity Tracking

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Update `last_login_at` timestamp on successful login
- Store in UTC timezone
- Track for both User and PortalUser
- Use for account activity monitoring

‚ùå **NEVER:**
- Update on token refresh (only on actual login)
- Track in local timezone
- Skip updates (used for security monitoring)


---


# Chapter 3: System Administration

**Last Updated:** 2025-11-17 22:19 AEST

## RULE #3.1: Company Settings Singleton Pattern

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST implement as singleton:**

‚úÖ **MUST access via instance method:**

‚ùå **NEVER:**
- Create multiple CompanySetting records (singleton = one record only)
- Hardcode configuration values instead of reading from settings
- Use `CompanySetting.first` (use `CompanySetting.instance`)
- Call `CompanySetting.create` manually (use `instance` method)


---


## RULE #3.2: Timezone Handling - Backend Time Calculations

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST use CompanySetting timezone methods:**

‚úÖ **MUST use Time.use_zone context:**

‚ùå **NEVER:**
- Use `Date.today` or `Time.now` without timezone context
- Store dates/times in UTC without timezone conversion
- Assume server timezone matches company timezone
- Use JavaScript `new Date()` for date calculations (see RULE #2.3)


---


## RULE #3.3: Timezone Handling - Frontend Time Display

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST use Intl API with explicit timezone:**

‚úÖ **MUST import and use timezone utilities:**

‚ùå **NEVER:**
- Use `Date.toLocaleDateString()` without timeZone parameter (uses browser timezone!)
- Use `Date.toLocaleString()` without explicit timezone
- Use date libraries without timezone configuration (moment.js, date-fns)
- Assume user's browser timezone matches company timezone


---


## RULE #3.4: Working Days Configuration & Business Day Calculations

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST implement working_day? and business_day? methods:**

‚úÖ **MUST use in date calculations:**

‚ùå **NEVER:**
- Hardcode working days as Monday-Friday only (some industries work Sundays, skip Saturdays)
- Use Rails' `business_day?` method (doesn't respect company settings)
- Calculate task dates without checking working_days
- Allow cascade to schedule tasks on non-working days (exception: locked tasks)


---


## RULE #3.5: User Roles & Permission System

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST implement permission helper methods:**

‚úÖ **MUST check permissions in controllers:**

‚ùå **NEVER:**
- Allow users to change their own role (admin-only operation)
- Grant permissions based on string matching role names
- Skip permission checks in controllers ("I'll handle it in the UI")
- Use role checking in frontend only (backend MUST validate)


---


## RULE #3.6: Assignable Roles for Task Assignment

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST use assignable_role for task filtering:**

‚ùå **NEVER:**
- Confuse system role (permissions) with assignable_role (task filtering)
- Use system role for task assignment
- Allow users with assignable_role: none to be assigned tasks
- Hardcode role names in task queries


---


## RULE #3.7: Password Complexity Requirements

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST validate password complexity:**

‚úÖ **MUST generate random password for OAuth users:**

‚ùå **NEVER:**
- Allow passwords shorter than 12 characters
- Allow passwords without uppercase, lowercase, digit, and special character
- Require OAuth users to set passwords (they don't use them)
- Store passwords in plain text (use bcrypt via has_secure_password)


---


## RULE #3.8: Timezone Options Limitation

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST use this exact list:**

‚úÖ **MUST use select with these options:**

‚ùå **NEVER:**
- Allow free-text timezone entry (validation nightmare)
- Show all 400+ IANA timezones (overwhelming, unnecessary)
- Use timezone abbreviations (AEST, AEDT - ambiguous)
- Default to UTC (construction companies operate in specific regions)


---


## RULE #3.9: Working Days UI - Sunday Default True

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST initialize with Sunday = true:**

‚úÖ **MUST show checkboxes for all 7 days:**

‚ùå **NEVER:**
- Hardcode Monday-Friday as only working days
- Hide Sunday checkbox (some companies DO work Sundays)
- Default all days to true (Saturday rarely worked)
- Prevent users from customizing working days


---


# Chapter 4: Contacts & Relationships

**Last Updated:** 2025-11-17 22:19 AEST

## RULE #4.1: Contact Types are Multi-Select Arrays

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Use `contact_types` as PostgreSQL array column
- Allow multiple types: `['customer', 'supplier']` for hybrid contacts
- Set `primary_contact_type` automatically if blank (first type in array)
- Validate types against `CONTACT_TYPES = ['customer', 'supplier', 'sales', 'land_agent']`
- Use array operations for querying: `where("'supplier' = ANY(contact_types)")`

‚ùå **NEVER:**
- Use single contact_type field (legacy pattern)
- Store types as comma-separated strings
- Assume a contact has only one type
- Query with `contact_type =` (use array containment instead)


---


## RULE #4.2: Bidirectional Relationships Require Reverse Sync

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Create reverse relationship after creating forward relationship
- Update reverse relationship when forward is updated
- Delete reverse relationship when forward is deleted
- Use Thread-local flags to prevent infinite recursion: `Thread.current[:creating_reverse_relationship]`
- Validate unique relationship pairs: `[source_contact_id, related_contact_id]`
- Prevent self-relationships: `source_contact_id != related_contact_id`

‚ùå **NEVER:**
- Create one-way relationships without reverse
- Allow circular reference loops during cascade updates
- Delete reverse relationship without checking Thread flag
- Allow duplicate relationships (same source + related pair)


---


## RULE #4.3: Xero Sync Uses Priority-Based Fuzzy Matching

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- **Priority 1:** Match by `xero_id` (exact match)
- **Priority 2:** Match by `tax_number` (normalized ABN/ACN, 11 digits)
- **Priority 3:** Match by `email` (case-insensitive exact match)
- **Priority 4:** Fuzzy match by `full_name` using FuzzyMatch gem (>85% similarity threshold)
- Rate limit: 1.2 second delay between Xero API calls (60 req/min limit)
- Log all sync activities with metadata to `ContactActivity`
- Set `last_synced_at` timestamp on successful sync
- Clear `xero_sync_error` on success, set on failure
- Respect `sync_with_xero` flag (skip if false)

‚ùå **NEVER:**
- Match only by name (too unreliable without fuzzy matching)
- Sync without rate limiting (will hit Xero API limits)
- Override manual `xero_id` links without confirmation
- Sync contacts with `sync_with_xero = false`
- Delete local contacts that don't exist in Xero


---


## RULE #4.4: Contact Deletion MUST Check Purchase Order Dependencies

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Check for linked suppliers via `contact.suppliers` association
- Check if suppliers have purchase orders: `suppliers.joins(:purchase_orders).distinct`
- Block deletion if ANY purchase orders exist
- Block deletion if ANY purchase orders have been paid or invoiced
- Return detailed error message listing suppliers and PO counts
- Allow deletion of contacts without supplier dependencies

‚ùå **NEVER:**
- Delete contacts with active supplier relationships that have POs
- Cascade delete purchase orders when deleting contact
- Allow deletion without checking payment/invoice status
- Delete last contact from a construction/job


---


## RULE #4.5: Contact Merge MUST Consolidate All Related Records

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Merge `contact_types` arrays (union, no duplicates)
- Fill missing info from source to target (email, phone, address, etc.)
- Keep best `rating` if both are suppliers (higher wins)
- Combine `notes` with merge trail: `"[Merged from Contact #123] original notes"`
- Update foreign keys for: `PricebookItem`, `PurchaseOrder`, `PriceHistory`
- Delete source contacts after successful merge
- Log activity with "contact_merged" type and metadata
- Return updated target contact

‚ùå **NEVER:**
- Overwrite target data with blank source data
- Merge without updating related records
- Delete source without logging activity
- Allow merge if validation fails on target


---


## RULE #4.6: Portal Users MUST Have Secure Password Requirements

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Minimum 12 characters
- At least one uppercase, lowercase, digit, and special character
- Lock account after 5 failed login attempts
- Lockout duration: 30 minutes
- Reset failed attempts counter on successful login
- Use `has_secure_password` with bcrypt
- Validate email uniqueness and `contact_id` uniqueness scoped to `portal_type`

‚ùå **NEVER:**
- Allow weak passwords (<12 chars or missing character types)
- Store passwords in plain text
- Allow unlimited login attempts
- Share portal accounts across contacts


---


## RULE #4.7: Primary Contact/Address/Person MUST Be Unique Per Contact

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Validate `is_primary` uniqueness scoped to `contact_id` in before_save callback
- Automatically unmark other primaries when setting new primary
- Use database index on `[contact_id, is_primary]` for performance
- Ensure at least one contact remains on construction (cannot delete last)

‚ùå **NEVER:**
- Allow multiple primary persons/addresses per contact
- Delete the only remaining contact from a construction
- Set `is_primary = true` without unmarking others


---


## RULE #4.8: Contact Activity Logging MUST Track All Significant Changes

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Log activity types: `created`, `updated`, `synced_from_xero`, `synced_to_xero`, `purchase_order_created`, `supplier_linked`, `contact_merged`
- Include `occurred_at` timestamp (required)
- Store structured metadata in JSONB column
- Use `ContactActivity.log_xero_sync` class method for Xero sync activities
- Combine with SMS messages in activity timeline endpoint

‚ùå **NEVER:**
- Skip logging for "minor" updates (all changes matter)
- Log without `occurred_at` timestamp
- Store sensitive data in metadata (passwords, tokens, etc.)
- Delete activity records (archive only for compliance)


---


# Chapter 5: Price Books & Suppliers

**Last Updated:** 2025-11-17 22:19 AEST

## RULE #5.1: Price Changes MUST Create Price History Automatically

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Use `after_update` callback to detect price changes
- Create PriceHistory with `old_price`, `new_price`, `change_reason`
- Set `price_last_updated_at` to current timestamp
- Track `changed_by_user_id` for audit trail
- Allow skipping via `skip_price_history_callback` flag when needed

‚ùå **NEVER:**
- Update `current_price` without creating history
- Skip price history for "small" price changes
- Delete price history records (archive only)
- Allow price updates without tracking who made the change


---


## RULE #5.2: Prevent Duplicate Price History - Unique Constraint + Time Window

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Use unique index: `(pricebook_item_id, supplier_id, new_price, created_at)`
- Add custom validation preventing entries within 5 seconds
- Handle race conditions gracefully (return existing record)
- Log duplicate attempts for monitoring

‚ùå **NEVER:**
- Rely only on application-level validation
- Allow duplicate price history from concurrent requests
- Fail hard on duplicate attempts (graceful degradation)


---


## RULE #5.3: SmartPoLookupService - 6-Strategy Cascading Fallback

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Execute strategies in priority order (most specific ‚Üí most general)
- Stop immediately on first match (don't continue searching)
- Track which strategy succeeded for analytics
- Collect warnings for all failed strategies

‚ùå **NEVER:**
- Skip intermediate strategies
- Continue searching after finding a match
- Return multiple matches (return best only)
- Fail if early strategies miss (cascade to less specific)


---


## RULE #5.4: Supplier Matching - Normalized Name Comparison with Business Suffix Removal

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Remove business entity types: "Pty Ltd", "Limited", "Inc", "Corporation", "Co"
- Remove location identifiers: "Australia", "Australian", "Qld", "Queensland"
- Remove organizational terms: "Group", "Services", "& Associates"
- Lowercase and remove special characters
- Use Levenshtein distance for similarity scoring

‚ùå **NEVER:**
- Match on raw supplier names without normalization
- Include business suffixes in similarity calculation
- Skip normalization for "exact" match detection
- Use case-sensitive comparison


---


## RULE #5.5: Price Volatility Detection - Coefficient of Variation on 6-Month Window

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Use rolling 6-month window of prices
- Calculate CV = (Standard Deviation / Mean) √ó 100
- Classify: stable (<5%), moderate (5-15%), volatile (>15%)
- Require minimum 3 data points for valid calculation
- Return 'unknown' for insufficient data

‚ùå **NEVER:**
- Use fixed time windows (calendar months/quarters)
- Calculate volatility on fewer than 3 price points
- Include prices older than 6 months
- Use absolute price change instead of percentage


---


## RULE #5.6: Risk Scoring - Multi-Factor Weighted Calculation (0-100 Scale)

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Calculate all 4 components independently
- Apply fixed weights (freshness=40%, reliability=20%, volatility=20%, missing=20%)
- Return score 0-100 with level: low/medium/high/critical
- Use database-level scoping for efficient filtering
- Cache calculation results for 1 hour

‚ùå **NEVER:**
- Change weights without updating all documentation
- Skip any of the 4 components
- Return risk score without risk level
- Calculate risk client-side (compute server-side)


---


## RULE #5.7: Bulk Updates - Transaction Wrapper with Price History Batch Creation

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Wrap all updates in `ActiveRecord::Base.transaction`
- Batch create price histories in single insert
- Rollback entirely on any validation error
- Return detailed success/failure report per item
- Use `skip_price_history_callback` to prevent duplicate history

‚ùå **NEVER:**
- Update items one-by-one without transaction
- Create price history one record at a time (N+1 performance issue)
- Continue processing after first error
- Commit partial updates


---


## RULE #5.8: OneDrive Image Proxy - Cache Control with 1-Hour Expiry

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Set `Cache-Control: public, max-age=3600` (1 hour)
- Store OneDrive `file_id` permanently (not URL)
- Refresh URL on each request via Microsoft Graph API
- Handle expired credentials gracefully (503 Service Unavailable)
- Return appropriate Content-Type from OneDrive metadata

‚ùå **NEVER:**
- Store OneDrive direct URLs (expire after 1 hour)
- Cache beyond 1 hour (OneDrive credential lifespan)
- Proxy without Cache-Control header
- Return errors for missing images (return 404 gracefully)


---


# Chapter 6: Jobs & Construction Management

**Last Updated:** 2025-11-17 22:19 AEST

## RULE #6.1: Construction MUST Have At Least One Contact

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Validate `must_have_at_least_one_contact` on update
- Allow creation without contacts (initial save)
- Require at least one contact before job can be used
- Show validation error if all contacts removed

‚ùå **NEVER:**
- Allow Construction to exist without contacts after initial creation
- Skip contact validation on updates
- Delete all contacts without replacement


---


## RULE #6.2: Live Profit Calculation - Dynamic Not Cached

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Calculate `live_profit = contract_value - sum(all_purchase_orders.total)`
- Recalculate `profit_percentage = (live_profit / contract_value) * 100`
- Use `calculate_live_profit` and `calculate_profit_percentage` methods
- Return calculated values in API responses

‚ùå **NEVER:**
- Store live_profit or profit_percentage in database
- Cache profit values (they change with every PO update)
- Use stale profit calculations


---


## RULE #6.3: Task Dependencies - No Circular References

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Validate `no_circular_dependencies` before saving TaskDependency
- Use graph traversal (BFS) to detect cycles
- Check entire predecessor chain for successor_task
- Reject dependency if circular reference detected

‚ùå **NEVER:**
- Allow Task A ‚Üí B ‚Üí C ‚Üí A chains
- Skip circular dependency validation
- Allow self-dependencies (task depending on itself)


---


## RULE #6.4: Task Status Transitions - Automatic Date Setting

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Set `actual_start_date = Date.current` when status ‚Üí `in_progress` (if nil)
- Set `actual_end_date = Date.current` when status ‚Üí `complete`
- Set `progress_percentage = 100` when status ‚Üí `complete`
- Use `before_save :update_actual_dates` callback

‚ùå **NEVER:**
- Allow `complete` status without actual_end_date
- Allow `in_progress` without actual_start_date
- Manually set these dates in controller


---


## RULE #6.5: Task Spawning - Status-Based Child Task Creation

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Spawn **subtasks** when parent status ‚Üí `in_progress`
- Spawn **photo task** when parent status ‚Üí `complete`
- Spawn **certificate task** when parent status ‚Üí `complete` (with cert_lag_days)
- Use `Schedule::TaskSpawner` service
- Set `spawned_type` field to identify task type
- Link via `parent_task_id`

‚ùå **NEVER:**
- Create photo/cert tasks manually
- Spawn tasks without checking schedule_template_row configuration
- Skip TaskSpawner service


---


## RULE #6.6: Schedule Cascade - Dependency-Based Date Propagation

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Use `ScheduleCascadeService` to recalculate dependent task dates
- Respect dependency types (FS/SS/FF/SF)
- Apply lag_days to calculations
- Skip manually_positioned tasks (user-set dates)
- Recursively cascade to downstream tasks
- Use company timezone and working days

‚ùå **NEVER:**
- Skip cascade when task dates change
- Ignore dependency types
- Override manually_positioned tasks
- Cascade to different projects


---


## RULE #6.7: OneDrive Folder Creation - Async with Status Tracking

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Use `CreateJobFoldersJob` background job
- Track status: `not_requested` ‚Üí `pending` ‚Üí `processing` ‚Üí `completed` / `failed`
- Use `onedrive_folder_creation_status` enum field
- Set `onedrive_folders_created_at` timestamp on completion
- Make idempotent (check if folders already exist)
- Use exponential backoff for retries

‚ùå **NEVER:**
- Create folders synchronously in controller
- Skip status tracking
- Create duplicate folders
- Fail silently without updating status


---


## RULE #6.8: Schedule Template Instantiation - All-or-Nothing Transaction

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Use `ActiveRecord::Base.transaction` for all template instantiation
- Rollback entire operation if any task fails to create
- Rollback if dependency creation fails
- Rollback if date calculation fails
- Return `{ success: true/false, errors: [] }` response

‚ùå **NEVER:**
- Create partial schedules (some tasks without others)
- Leave orphaned tasks if dependencies fail
- Continue after validation errors


---


# Chapter 7: Estimates & Quoting

**Last Updated:** 2025-11-17 22:19 AEST

## RULE #7.1: Fuzzy Job Matching - Three-Tier Confidence Thresholds

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Use Levenshtein distance + word matching + substring bonuses
- Auto-match at **‚â•70% confidence** (high certainty)
- Suggest candidates at **50-70% confidence** (ambiguous)
- Return no match at **<50% confidence** (low similarity)
- Set `matched_automatically: true` for auto-matches
- Store `match_confidence_score` for all matches

‚ùå **NEVER:**
- Auto-match below 70% confidence
- Skip confidence scoring
- Match without normalizing strings (lowercase, trim, remove special chars)
- Allow duplicate auto-matches


---


## RULE #7.2: External API Key Security - SHA256 Hashing Only

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Hash API keys with SHA256 before storage
- Validate incoming keys by hashing and comparing digests
- Store keys in `external_integrations` table
- Track usage with `last_used_at` timestamp
- Support key deactivation without deletion

‚ùå **NEVER:**
- Store plaintext API keys in database
- Log API keys in server logs
- Return API keys in API responses
- Use reversible encryption (one-way hash only)


---


## RULE #7.3: Estimate Import - Validate Before Auto-Matching

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Validate `job_name` is present and non-empty
- Validate `materials` array has at least 1 item
- Validate each material has: `category`, `item`, `quantity`
- Return 422 Unprocessable Entity for invalid data
- Log validation errors with request details

‚ùå **NEVER:**
- Attempt to match with missing job_name
- Create estimate with zero line items
- Skip validation on external API endpoint
- Create estimate with nil or zero quantities


---


## RULE #7.4: PO Generation from Estimate - Transaction Safety

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Wrap entire conversion in `ActiveRecord::Base.transaction`
- Rollback if any PO creation fails
- Rollback if any line item creation fails
- Rollback if supplier lookup fails critically
- Mark estimate as `imported` only on successful commit

‚ùå **NEVER:**
- Create partial POs (some categories succeed, others fail)
- Leave estimate in `matched` status if POs were created
- Continue after critical errors
- Create POs without line items


---


## RULE #7.5: AI Plan Review - Async Processing Required

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Enqueue `AiReviewJob` for all plan reviews
- Create `EstimateReview` record with `status: 'pending'` immediately
- Return review_id to client for polling
- Update status to `processing` ‚Üí `completed` / `failed`
- Set timeout of 5 minutes for Claude API call

‚ùå **NEVER:**
- Run plan review in synchronous HTTP request
- Block API response waiting for Claude
- Skip background job for "small" reviews
- Leave review in `processing` status indefinitely


---


## RULE #7.6: Line Item Categorization - Normalized Category Matching

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Normalize categories to lowercase before grouping
- Map common variations: "plumbing" = "plumber" = "plumb"
- Use category normalization service
- Handle nil/blank categories with "Uncategorized" group
- Store original category in line item, use normalized for matching

‚ùå **NEVER:**
- Group POs by case-sensitive categories ("Plumbing" ‚â† "plumbing")
- Skip category normalization in SmartPoLookupService
- Create separate POs for "Electrical" and "electrical"
- Fail import if category is missing


---


## RULE #7.7: Estimate Status State Machine - Strict Transitions

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Start at `pending` status on creation
- Transition to `matched` when linked to construction
- Transition to `imported` when POs generated
- Allow `rejected` from any state
- Prevent reverse transitions (no imported ‚Üí matched)

‚ùå **NEVER:**
- Skip `matched` status and go directly to `imported`
- Mark as `imported` before POs are created
- Change status back from `imported` to `pending`
- Allow PO generation from `pending` status


---


# Chapter 8: AI Plan Review

**Last Updated:** 2025-11-17 22:19 AEST

## RULE #8.1: Estimate Must Be Matched to Construction

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Validate `estimate.construction_id` is present before starting review
- Return 422 status with clear error message if not matched
- Show "Match to Job" button in UI if unmatched

‚ùå **NEVER:**
- Allow AI review on unmatched estimates
- Start review without construction context


---


## RULE #8.2: OneDrive Plan Folder Structure

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST search folders:**

‚ùå **NEVER:**
- Search entire OneDrive (security risk)
- Use different folder names without updating constant
- Skip folder validation


---


## RULE #8.3: PDF File Size Limit

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Check file size before download
- Skip files > 20MB
- Return error if NO valid PDFs found after filtering

‚ùå **NEVER:**
- Attempt to send files > 20MB to Claude API
- Download large files unnecessarily
- Proceed without plan documents


---


## RULE #8.4: Async Processing with Background Jobs

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Return 202 Accepted immediately with review_id
- Enqueue AiReviewJob with estimate_id
- Set initial status to 'pending', update to 'processing' in job
- Frontend MUST poll for status (every 5 seconds recommended)

‚ùå **NEVER:**
- Process review synchronously (causes request timeout)
- Block HTTP request waiting for Claude API response
- Assume review completes instantly


---


## RULE #8.5: Claude API Model and Prompt Structure

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Use exact model ID: `claude-3-5-sonnet-20241022`
- Send PDFs as base64-encoded documents with MIME type `application/pdf`
- Request JSON response format with specific schema
- Include estimate line items in prompt for comparison context
- Set max_tokens to 4096 minimum

‚ùå **NEVER:**
- Use older Claude models (lack PDF support)
- Send PDFs as text (loses formatting)
- Omit response format instructions
- Exceed token limits with oversized prompts


---


## RULE #8.6: Discrepancy Detection Logic

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST categorize as:**

‚úÖ **MUST use fuzzy matching:**
- Remove non-alphanumeric characters from item descriptions
- Case-insensitive comparison
- Match by category + description

‚ùå **NEVER:**
- Require exact string match (causes false negatives)
- Ignore category in matching (causes false positives)
- Use < 10% threshold for mismatches (too strict)


---


## RULE #8.7: Confidence Score Calculation

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST calculate:**

‚úÖ **MUST store:**
- `confidence_score` - Final score (0-100)
- `items_matched` - Count of matched items
- `items_mismatched` - Count of quantity mismatches
- `items_missing` - Count of missing items
- `items_extra` - Count of extra items

‚ùå **NEVER:**
- Return confidence > 100 or < 0
- Use equal penalty weights for all discrepancy types
- Skip confidence calculation


---


## RULE #8.8: Error Handling and Status Updates

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST handle errors:**
- `NoConstructionError` - Estimate not matched
- `OneDriveNotConnectedError` - OneDrive credential missing
- `PDFNotFoundError` - No valid PDFs in plan folders
- `FileTooLargeError` - All PDFs exceed 20MB limit
- `Anthropic::Error` - Claude API errors (rate limit, auth, etc.)
- `StandardError` - Generic catch-all

‚úÖ **MUST update review record:**

‚ùå **NEVER:**
- Leave review in 'processing' state on error (orphaned record)
- Expose sensitive error details to client
- Retry automatically without user intervention


---


## RULE #8.9: Prevent Duplicate Processing Reviews

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST check:**
- Query for existing review with `status: processing`
- Return 422 error if found
- Allow new review only if previous is completed/failed

‚ùå **NEVER:**
- Allow concurrent reviews on same estimate
- Overwrite existing processing review


---


# Chapter 9: Purchase Orders

**Last Updated:** 2025-11-17 22:19 AEST

## RULE #9.1: PO Number Generation - Race Condition Protection

‚ùå Never

‚ùå NEVER

‚ùå **NEVER generate PO numbers without lock**

‚úÖ **ALWAYS use `pg_advisory_xact_lock` in transaction**


---


## RULE #9.2: Status State Machine

‚ùå Never

‚ùå NEVER

‚ùå **NEVER skip status steps**

‚úÖ **ALWAYS validate transitions**


---


## RULE #9.3: Payment Status Calculation

‚ùå Never

‚ùå NEVER

‚ùå **NEVER set `payment_status` directly**

‚úÖ **ALWAYS use `determine_payment_status(amount)`**


---


## RULE #9.4: Smart Lookup - Supplier Selection Priority

‚ùå Never

‚ùå NEVER

‚ùå **NEVER randomly select supplier**

‚úÖ **ALWAYS use SmartPoLookupService priority cascade**


---


## RULE #9.5: Line Items - Totals Calculation

‚ùå Never

‚ùå NEVER

‚ùå **NEVER save PO without recalculating totals**

‚úÖ **ALWAYS use `before_save` callback**


---


## RULE #9.6: Schedule Task Linking

‚ùå Never

‚ùå NEVER

‚ùå **NEVER link without unlinking previous**

‚úÖ **ALWAYS use transaction for task linking**


---


## RULE #9.7: Price Drift Monitoring

‚ùå Never

‚ùå NEVER

‚ùå **NEVER ignore price drift**

‚úÖ **ALWAYS calculate drift percentage**


---


# Chapter 10: Gantt & Schedule Master

**Last Updated:** 2025-11-17 22:19 AEST

## RULE #10.1: Predecessor ID Conversion

‚ùå Never

‚ùå NEVER

‚ùå **NEVER use sequence_order directly in predecessor lookups**

‚úÖ **ALWAYS convert:** `predecessor_id = sequence_order + 1`


---


## RULE #10.10: Cascade Triggers

üìñ Rule

---


## RULE #10.11: Debounced Render Pattern

‚ùå Never

‚ùå NEVER

‚ùå **NEVER call gantt.render() directly**

‚úÖ **ALWAYS use debounced render:**


---


## RULE #10.12: Column Documentation - CC_UPDATE Table

‚ùå Never

‚ùå NEVER

‚ùå **NEVER change Schedule Master columns without updating CC_UPDATE table**

‚úÖ **ALWAYS update NewFeaturesTab.jsx when column implementation changes**


---


## RULE #10.2: isLoadingData Lock Timing

‚ùå Never

‚ùå NEVER

‚ùå **NEVER reset isLoadingData in drag handler**

‚úÖ **ALWAYS reset in useEffect with 1000ms timeout**


---


## RULE #10.3: Company Settings - Working Days & Timezone

‚ùå Never

‚ùå NEVER

‚ùå **NEVER hardcode working days or ignore company timezone**

‚úÖ **ALWAYS read from:** `company_settings.working_days` and `company_settings.timezone`


---


## RULE #10.4: Lock Hierarchy

‚ùå Never

‚ùå NEVER

‚ùå **NEVER cascade to locked tasks**

‚úÖ **ALWAYS check all 5 locks before cascade**


---


## RULE #10.5: Task Heights Configuration

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST set all three to same value:**

‚ùå **NEVER have mismatched height values**


---


## RULE #10.6: Auto-Scheduling

‚ùå Never

‚ùå NEVER

‚ùå **NEVER enable:** `gantt.config.auto_scheduling = true`

‚úÖ **ALWAYS set:** `gantt.config.auto_scheduling = false`


---


## RULE #10.7: API Pattern - Single Update + Cascade Response

‚ùå Never

‚ùå NEVER

‚ùå **NEVER make multiple API calls for cascade updates**

‚úÖ **ALWAYS use:** Single update + cascade response pattern


---


## RULE #10.8: useRef Anti-Loop Flags

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST use all 7 useRef flags correctly:**


---


## RULE #10.9: Predecessor Format

‚ùå Never

‚ùå NEVER

‚ùå **NEVER save without predecessor_ids**

‚úÖ **ALWAYS include predecessor_ids in every update**


---


# Chapter 11: Project Tasks & Checklists

**Last Updated:** 2025-11-17 22:19 AEST

## RULE #11.1: Task Status Lifecycle & Automatic Date Updates

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST update dates automatically:**

‚ùå **NEVER:**
- Allow status to skip lifecycle stages (not_started ‚Üí complete without in_progress)
- Overwrite existing actual dates when status changes again
- Leave progress_percentage < 100 when status is complete


---


## RULE #11.10: Duration Days Validation

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST validate:**

‚ùå **NEVER:**
- Allow duration_days = 0 (causes same-day start/end, confusing)
- Allow negative durations (logically impossible)
- Skip duration validation on updates
- Use decimal durations (always integer days)


---


## RULE #11.11: Tags System for Flexible Categorization

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST use GIN index for efficient queries:**

‚úÖ **MUST include tags in serialization:**

‚ùå **NEVER:**
- Store tags as comma-separated string (use JSONB array)
- Allow duplicate tags in array
- Skip GIN index (queries will be slow)
- Use tags for data that should be proper associations (e.g., don't tag "assigned_to_john", use assigned_to FK)


---


## RULE #11.2: Task Dependencies & Circular Dependency Prevention

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST validate:**

‚ùå **NEVER:**
- Allow task to depend on itself (self-dependency)
- Allow circular chains (A depends on B, B depends on C, C depends on A)
- Allow cross-project dependencies
- Allow duplicate dependencies (same predecessor + successor pair)


---


## RULE #11.3: Automatic Task Spawning from Templates

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST implement via TaskSpawner service:**

‚úÖ **MUST trigger spawning on status changes:**

‚ùå **NEVER:**
- Spawn tasks multiple times (check if already spawned)
- Spawn tasks without checking template configuration
- Create circular parent-child relationships
- Skip sequence ordering for subtasks (causes display chaos)


---


## RULE #11.4: Supervisor Checklist Template-to-Instance Flow

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST copy templates to instances during job instantiation:**

‚ùå **NEVER:**
- Share checklist items across tasks (each task gets own copies)
- Allow checklist item deletion after task starts
- Skip category validation (required for filtering)
- Store User FK for completed_by (store username string for flexibility)


---


## RULE #11.5: Response Type Validation & Photo Upload

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST validate before marking complete:**

‚úÖ **MUST use Cloudinary for photo storage:**

‚ùå **NEVER:**
- Allow completion without required response data
- Store photos in Rails backend (use Cloudinary)
- Skip folder organization in Cloudinary (use job-specific folders)
- Allow checklist item updates after completion (completed_at is immutable)


---


## RULE #11.6: Auto-Complete Predecessors Feature

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST implement via callback:**

‚úÖ **MUST show checkbox in task form:**

‚ùå **NEVER:**
- Auto-complete tasks with incomplete subtasks (check has_subtasks)
- Skip audit trail (add completion_notes explaining auto-completion)
- Allow infinite recursion (predecessors don't trigger their own predecessors)
- Auto-complete milestones (they should be explicitly completed)


---


## RULE #11.7: Materials Status Calculation

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST include in task serialization:**

‚úÖ **MUST show status badges:**

‚ùå **NEVER:**
- Store materials_status in database (always calculate)
- Show materials status for tasks without critical_po flag
- Allow task to start if materials_status = 'delayed' (warn user)
- Skip materials check during schedule cascade calculations


---


## RULE #11.8: Sequence Order for Task Display

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST set sequence on creation:**

‚úÖ **MUST index for efficient sorting:**

‚ùå **NEVER:**
- Use random sequence numbers (breaks visual grouping)
- Allow gaps larger than 1.0 between top-level tasks
- Use sequence > 9.9 for subtasks (use 9 or fewer subtasks per parent)
- Resort entire project when adding one task (use smart insertion)


---


## RULE #11.9: Task Update Audit Trail

üìñ Rule

---


# Chapter 12: Weather & Public Holidays

**Last Updated:** 2025-11-17 22:19 AEST

## RULE #12.1: Unique Holidays Per Region

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Validate uniqueness: `validates :date, uniqueness: { scope: :region }`
- Use region codes: QLD, NSW, VIC, SA, WA, TAS, NT, NZ
- Store date in UTC (no time component)

‚ùå **NEVER:**
- Allow duplicate holidays for same date + region
- Use inconsistent region codes
- Store holidays with time components


---


## RULE #12.2: Rain Log - One Entry Per Construction Per Day

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Enforce uniqueness at database level: `UNIQUE(construction_id, date)`
- Check for existing log before auto-creation
- Use `find_or_initialize_by` pattern for updates

‚ùå **NEVER:**
- Create multiple rain logs for same job + date
- Override existing automatic logs without checking source
- Allow future-dated rain logs


---


## RULE #12.3: Rainfall Severity Auto-Calculation

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST calculate severity as:**
- Light: `< 5mm`
- Moderate: `5mm to 15mm`
- Heavy: `> 15mm`

‚úÖ **MUST:**
- Auto-calculate on create if `rainfall_mm` present
- Recalculate on update if `rainfall_mm` changes
- Allow nil severity if `rainfall_mm` is nil or 0

‚ùå **NEVER:**
- Allow manual severity override without rainfall_mm
- Use different thresholds without updating constants
- Skip calculation for automatic entries


---


## RULE #12.4: Manual Rain Logs Require Notes

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Validate presence: `validates :notes, presence: true, if: :source_manual?`
- Display notes in UI for audit trail
- Include who created the entry (`created_by_user_id`)

‚ùå **NEVER:**
- Allow blank notes for manual entries
- Skip audit trail for manual modifications
- Allow automatic entries to have editable notes


---


## RULE #12.5: Weather API - Historical Data Only

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Validate date is not in future before API call
- Use `Date.yesterday` for automatic checks
- Raise `ArgumentError` if future date provided

‚ùå **NEVER:**
- Call weather API for today or future dates
- Use weather forecasts (not historical data)
- Proceed with API call if date validation fails


---


## RULE #12.6: Location Extraction Priority

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST follow priority:**

‚ùå **NEVER:**
- Use random location extraction order
- Fail silently if location cannot be determined
- Use company address as fallback (wrong location)


---


## RULE #12.7: Gantt Integration - Working Day Calculation

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Load company `working_days` configuration
- Load `PublicHoliday` dates for relevant region (3-year range)
- Skip task to next working day if lands on weekend OR holiday
- Respect lock hierarchy (locked tasks can stay on holidays)

‚ùå **NEVER:**
- Check only weekends without holidays
- Check only holidays without weekends
- Override locked task dates
- Use different holiday lookups across services


---


## RULE #12.8: Weather API Response Storage

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Store complete API JSON response
- Include location confirmation data
- Preserve all weather metrics (temp, condition, etc.)
- Use for future analysis and verification

‚ùå **NEVER:**
- Store only rainfall value
- Discard API response after extraction
- Modify API response before storage


---


# Chapter 13: OneDrive Integration

**Last Updated:** 2025-11-17 22:19 AEST

## RULE #13.1: Organization-Wide Authentication

‚ùå Never

‚ùå NEVER

‚ùå **NEVER require each user to authenticate separately**

‚úÖ **ALWAYS store single credential for entire organization**


---


## RULE #13.2: Folder Template System

‚ùå Never

‚ùå NEVER

‚ùå **NEVER hardcode folder names**

‚úÖ **ALWAYS respect template customizations**


---


## RULE #13.3: Root Folder Management

‚ùå Never

‚ùå NEVER

‚ùå **NEVER create folders at OneDrive root level**

‚úÖ **ALWAYS use `root_folder_id` from credential**


---


## RULE #13.4: Pricebook Image Sync

‚ùå Never

‚ùå NEVER

‚ùå **NEVER rely solely on OneDrive for image display**

‚úÖ **ALWAYS upload to Cloudinary after OneDrive upload**


---


## RULE #13.5: File Upload Chunking

‚ùå Never

‚ùå NEVER

‚ùå **NEVER use simple upload for files >4MB**

‚úÖ **ALWAYS use resumable upload session**


---


# Chapter 14: Outlook/Email Integration

**Last Updated:** 2025-11-17 22:19 AEST

## RULE #14.1: Organization-Wide Singleton OAuth Credential

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST implement as singleton:**

‚úÖ **MUST auto-refresh tokens before expiration:**

‚ùå **NEVER:**
- Store multiple Outlook credentials (one organization = one credential)
- Store tokens unencrypted
- Let tokens expire without auto-refresh
- Hardcode token expiration buffer (always use 5-minute safety margin)


---


## RULE #14.2: Four-Strategy Email-to-Job Matching

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST implement all 4 strategies:**

‚úÖ **MUST auto-assign on email creation:**

‚ùå **NEVER:**
- Skip matching strategies (must try all 4 in order)
- Match to inactive/archived jobs
- Auto-assign to wrong construction (false positive worse than nil)
- Allow email creation without attempting match


---


## RULE #14.3: Microsoft Graph API Usage Pattern

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST use Graph API v1.0:**

‚úÖ **MUST request these scopes:**

‚ùå **NEVER:**
- Use Outlook REST API v2.0 (deprecated, use Graph API)
- Request more scopes than needed (principle of least privilege)
- Skip $select parameter (bandwidth waste - emails can be large)
- Use synchronous API calls without pagination


---


## RULE #14.4: Email Threading Support via Message-ID

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST include threading fields:**

‚úÖ **MUST populate threading fields:**

‚ùå **NEVER:**
- Allow duplicate message_id (unique constraint required)
- Skip message_id extraction (breaks threading)
- Store references as array (use text with space-separated values per RFC 2822)


---


## RULE #14.5: Webhook Support for Email Services

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST implement webhook receiver:**

‚ùå **NEVER:**
- Return error status for webhook (email providers will retry, causing duplicates)
- Skip duplicate detection (check message_id uniqueness)
- Process webhook synchronously (use background job for heavy parsing)


---


## RULE #14.6: Inbound-Only Architecture (Current Limitation)

üìñ Rule

---


# Chapter 15: Chat & Communications

**Last Updated:** 2025-11-17 22:19 AEST

## RULE #15.1: ChatMessage Multi-Channel Architecture

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST define channel types:**

‚úÖ **MUST route messages correctly:**


---


## RULE #15.10: Authentication Placeholder - CRITICAL TODO

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST implement proper authentication:**

‚ùå **NEVER use in production:**
- `User.first` placeholder
- Hardcoded user IDs
- Session-less chat without auth


---


## RULE #15.2: Message-to-Job Linking

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST provide save-to-job endpoints:**

‚úÖ **MUST include construction_id foreign key:**

‚úÖ **MUST allow bulk conversation saving:**


---


## RULE #15.3: SMS Twilio Integration

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST centralize Twilio operations:**

‚úÖ **MUST handle incoming SMS webhooks:**

‚úÖ **MUST support Australian phone formats:**


---


## RULE #15.4: SMS Status Tracking

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST define status states:**

‚úÖ **MUST accept Twilio status webhooks:**

‚úÖ **MUST show status icons:**


---


## RULE #15.5: Unread Message Tracking

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST add read timestamp:**

‚úÖ **MUST provide unread count endpoint:**

‚úÖ **MUST poll for unread count:**


---


## RULE #15.6: Message Polling (No WebSockets)

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST poll at 3-second intervals:**

‚úÖ **MUST poll SMS messages:**

‚ùå **NEVER use WebSockets:**
- WebSocket infrastructure not implemented
- ActionCable not configured
- All real-time updates via polling


---


## RULE #15.7: Contact-SMS Fuzzy Matching

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST support partial phone matches:**


---


## RULE #15.8: Message Deletion Authorization

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST verify ownership:**

‚ùå **NEVER allow:**
- Admins deleting other users' messages (not implemented)
- Bulk message deletion without ownership check
- Deletion of messages saved to jobs without audit trail


---


## RULE #15.9: Email Ingestion Storage

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST store email metadata:**

‚úÖ **MUST include fields:**


---


# Chapter 16: Xero Accounting Integration

**Last Updated:** 2025-11-17 22:19 AEST

## RULE #16.1: OAuth Token Management

‚ùå Never

‚ùå NEVER

‚ùå **NEVER store API keys in plaintext**

‚úÖ **ALWAYS encrypt tokens using ActiveRecord Encryption**


---


## RULE #16.2: Two-Way Contact Sync

‚ùå Never

‚ùå NEVER

‚ùå **NEVER assume single-direction sync**

‚úÖ **ALWAYS check `sync_with_xero` flag before syncing**

‚úÖ **ALWAYS update `last_synced_at` timestamp**


---


## RULE #16.3: Invoice Matching

‚ùå Never

‚ùå NEVER

‚ùå **NEVER sync payments without invoice match**

‚úÖ **ALWAYS validate invoice total vs PO total**

‚úÖ **ALWAYS store `xero_invoice_id` on PurchaseOrder**


---


## RULE #16.4: Webhook Signature Verification

‚ùå Never

‚ùå NEVER

‚ùå **NEVER process webhooks without signature verification**

‚úÖ **ALWAYS use `XERO_WEBHOOK_KEY` from environment**


---


## RULE #16.5: Rate Limiting & Error Handling

‚ùå Never

‚ùå NEVER

‚ùå **NEVER retry immediately on 429 errors**

‚úÖ **ALWAYS implement exponential backoff**

‚úÖ **ALWAYS log failed requests for debugging**


---


## RULE #16.6: Tax Rates & Chart of Accounts

‚ùå Never

‚ùå NEVER

‚ùå **NEVER hardcode tax codes**

‚úÖ **ALWAYS fetch from Xero and cache locally**


---


## RULE #16.7: Background Job Processing

‚ùå Never

‚ùå NEVER

‚ùå **NEVER sync contacts in HTTP request**

‚úÖ **ALWAYS use `XeroContactSyncJob` via Solid Queue**

‚úÖ **ALWAYS provide job progress tracking**


---


## RULE #16.8: Payment Sync Workflow

‚ùå Never

‚ùå NEVER

‚ùå **NEVER create Xero payment before local Payment record**

‚úÖ **ALWAYS link Payment to PurchaseOrder**


---


# Chapter 17: Payments & Financials

**Last Updated:** 2025-11-17 22:19 AEST

## RULE #17.1: Payment Model Structure

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST include core fields:**

‚úÖ **MUST use DECIMAL(15,2) for precision:**


---


## RULE #17.10: Cascade Delete Payments

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST set dependent: :destroy:**

‚ùå **NEVER orphan payments:**
- Deleting PO without deleting payments breaks referential integrity
- Payment without PO is meaningless
- Use `dependent: :destroy` not `dependent: :nullify`


---


## RULE #17.2: Automatic Payment Status Updates

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST trigger on payment save/destroy:**

‚úÖ **MUST define payment status states:**


---


## RULE #17.3: Xero Invoice Fuzzy Matching

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST implement matching hierarchy:**

‚úÖ **MUST update PO with invoice data:**


---


## RULE #17.4: Xero Payment Sync

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST validate and sync:**


---


## RULE #17.5: Payment Method Enum

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST restrict to valid methods:**

‚úÖ **MUST provide method selector:**


---


## RULE #17.6: Financial Precision with DECIMAL(15,2)

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST use DECIMAL type:**

‚úÖ **MUST validate precision:**

‚ùå **NEVER use FLOAT:**
- Causes rounding errors in currency calculations
- Example: `0.1 + 0.2 = 0.30000000000000004` (FLOAT)
- DECIMAL: `0.10 + 0.20 = 0.30` (exact)


---


## RULE #17.7: Payment Status Badge Display

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST use semantic colors:**


---


## RULE #17.8: Payment Summary Calculation

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST include summary:**

‚úÖ **MUST show summary prominently:**


---


## RULE #17.9: Budget Variance Tracking

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST calculate variances:**

‚úÖ **MUST highlight overages:**


---


# Chapter 18: Workflows & Automation

**Last Updated:** 2025-11-17 22:19 AEST

## RULE #18.1: Solid Queue Background Job System

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST configure Solid Queue:**

‚úÖ **MUST inherit from ApplicationJob:**


---


## RULE #18.2: Workflow State Machine

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST implement state machine:**

‚úÖ **MUST auto-advance on step completion:**


---


## RULE #18.3: Idempotent Background Jobs

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST check completion status:**

‚úÖ **MUST verify record doesn't exist:**


---


## RULE #18.4: Price Update Automation

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST implement price application:**


---


## RULE #18.5: Model Callback Automation

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST update dependent data:**

‚úÖ **MUST trigger child creation:**

‚úÖ **MUST track changes:**


---


## RULE #18.6: Job Status Tracking

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST provide status visibility:**

‚úÖ **MUST show percentage:**


---


## RULE #18.7: Batch Processing with Rate Limiting

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST batch and throttle:**


---


## RULE #18.8: Workflow Metadata Storage

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST support all workflow types:**

‚úÖ **MUST collect metadata:**


---


# Chapter 19: Custom Tables & Formulas

**Last Updated:** 2025-11-17 22:19 AEST

## RULE #19.1: Dynamic Table Creation Pattern

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST use auto-generated unique name:**

‚úÖ **MUST create ActiveRecord model at runtime:**

‚ùå **NEVER:**
- Use table names without prefix
- Allow reserved names: `["user", "users", "table", "tables", "column", "columns", "record", "records"]`
- Reuse database_table_name across tables


---


## RULE #19.2: Column Type System

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST map column types correctly:**

‚úÖ **MUST use TableBuilder for physical schema changes:**


---


## RULE #19.3: Formula Evaluation System

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST support curly brace references:**

‚úÖ **MUST evaluate formulas safely:**

‚úÖ **MUST flag columns with cross-table refs:**


---


## RULE #19.4: Lookup Column Pattern

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST create associations dynamically:**

‚úÖ **MUST batch-load related records:**

‚úÖ **MUST return id + display value:**


---


## RULE #19.5: Record CRUD with Formula Calculation

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST calculate formulas on save:**

‚úÖ **MUST transform computed values on read:**


---


## RULE #19.6: Table Deletion Safety

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST validate before deletion:**

‚úÖ **MUST drop database table:**


---


## RULE #19.7: Column Validation Rules

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST enforce validation rules:**

‚úÖ **MUST validate record data before save:**


---


## RULE #19.8: Foreign Key Constraints

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST add foreign keys for lookups:**

‚ùå **NEVER use on_delete: :cascade** for lookup columns (data loss risk)


---


# Chapter 20: UI/UX Standards & Patterns

**Last Updated:** 2025-11-17 22:19 AEST

## RULE #20.1: Checkbox Column Must Be First, Locked, Minimal Size

‚úÖ Must

The first column MUST be a checkbox for row selection with locked position and minimal size.

Width: 32px (minimal size to fit checkbox). Padding: px-1 (minimal horizontal padding). Non-resizable (locked size). Non-reorderable (always first). Centered alignment (header and cells).


## RULE #20.10: Column Visibility Standards

‚úÖ Must

‚úÖ MUST


---


## RULE #20.11: Search & Filter UI Standards

‚úÖ Must

‚úÖ MUST


---


## RULE #20.12: Empty States

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST differentiate:**


---


## RULE #20.13: State Persistence Standards

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST persist to localStorage:**

‚ùå **NEVER:**
- Use generic keys (collision risk)
- Persist without try/catch
- Forget defaults


---


## RULE #20.14: Sorting Standards

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST support:**
- Primary/secondary sort
- 3-state cycle: asc ‚Üí desc ‚Üí none


---


## RULE #20.15: Dark Mode Requirements

‚ùå Never

‚ùå NEVER

‚ùå **NEVER:**
- Use light-mode-only colors
- Use pure white/black (use gray-50/gray-900)


---


## RULE #20.16: Performance Standards

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST memoize when:**
- Filtering large datasets (>100 rows)
- Sorting complex data
- Computing derived values

‚ùå **NEVER:**
- Filter/sort without memoization
- Create inline functions in map()


---


## RULE #20.17: Accessibility Standards

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST support:**
- Tab through interactive elements
- Enter/Space to trigger actions
- `scope="col"` on `<th>` elements
- `aria-label` on icon-only buttons
- Semantic HTML (`<table>`, `<thead>`, `<tbody>`)
- `sr-only` text for icons


---


## RULE #20.18: Table Container Must Have Visible Borders On All Sides

‚úÖ Must

Table container MUST have visible borders on all four sides (top, right, bottom, left).

Full border on all four sides of table container. Border color: gray-200 (dark: gray-700). Horizontal margin (mx-4) to align with search bar above. Borders frame the entire table content including top and bottom. Creates a complete bordered box around the table.


## RULE #20.19: Native Browser Scrollbars Styled With Blue Theme

‚úÖ Must

Native browser scrollbars MUST be styled with blue theme matching the header color.

Light mode: Track #E0E7FF (light blue), Thumb #2563EB (blue-600 matching header), Hover #1D4ED8. Dark mode: Track #1E293B (dark slate), Thumb #1E40AF (blue-800), Hover #1E3A8A. Removed sticky horizontal scrollbar due to duplicate display issue.


## RULE #20.2: Table Header Requirements

‚úÖ Must

‚úÖ MUST


---


## RULE #20.20: Search Functionality Standards

‚úÖ Must

‚úÖ MUST


---


## RULE #20.21: Form Standards

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST include for all inputs:**
- Label with `htmlFor` matching input `id`
- Dark mode styling
- Focus states (indigo ring)
- Error state styling


---


## RULE #20.22: Table headers MUST provide visual cursor feedback

‚úÖ Must

All interactive table header elements must display appropriate cursor styles to indicate their functionality.

Column headers that support resizing must show col-resize cursor. Drag handles (three-dot icons) must show grab cursor when hovering and grabbing when dragging. Sortable headers must show pointer cursor.


## RULE #20.23: Table headers and content MUST use differentiated font sizes

‚úÖ Must

Table headers must use 18px bold font. Table rows must use 14px regular font. Both must use system font stack for native appearance.

Header font: 18px bold weight for visual hierarchy and emphasis. Row font: 14px regular weight for optimal data density and readability. Font family must use system font stack: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica Neue, Arial, sans-serif. Apply styles inline for maximum specificity.


## RULE #20.24: Loading State Standards

‚úÖ Must

‚úÖ MUST


---


## RULE #20.25: Content and Title columns MUST be clickable to view full details

‚úÖ Must

Only the Content and Title columns should open a modal when clicked. Other columns (Type, Chapter, Section, Status, Severity, Actions, Select) must not trigger the modal.

Modal opens ONLY when clicking Content or Title cells - these are the columns with truncated data. Click handlers with stopPropagation prevent modal on other columns. Cursor pointer only appears on Content and Title columns. Select column checkboxes and Action buttons remain functional without opening modal.


## RULE #20.26: Status Badge Standards

‚úÖ Must

‚úÖ MUST


---


## RULE #20.27: Empty State Standards

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST differentiate:**


---


## RULE #20.28: Navigation Standards

‚úÖ Must

‚úÖ MUST


---


## RULE #20.29: Chapter 19 Documentation Maintenance (REQUIRED)

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST update Chapter 19 when:**
- Adding new table features
- Modifying existing table patterns
- Creating new components
- Changing standard UI patterns
- Adding new requirements
- Discovering missing features

‚ùå **NEVER:**
- Make table changes without updating Chapter 19
- Create custom patterns not documented
- Skip timestamp update
- Forget to commit Bible with code


---


## RULE #20.3: Column Search/Filter Requirements (REQUIRED)

‚úÖ Must

‚úÖ MUST


---


## RULE #20.30: Touch Target Sizes & Click Areas

‚ùå Never

‚ùå NEVER

‚ùå **NEVER:**
- Create interactive elements < 44px without compensating padding
- Place elements closer than 8px
- Assume mouse users only


---


## RULE #20.31: Data-Dense Table Layout Pattern

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST use compact layout for data-heavy tables:**
- Compact padding on rows and headers
- Cell truncation with hover tooltips
- Row expansion for full content

‚ùå **NEVER:**
- Use spacious padding (`py-6`) for data-dense tables
- Skip expansion mechanism for truncated content


---


## RULE #20.32: Zebra Striping (Alternating Row Colors)

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST use zebra striping for wide tables (> 7 columns):**
- Alternating row colors for horizontal tracking
- Sufficient contrast in both light and dark modes
- Maintain pattern when filtering/sorting

‚ùå **NEVER:**
- Use too subtle colors (insufficient contrast)
- Remove zebra on hover (both should be visible)
- Use zebra on narrow tables (< 5 columns)


---


## RULE #20.33: Sticky Horizontal Scrollbar Pattern

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST ALWAYS:**

1. **MUST use ref flags** to prevent infinite scroll loops:
   - `isScrollingStickyRef` - Set when sticky scrollbar scrolls
   - `isScrollingMainRef` - Set when main container scrolls
   - Check flags at start of handlers and return early if set

2. **MUST hide native horizontal scrollbar** when using custom sticky scrollbar:
   [Code example - see code_example field]
   [Code example - see code_example field]

3. **MUST measure actual table element** for scrollbar width:
   [Code example - see code_example field]

4. **MUST position sticky scrollbar** with `position: sticky` and `bottom: 0`

5. **MUST use ResizeObserver** to update scrollbar on column resize

‚ùå **NEVER:**

1. **NEVER use placeholder values** in scroll loop - causes infinite loops
2. **NEVER measure container scrollWidth** - use actual table offsetWidth instead
3. **NEVER use overflow-x-hidden** on main container - breaks horizontal scrolling
4. **NEVER forget to sync scrollLeft** in both directions (main ‚Üî sticky)

üìã **Implementation Checklist:**

- [ ] Scroll loop prevention refs created (`isScrollingStickyRef`, `isScrollingMainRef`)
- [ ] Main scroll handler syncs to sticky scrollbar
- [ ] Sticky scroll handler syncs to main container
- [ ] ResizeObserver updates scrollbar width on changes
- [ ] Native horizontal scrollbar hidden (CSS + inline styles)
- [ ] Sticky scrollbar positioned with `position: sticky, bottom: 0`
- [ ] Table has `minWidth` based on sum of column widths
- [ ] Default column widths ensure horizontal overflow on most screens


## RULE #20.34: Modern Table Header Aesthetics

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST apply glass-morphism effect to table headers:**
- Semi-transparent background with backdrop blur
- Subtle shadow and borders
- Small font size with medium weight
- Subtle colors in light and dark modes

‚ùå **NEVER:**
- Use solid opaque backgrounds (loses modern effect)
- Use heavy font weights (`font-bold`, `font-semibold`)
- Use bright or saturated header colors


---


## RULE #20.35: Table Border Framing

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST add complete border framing for full-width tables:**
- Left and right borders on `<table>` element
- Consistent border colors in light and dark modes
- Provides visual container boundary

‚ùå **NEVER:**
- Skip borders on full-width tables
- Use incomplete framing (border-b or border-t only)
- Apply borders to container div instead of table element


---


## RULE #20.36: Expand/Collapse Row Details Pattern

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST implement for tables with detailed content:**
- Expand icon with click entire row to toggle
- Expanded row spans all columns with visual separation
- Use `Set` for tracking expansion state (performance)
- Properly formatted content in expanded view

‚ùå **NEVER:**
- Make only icon clickable (bad UX)
- Use array for expandedRows (slow lookup)
- Skip colSpan (content constrained to first column)
- Forget click event propagation on nested elements


---


## RULE #20.37: Column Visibility Toggle (REQUIRED)

‚ùå Never

‚ùå NEVER

‚ùå **NEVER:**
- Allow hiding ALL columns
- Hide actions column
- Forget localStorage persistence


---


## RULE #20.38: Cascading Filter Pattern

‚úÖ Must

‚úÖ **MUST use cascading filters for multi-level hierarchical data:**

**When to Use:**
- Tables with 2+ filterable dimensions (Chapter ‚Üí Type, Category ‚Üí Subcategory, etc.)
- Data has clear parent-child relationships
- Filtering one dimension narrows options in dependent dimensions

**How Cascading Works:**
- Filters go **left-to-right** (broader ‚Üí narrower)
- Parent filter (left) affects child filter options (right)
- Changing parent filter resets child filters to "All"
- Show dynamic counts: "MUST (18)", "NEVER (5)", "PROTECTED (0)"
- Disable options with 0 count

**Filter Hierarchy Example:**
```
Chapter (Level 1) ‚Üí Type (Level 2) ‚Üí Status (Level 3)
    ‚Üì                    ‚Üì                 ‚Üì
  Affects            Affects           [End]
  Type options       Status options
```

‚ùå **NEVER:**
- Use bidirectional cascading (Chapter ‚Üê ‚Üí Type = circular dependency)
- Skip memoization (causes performance issues)
- Forget to reset downstream filters when upstream changes
- Make filters cascade backwards (right-to-left)


**Example (BibleTableView):**
- User selects "Chapter 9" ‚Üí Type filter shows: MUST (18), NEVER (5), PROTECTED (0 - disabled)
- User selects "MUST" ‚Üí Shows only 18 Chapter 9 MUST rules
- User changes to "Chapter 19" ‚Üí Type resets to "All", recalculates for Ch 19


## RULE #20.39: Column Width Persistence (REQUIRED)

‚úÖ Must

‚úÖ MUST


---


## RULE #20.4: Column Resizing Standards

‚úÖ Must

‚úÖ MUST


---


## RULE #20.40: Table Toolbar Layout Standards (REQUIRED)

‚ùå Never

‚ùå NEVER

‚ùå **NEVER:**
- Put search on right side
- Use different button heights
- Stack toolbar vertically
- Add gap between search and first button


---


## RULE #20.41: All Custom Action Buttons MUST Use h-[42px] Alignment

üîÑ Always

ALL custom action buttons in Trinity tables (Add, Import, Export, Sync, etc.) MUST use h-[42px] for perfect toolbar alignment with search bar and Columns button


## RULE #20.42: No Actions Column - Use Inline Bulk Actions Instead

‚ùå Never

‚ùå NEVER

‚ùå **NEVER:**
- Add an Actions column to tables with Edit/Delete buttons per row
- Place action buttons in the rightmost column
- Duplicate edit/delete functionality in both row actions and bulk actions
- Show Delete button immediately when rows are selected

‚úÖ **ALWAYS:**
- Use inline bulk action buttons that appear when rows are selected
- Position bulk actions next to Columns button (h-[42px] alignment)
- Implement Delete-after-Edit safety pattern
- Hide Delete button until Edit is clicked first

**Rationale:**
- Cleaner table layout without extra column
- Prevents accidental deletions (safety pattern)
- Encourages batch operations over individual row actions
- Consistent button height alignment (h-[42px])

**Reference:** TrinityTableView.jsx removed Actions column, added inline bulk buttons


## RULE #20.5: Column Reordering Standards

‚ùå Never

‚ùå NEVER

‚ùå **NEVER:**
- Put entire header in one onClick handler
- Make drag handle sortable
- Forget `e.stopPropagation()` on drag handle


---


## RULE #20.6: Scroll Behavior Standards

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST implement for scrollable tables:**
- Use `flex` layout with `flex-1 min-h-0 flex flex-col` on container
- Scrollable area: `overflow-y-scroll overflow-x-auto`
- Sync horizontal scroll between main container and sticky scrollbar via refs
- Track scrollWidth with `ResizeObserver` for dynamic updates
- Custom scrollbar styling via webkit pseudo-elements
- Thin scrollbars: `scrollbar-width: thin` for Firefox

‚ùå **NEVER:**
- Use `overflow: hidden` on flex containers (prevents scrolling)
- Forget `min-h-0` on flex children (causes overflow issues)
- Skip scroll sync between container and sticky scrollbar
- Use inline scroll handlers without refs (performance issue)


---


## RULE #20.7: Column Width Standards

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST set widths consistently:**
- `<th>`: `style={{ width: `${width}px`, minWidth: `${width}px` }}`
- `<td>`: `style={{ width: `${width}px`, minWidth: `${width}px`, maxWidth: `${width}px` }}`


---


## RULE #20.8: Cell Content Standards

‚úÖ Must

‚úÖ MUST


---


## RULE #20.9: Row Interaction Standards

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST implement:**
- Selection column minimum width: 50px (never smaller)
- Selection column always visible (exclude from visibility toggles)
- Selection column excluded from column reordering (always leftmost)

‚ùå **NEVER:**
- Add explicit size classes to checkboxes (`h-4 w-4` OK, but browser default preferred)
- Make selection column draggable
- Include selection column in columnOrder state
- Allow selection column to be hidden via visibility toggles
- Allow selection column to be reordered (must stay leftmost)


---


# Chapter 21: Agent System & Automation

**Last Updated:** 2025-11-17 22:19 AEST

## RULE #21.1: Agent Definitions Are Database-Driven

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Store all agent metadata in database
- Update run history after each agent execution
- Use API endpoints to manage agents
- Track success/failure rates
- Maintain agent priority order

‚ùå **NEVER:**
- Hardcode agent configurations in code
- Skip recording agent runs
- Modify `.claude/agents/*.md` files without updating database
- Create agents without database entries


---


## RULE #21.10: Production Bug Hunter Agent

üìö Reference

**Triggers:** /bug-hunter, bug hunter

**What it does:**
1. Checks Heroku production logs for errors and exceptions
2. Searches Lexicon for similar bugs previously encountered
3. Identifies root cause by analyzing stack traces
4. Reproduces bug locally if possible
5. Implements fix following Bible rules and patterns
6. Runs diagnostic tests to verify fix works
7. Documents bug and solution in Lexicon with bug_fix entry
8. Provides deployment recommendation


## RULE #21.11: Planning Collaborator Agent

üìö Reference

**Triggers:** /plan, planning

**What it does:**
1. Analyzes feature request and breaks down into tasks
2. Reads relevant Bible chapters for architecture guidance
3. Searches Lexicon for similar features and patterns
4. Identifies affected components (backend/frontend/database)
5. Creates step-by-step implementation plan
6. Estimates complexity and potential challenges
7. Provides recommendations for testing strategy
8. Suggests Bible chapter updates if new patterns emerge


## RULE #21.12: Trinity Sync Validator Agent

üìö Reference

**Triggers:** /trinity, trinity sync

**What it does:**
1. Compares Trinity Bible database records vs markdown files
2. Checks Lexicon database vs markdown file consistency
3. Identifies missing, duplicate, or outdated entries
4. Validates chapter numbers and entry_types are correct
5. Checks for orphaned records in database
6. Runs export_bible and export_lexicon if needed
7. Reports sync status and any discrepancies found


## RULE #21.13: Backend Developer Agent

üìö Reference

**Triggers:** /backend, backend dev

**What it does:**
1. Reads Trinity Bible chapters for backend architecture rules
2. Searches Lexicon for known backend bugs and API patterns
3. Analyzes Rails controllers, models, and database migrations
4. Implements API endpoints following RESTful conventions
5. Runs backend tests (RSpec) and fixes any failures
6. Updates database schema and handles migrations
7. Documents changes in Lexicon with dev_note entries


## RULE #21.14: Run All Agents in Parallel

üìö Reference

**Triggers:** /all-agents, /ag

**What it does:**
Launches Backend Developer, Frontend Developer, Production Bug Hunter, Gantt Bug Hunter, Deploy Manager, Planning Collaborator, Trinity Sync Validator, and UI Compliance Auditor **simultaneously**.

Each agent runs independently and reports back with their findings. Use this for comprehensive project health checks and multi-area debugging.


## RULE #21.15: UI Compliance Auditor Agent

üìö Reference

**Triggers:** /ui-audit, ui compliance

**What it does:**
1. Reads Trinity Bible Chapter 20 (UI/UX Standards & Patterns rules)
2. Reads Trinity Lexicon Chapter 20 (known UI/UX bugs and issues)
3. Reads Trinity Teacher Chapter 20 (UI/UX implementation examples)
4. Analyzes all Chapter 20 requirements across all three Trinity books
5. Scans all React components in frontend/src/pages and /components
6. Checks for standard table component usage and clear buttons
7. Identifies violations, missing features, and non-compliant patterns
8. Creates comprehensive TodoWrite list with specific actionable tasks
9. Prioritizes tasks by severity (critical, high, medium, low)
10. Provides step-by-step fix instructions for each violation
11. Generates detailed compliance report with before/after examples
12. Documents findings in Lexicon for future reference


## RULE #21.16: Frontend Developer Agent

üìö Reference

**Triggers:** /frontend, frontend dev

**What it does:**
1. Reads Trinity Bible RULE #19 (Table Pattern) and UI chapters
2. Searches Lexicon for frontend component patterns and known UI bugs
3. Analyzes React components and identifies compliance issues
4. Implements/updates components following Table Pattern rules
5. Ensures dark mode support and responsive design
6. Runs npm build and fixes any ESLint/TypeScript errors
7. Documents component changes and patterns in Lexicon


## RULE #21.17: Deploy Manager Agent

üìö Reference

**Triggers:** /deploy, deployment

**What it does:**
1. Runs full test suite (backend + frontend) to ensure stability
2. Checks git status and creates clean commit if needed
3. Uses git subtree to split backend directory for Heroku
4. Pushes to Heroku with force flag to deploy backend
5. Monitors Heroku logs during deployment
6. Runs database migrations on production if needed
7. Verifies deployment health with API health checks
8. Reports deployment status and any issues encountered


## RULE #21.18: Gantt Bug Hunter Agent

üìö Reference

**Triggers:** /gantt, gantt bug hunter

**What it does:**
1. Reads Trinity Bible Chapter 7 (Gantt Chart rules)
2. Searches Lexicon for Gantt-specific bugs and patterns
3. Tests drag-and-drop functionality and cascade events
4. Validates timezone handling (Brisbane/Australia/Brisbane)
5. Checks working days enforcement and public holidays
6. Tests lock state and concurrent editing scenarios
7. Runs Gantt-specific diagnostic tests
8. Documents any Gantt bugs found in Lexicon


## RULE #21.19: Modifying Existing Agents - Complete Checklist

üìñ Rule

‚úÖ MUST UPDATE (3 locations - Database is source of truth):

**NEW APPROACH (Following RULE #1.13 - Single Source of Truth):**

**1. Database (Trinity - ONLY source of truth)**
```ruby
# Update the agent in Trinity database
Trinity.find_by(
  category: 'teacher',
  chapter_number: 21,
  section_number: '21.15'
).update!(
  title: 'Updated Agent Name',
  description: 'Full markdown content for agent...'
)
```

**2. Export to .md file**
```bash
# Generate .claude/agents/*.md from database
cd backend && bundle exec rake agents:export_definitions
```

**3. Trinity Bible (Agent behavior summary)**
```ruby
# Update high-level description in Bible
Trinity.find_by(
  category: 'bible',
  chapter_number: 21,
  title: 'Agent Name'
).update!(
  description: 'High-level what it does...'
)
```

‚úÖ **BENEFITS:**
- Single source of truth (Trinity database)
- .md files auto-generated from database
- No manual sync needed
- Frontend can read from API

‚ùå **NEVER:**
- Manually edit .claude/agents/*.md files
- Keep agent data in multiple places
- Update only one location


## RULE #21.2: Agent Invocation Protocol

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Check if agent exists and is active
- Record run start timestamp
- Execute agent task
- Record success or failure with details
- Return comprehensive result

‚ùå **NEVER:**
- Invoke inactive agents
- Skip recording run results
- Return vague error messages
- Execute agents without user context


---


## RULE #21.3: Run History Tracking

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Record total_runs, successful_runs, failed_runs
- Store last_run_at timestamp
- Save last_status and last_message
- Include detailed last_run_details (JSONB)
- Calculate success_rate automatically

‚ùå **NEVER:**
- Skip recording runs
- Overwrite historical run data
- Record runs for testing/debugging
- Fake success/failure status


---


## RULE #21.4: Agent Types and Specialization

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Assign agent_type: `development`, `diagnostic`, `deployment`, or `planning`
- Define clear focus area (e.g., "Rails API Backend Development")
- Specify tools available to agent
- Document when to use each agent
- Provide example invocations

‚ùå **NEVER:**
- Create overlapping agent responsibilities
- Use generic agent for specialized tasks
- Skip documenting agent capabilities
- Create agents without clear purpose


---


## RULE #21.5: Agent Priority and Display Order

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Set priority field (0-100)
- Display agents sorted by: priority DESC, name ASC
- Show active agents first
- Hide inactive agents from main list

‚ùå **NEVER:**
- Display agents alphabetically only
- Show inactive agents in main list
- Change priority without reason


---


## RULE #21.6: Agent Shortcuts and Invocation

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Support `run {agent-id}` (e.g., `run backend-developer`)
- Support shortened versions (e.g., `backend dev`, `gantt`)
- Document shortcuts in `example_invocations` field
- Parse user input case-insensitively

‚ùå **NEVER:**
- Require exact agent_id match
- Skip documenting shortcuts
- Create conflicting shortcuts


---


## RULE #21.7: Recently Run Check (Smart Testing)

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Check `last_run_at` timestamp
- Compare to threshold (e.g., 60 minutes)
- Skip redundant tests if recent successful run
- ALWAYS re-run if last run failed
- Ask user if uncertain

‚ùå **NEVER:**
- Skip tests without checking recency
- Ignore failed runs in recency check
- Use stale results without user awareness


---


## RULE #21.8: Shortcut Clarity - AgentShortcutsTab Updates

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST:**
- Update `frontend/src/components/settings/AgentShortcutsTab.jsx` when adding new shortcuts
- Add new shortcuts to the `baseCommands` array
- Ensure shortcuts match agent file definitions exactly
- Use sequential IDs (avoid duplicates)
- Document the shortcut pattern in the command field
- Follow the format: `{ id: N, command: 'What Claude executes', shortcut: 'what user types, comma-separated' }`

‚ùå **NEVER:**
- Leave shortcuts undocumented
- Create duplicate IDs in baseCommands array
- Use shortcuts that contradict agent definitions
- Hardcode shortcuts outside the table


---


## RULE #21.9: Creating New Agents - Complete Checklist

‚úÖ Must

‚úÖ MUST

‚úÖ **MUST UPDATE (4 files):**

‚ùå **NEVER:**
- Create an agent in only one location
- Skip updating run-history.json
- Forget to add to the controllers fallback list
- Miss updating the frontend component


---

---


