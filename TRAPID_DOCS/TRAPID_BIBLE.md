# TRAPID BIBLE - Development Rules

**Version:** 2.0.0
**Last Updated:** 2025-11-19 08:05 AEST
**Authority Level:** ABSOLUTE
**Audience:** Claude Code + Human Developers
**Source of Truth:** Database table `bible_rules` (this file is auto-generated)

---

## ๐ด CRITICAL: Read This First

### This Document is "The Bible"

This file is the **absolute authority** for all Trapid development where chapters exist.

**This Bible Contains RULES ONLY:**
- โ MUST do this
- โ NEVER do that
- ๐ ALWAYS check X before Y
- ๐ Protected code patterns
- โ๏ธ Configuration values that must match

**This file is AUTO-GENERATED from the database.**
- **DO NOT edit this file directly**
- Update rules via Trapid app โ Documentation page โ ๐ Bible
- Export to markdown via: `bin/rails trapid:export_bible`

**For IMPLEMENTATION PATTERNS (code examples, how-to guides):**
- ๐ง See [TRAPID_TEACHER.md](TRAPID_TEACHER.md)

**For KNOWLEDGE (how things work, bug history, why we chose X):**
- ๐ See [TRAPID_LEXICON.md](TRAPID_LEXICON.md)

**For USER GUIDES (how to use features):**
- ๐ See [TRAPID_USER_MANUAL.md](TRAPID_USER_MANUAL.md)

---

# Chapter 1: Overview & System-Wide Rules

**Last Updated:** 2025-11-19 08:05 AEST

## RULE #1.0: Read Dense Index First, Then Full Content of Relevant Rules Only

ALWAYS:
**ALWAYS read the Bible using this efficient 3-step pattern:**

## What is the Dense Index?

The **dense_index** field is an AI-optimized ultra-lean summary automatically generated for each rule:

**What it contains (from Trinity model line 279-321):**
- Section number (no dots): "b0109"
- Title keywords (no spaces): "predecessoridconversion"
- Entry type: "never"
- Category: "bible"
- Component: "gantt"
- Key content terms: 20 most meaningful words (3+ chars)
- Total size: ~50-100 characters vs. 500-5000 chars in full description

**What it does NOT contain:**
- Full rule explanations
- Code examples
- "Why this matters" reasoning
- Related rule references
- Specific formulas or values

## Step 1: Read Dense Index for ALL Rules
```ruby
# Fetch all bible rules with ONLY dense_index field
GET /api/v1/trinity?category=bible&fields=dense_index,title,chapter_number
```

- Scan ~350 rules in <30 seconds
- Identify keywords matching your task
- Note which rules are potentially relevant
- Example: Task = "add meetings" โ Keywords: "construction", "user", "task", "workflow", "modal"

## Step 2: Read Chapter 1 Dense Index + Full Content
```ruby
# Get full content for Chapter 1 only
GET /api/v1/trinity?category=bible&chapter=1
```

- ALWAYS read Chapter 1 completely for ANY task
- Contains universal rules (API format, migrations, timezone, auth)
- ~200 lines, ~15 rules
- Takes ~3 minutes to read thoroughly

## Step 3: Read Full Content of Relevant Rules ONLY
```ruby
# Get full content for specific chapters identified in Step 1
GET /api/v1/trinity?category=bible&chapter=10  # Gantt rules
GET /api/v1/trinity?category=bible&chapter=20  # UI patterns
```

- Read FULL description, code examples, reasoning
- Don't skip the "Why this matters" sections
- Note related rule references
- Example: Chapter 10 has `sequence_order + 1` formula (not in dense_index)

## Why Dense Index First?

**Efficiency:**
- Bible: 2,600 lines, 350+ rules across 21 chapters
- Dense index scan: 350 rules ร 80 chars = 28,000 chars (~7,000 tokens)
- Full Bible read: 2,600 lines ร 80 chars = 208,000 chars (~52,000 tokens)
- Relevant chapters: 3 chapters ร 200 lines = 600 lines (~15,000 tokens)
- **Savings: 37,000 tokens (71% reduction)**

**Accuracy:**
- Dense index shows what exists (fast filtering)
- Full content shows how to implement (correct application)
- Best of both worlds: fast discovery + deep understanding

## What NOT to Do

โ **NEVER read just rule titles/dense_index without full content**
- Dense index: "predecessoridconversion never sequenceorder gantt"
- This tells you a rule exists about predecessor ID conversion in Gantt
- It does NOT tell you the formula: `predecessor_id = sequence_order + 1`
- You MUST read full description to get the actual rule

โ **NEVER read ALL 21 chapters for every task**
- Wastes 37,000 tokens
- Takes 20+ minutes
- 90% of rules won't apply to your task

โ **NEVER skip Chapter 1 (System-Wide Rules)**
- Chapter 1 applies to EVERY feature
- Most violations come from skipping Chapter 1
- Only ~15 rules, takes 3 minutes

## Chapter โ Feature Mapping (Quick Reference)
- **Chapter 1**: System-Wide (read for ANY task)
- **Chapter 2**: Authentication & Users
- **Chapter 3**: System Administration
- **Chapter 4**: Contacts & Relationships
- **Chapter 5**: Price Books & Suppliers
- **Chapter 6**: Jobs & Construction Management
- **Chapter 7**: Estimates & Quoting
- **Chapter 8**: AI Plan Review
- **Chapter 9**: Purchase Orders
- **Chapter 10**: Gantt & Schedule Master
- **Chapter 11**: Project Tasks & Checklists
- **Chapter 12**: Weather & Public Holidays
- **Chapter 13**: OneDrive Integration
- **Chapter 14**: Outlook/Email Integration
- **Chapter 15**: Chat & Communications
- **Chapter 16**: Xero Accounting Integration
- **Chapter 17**: Payments & Financials
- **Chapter 18**: Workflows & Automation
- **Chapter 19**: Custom Tables & Formulas
- **Chapter 20**: UI/UX Standards & Patterns
- **Chapter 21**: Agent System & Automation

## Example Workflow

**Task:** "Add meeting management system"

**Step 1 - Read Dense Index (ALL 350 rules):**
```ruby
# Scan dense_index field for all bible rules
GET /api/v1/trinity?category=bible&fields=dense_index,title,chapter_number

# Filter by keywords: "meeting", "construction", "user", "task", "workflow", "modal"
# Results:
- b0103: "apiformatsuccessdataerror" (Chapter 1)
- b0104: "migrationrollbackindexforeign" (Chapter 1)
- b0302: "timezonecompanysetting" (Chapter 3)
- b0601: "constructioncontactvalidation" (Chapter 6)
- b1101: "taskstatusautomaticdate" (Chapter 11)
- b1801: "solidqueuebackgroundjob" (Chapter 18)
- b2001: "tablepatterncheckboxlocked" (Chapter 20)

# Identified relevant chapters: 1, 3, 6, 11, 18, 20
```

**Step 2 - Read Chapter 1 Full Content:**
```ruby
GET /api/v1/trinity?category=bible&chapter=1

# Learn exact rules:
- RULE #1.3: API format MUST be {success: true, data: {...}}
- RULE #1.4: MUST create migrations, test rollback, add indexes
- RULE #1.13: Single source of truth (database as authority)
```

**Step 3 - Read Relevant Chapters Full Content:**
```ruby
GET /api/v1/trinity?category=bible&chapter=3  # Timezone
GET /api/v1/trinity?category=bible&chapter=6  # Construction
GET /api/v1/trinity?category=bible&chapter=11 # Tasks
GET /api/v1/trinity?category=bible&chapter=18 # Workflows
GET /api/v1/trinity?category=bible&chapter=20 # UI

# Learn implementation details:
- Chapter 3: Use CompanySetting.timezone methods, Time.use_zone context
- Chapter 6: Meetings belong_to :construction, validate has_one_contact
- Chapter 11: Link tasks via meeting_id, action items from agenda
- Chapter 18: Use Solid Queue for emails, make jobs idempotent
- Chapter 20: Use Headless UI modals, follow table patterns
```

**Result:**
- Scanned: 350 rules via dense_index (7,000 tokens)
- Read fully: 6 chapters, ~80 rules (15,000 tokens)
- **Total: 22,000 tokens vs. 52,000 for full Bible (58% savings)**
- Know all relevant rules โ
- Build compliant feature โ
- Avoided reading 15 irrelevant chapters โ

## This is RULE #1.0 Because

Reading efficiently MUST happen BEFORE you can follow other rules.
- You cannot follow rules you haven't read
- But reading EVERYTHING wastes time and tokens
- Dense index = AI-optimized discovery layer
- Full content = implementation details
- Dense index โ relevant chapters = optimal pattern

## Technical Implementation

**Dense Index Generation (Trinity model line 279-321):**
```ruby
def update_dense_index
  tokens = []
  tokens << section_number.downcase.gsub('.', '')  # b0109
  tokens << title.downcase.gsub(/[^a-z0-9]/, '')   # predecessoridconversion
  tokens << entry_type.downcase                     # never
  tokens << category                                # bible
  tokens << component.downcase if component.present?

  # Extract 20 key terms (3+ chars) from content
  key_terms = content_text
    .downcase
    .gsub(/[*#-_`]/, '')  # Remove markdown
    .gsub(/must|never|always|should|will|can/, '')  # Remove common words
    .scan(/[a-z]{3,}/)  # Extract meaningful words
    .uniq
    .first(20)

  tokens.concat(key_terms)
  self.dense_index = tokens.join(' ')  # Space-separated for text search
end
```

**Search Pattern:**
```ruby
# Find rules about "timezone" and "working days"
Trinity.bible_entries.where("dense_index ILIKE ?", "%timezone%")
Trinity.bible_entries.where("dense_index ILIKE ?", "%workingdays%")
```


## RULE #01.001: Documentation Maintenance

RULE:
When to Update Bible:
MUST update Bible when:
1. Adding a new coding rule (MUST/NEVER/ALWAYS pattern)
2. Discovering a protected code pattern
3. Adding a critical configuration value
4. Finding a bug-causing violation
DO NOT update Bible for:
โข Bug discoveries (goes in Lexicon)
โข Architecture explanations (goes in Lexicon)
โข Performance optimizations (goes in Lexicon unless it creates a new RULE)

## RULE #01.002: Code Quality Standards

RULE:
NEVER commit code with:
โข Console.log statements (use proper logging)
โข Commented-out code (delete it)
โข TODO comments without GitHub issues
โข Hardcoded credentials or API keys
ALWAYS:
โข Use environment variables for secrets
โข Write descriptive commit messages
โข Run linter before committing
โข Test locally before pushing

## RULE #01.003: Api Response Format

RULE:
ALWAYS return consistent JSON:
Success response:
{ success: true, data: { ... }, message: "Optional" }
Error response:
{ success: false, error: "Error message", details: { ... } }

## RULE #01.004: Database Migrations

RULE:
NEVER:
โข Modify existing migrations after deployment
โข Delete migrations that have run in production
โข Add columns manually without migrations
ALWAYS:
โข Create new migration to fix issues
โข Test migrations with db:rollback
โข Add indexes for foreign keys
โข Create migrations for ALL schema changes

## RULE #01.005: Agent Maintenance & Learning

RULE:
When an agent fails to catch a bug:
1. Update agent definition in .claude/agents/
2. Document in Lexicon Chapter 0
3. Update Bible if it reveals a new RULE
ALWAYS ask: "Could an agent have prevented this?"
NEVER let the same class of bug happen twice

## RULE #01.006: Documentation Authority Hierarchy

RULE:
Authority Order (Highest to Lowest):
1. TRAPID_BIBLE.md - ABSOLUTE AUTHORITY for protected features
2. CLAUDE.md - META INSTRUCTIONS for AI behavior
3. TRAPID_LEXICON.md - REFERENCE for bug history
4. Code comments - IMPLEMENTATION DETAILS

## RULE #01.007: Trinity Database Sync

RULE:
MUST: The Trinity system (Bible + Lexicon + Teacher combined) is DATABASE-FIRST.
Source of Truth: Trinity database table (PostgreSQL)
Markdown Files: Auto-generated exports for git history and offline reference ONLY
Architecture:
โข Database โ API โ Frontend UI (primary use)
โข Database โ Export โ Markdown files (backup/git only)
DO NOT:
โข Read markdown files for rules (always use API)
โข Edit markdown files directly (use UI or database)
โข Trust markdown as source of truth (may be stale)
ALWAYS:
โข Fetch from /api/v1/trinity APIs for real-time data
โข Edit via UI (stores in database)
โข Export to markdown for git commit backups

Fetch from Trinity API:
```bash
# Get all Bible rules
curl https://trapid-backend-447058022b51.herokuapp.com/api/v1/trinity?category=bible
# Get all Lexicon entries
curl https://trapid-backend-447058022b51.herokuapp.com/api/v1/trinity?category=lexicon
# Get all Teacher guides 
curl https://trapid-backend-447058022b51.herokuapp.com/api/v1/trinity?category=teacher
# Get specific chapter
curl https://trapid-backend-447058022b51.herokuapp.com/api/v1/trinity?category=bible&chapter=21
```
Export to Markdown (for git backup):
```bash
# Export Bible to TRAPID_BIBLE.md
bin/rails trapid:export_bible
# Export Lexicon to TRAPID_LEXICON.md
bin/rails trapid:export_lexicon
# Export Teacher to TRAPID_TEACHER.md
bin/rails trapid:export_teacher
```
Import from Markdown (restore from backup):
```bash
# Import Bible from TRAPID_BIBLE.md
bin/rails trapid:import_bible
# Import Lexicon from TRAPID_LEXICON.md
bin/rails trapid:import_lexicon
# Import Teacher from TRAPID_TEACHER.md
bin/rails trapid:import_teacher
```
Workflow:
1. Edit via UI โ Updates trinity table
2. Run export task โ Generates markdown file
3. Commit markdown file to git (backup)
4. Other developers: Pull โ Database is already synced (no import needed)
Validation:
- Use /trinity-sync-validator agent to verify sync
- Trinity table is ALWAYS authoritative
- Markdown exports are snapshots for git history

## RULE #01.008: Never Guess - Always Ask

RULE:
NEVER: NEVER guess what the user wants:
โข When user asks "anything else we should remove" โ Ask specific clarifying questions
โข When user says "can we take this out" โ Ask which specific parts they mean
โข When given vague requests โ List options and ask user to choose
โข When uncertain about intent โ Present alternatives and ask for confirmation
ALWAYS ask explicitly:
โข "Would you like me to remove X?"
โข "Do you mean A, B, or C?"
โข "Should I proceed with option 1 or option 2?"
โข "Which of these would you prefer?"

## RULE #01.009: Always Fetch Trinity Before Modifying Code

RULE:
ALWAYS: ALWAYS fetch Trinity Bible/Lexicon/Teacher when:
โข User mentions a feature name
โข Working on files related to a specific chapter
โข User reports a bug
โข Adding new functionality
โข Modifying existing code
โข Modify feature code without fetching Bible rules for that chapter
โข Change values or patterns mentioned in Bible rules
โข Skip reading Protected Code Patterns
โข "Optimize" or "simplify" code without checking Bible first
Chapter โ Feature mapping:
โข Chapter 7: Gantt Chart, Schedule Master, cascade, dependencies
โข Chapter 15: Xero, accounting, invoice sync
โข Chapter 19: Table Pattern, UI components, modals, forms
โข Chapter 20: UI/UX Standards & Patterns
โข Chapter 21: Agent System & Automation

## RULE #01.010: Section Numbers Must Use Category Prefix Format

RULE:
MUST: MUST use category prefix + padded numbers:
โข Bible: B01.01, B01.02, B19.11
โข Lexicon: L01.01, L01.02, L19.11
โข Teacher: T01.01, T01.02, T19.11
โข Format: [B|L|T] + 2-digit chapter + dot + 2-digit section

NEVER use legacy numeric-only format:
โข Invalid: 1.1, 19.11 (missing prefix)
โข Invalid: B1.1, L01.1 (not padded)
โข Invalid: B01.1A, L19.11A (letters)

## RULE #01.011: Section Numbers Must Be Unique Within Chapter + Category

RULE:
MUST: MUST ensure section numbers are unique within each chapter + category combination:
โข Each section number can only be used ONCE per chapter per category
โข Bible, Teacher, and Lexicon each have independent section numbering
โข Example: Bible B21.010, Teacher B21.010, and Lexicon B21.010 can all coexist
NEVER reuse section numbers within same chapter + category:
โข Invalid: Two Bible entries both using B21.010 (same chapter, same category)
โข Invalid: Two Teacher entries both using B00.002 (same chapter, same category)
VALID - different categories can share section numbers:
โข Bible B21.010 AND Teacher B21.010 (different categories) 
โข Bible B00.002 AND Teacher B00.002 (different categories) 
โข Add unique index: CREATE UNIQUE INDEX idx_trinity_unique_section ON trinity(chapter_number, section_number, category)
โข Model validation: validates :section_number, uniqueness: { scope: [:chapter_number, :category] }

## RULE #01.012: Chapter Assignment - Where to Place New Rules

RULE:
MUST: MUST place rules in the correct chapter:
Chapter 1: System-Wide Rules
โข Trinity documentation workflow and meta-rules
โข Trinity entry types and section numbering
โข Code quality standards
โข API response formats
โข Database migration rules
โข Documentation maintenance
โข General application patterns
โข Example: B01.008 (Always Fetch Trinity Before Modifying Code)
โข Example: B01.009 (Section Numbers Must Be Purely Numeric)
Chapters 2-21: Feature-Specific Rules
โข Chapter 2: Authentication & Users
โข Chapter 3: System Administration
โข Chapter 4: Contacts & Relationships
โข Chapter 5: Price Books & Suppliers
โข Chapter 6: Jobs & Construction Management
โข Chapter 7: Estimates & Quoting
โข Chapter 8: AI Plan Review
โข Chapter 9: Purchase Orders
โข Chapter 10: Gantt & Schedule Master
โข Chapter 11: Project Tasks & Checklists
โข Chapter 12: Weather & Public Holidays
โข Chapter 13: OneDrive Integration
โข Chapter 14: Outlook/Email Integration
โข Chapter 15: Chat & Communications
โข Chapter 16: Xero Accounting Integration
โข Chapter 17: Payments & Financials
โข Chapter 18: Workflows & Automation
โข Chapter 19: Custom Tables & Formulas
โข Chapter 20: UI/UX Standards & Patterns
โข Chapter 21: Agent System & Automation
โข Create Chapter 0 (all system-wide rules go in Chapter 1)
โข Put feature-specific rules in Chapter 1
โข Create rules in wrong feature chapters (e.g., Gantt rules in Chapter 4)
1. Is this a system-wide rule or Trinity meta-rule? โ Chapter 1
2. Is this feature-specific? โ Find matching chapter (2-21)
3. Unsure? Ask which chapter it belongs in

## RULE #01.013: Single Source of Truth - Eliminate Data Duplication

RULE:
MUST: MUST identify and eliminate multiple sources of truth:
The Problem:
When the same data exists in multiple places, they inevitably drift out of sync, causing:
โข Conflicting information
โข Unclear which source is authoritative
โข Bugs when one source is updated but not others
โข Maintenance burden keeping everything synchronized
Look for the same information stored in:
โข Database tables AND configuration files
โข Environment variables AND database records
โข Markdown files AND database tables
โข Frontend constants AND backend database
โข Multiple database tables with overlapping data
MUST Fix Pattern:
1. Identify the single source of truth (usually database)
2. Make other locations read from the source (via API, query, import)
3. Remove duplication - delete redundant copies
4. Document the authority - which source is canonical
Example - General Pattern:
BAD (Multiple sources of truth):
โข User roles in database AND hardcoded in frontend
โข Configuration in .env AND database settings table
โข Feature flags in code AND database
GOOD (Single source of truth):
โข Database is the ONLY source of truth
โข Frontend reads from API (not hardcoded)
โข Code imports from authoritative source
โข Performance caching (with clear expiry/invalidation)
โข Offline/backup copies (with sync mechanism)
โข Derived/computed data (with clear calculation source)
Document it:
Always add comment showing which source is authoritative:
```javascript
// Source of truth: database settings table
// This component reads from API /api/v1/settings
```
โข Create duplicate data without clear authority
โข Assume manual sync will stay consistent
โข Store same data in multiple writeable locations

# Chapter 2: Authentication & Users

**Last Updated:** 2025-11-18 00:22 AEST

## RULE #02.001: Jwt Token Handling

RULE:
MUST: โข Use `JsonWebToken.encode` to create tokens
โข Include `user_id` in payload
โข Set expiration to 24 hours maximum
โข Send token in `Authorization: Bearer <token>` header
โข Store sensitive data in JWT payload (it's base64, not encrypted)
โข Create tokens without expiration
โข Share SECRET_KEY across environments
โข Store tokens in localStorage (XSS vulnerable) - use httpOnly cookies on frontend
---

## RULE #02.002: Password Security Requirements

RULE:
MUST: MUST enforce:
โข Minimum 12 characters (NOT 8, NOT 10)
โข At least 1 uppercase letter [A-Z]
โข At least 1 lowercase letter [a-z]
โข At least 1 digit [0-9]
โข At least 1 special character [!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]
โข Log passwords (even hashed)
โข Send passwords in API responses
โข Store passwords in plain text
โข Allow common passwords (implement dictionary check if needed)
---

## RULE #02.003: Role-based Access Control

RULE:
MUST: โข Use predefined roles: `user`, `admin`, `product_owner`, `estimator`, `supervisor`, `builder`
โข Check permissions via User model methods (`can_create_templates?`, `can_edit_schedule?`)
โข Use `before_action :require_admin` for admin-only endpoints
โข Set default role to `"user"` for new signups
โข Create roles dynamically via API
โข Store roles outside the enum
โข Bypass permission checks with hardcoded user IDs
โข Grant admin role automatically (even for @tekna.com.au emails)
---

## RULE #02.004: Rate Limiting on Auth Endpoints

RULE:
MUST: MUST configure:
โข Auth endpoints: 5 requests per 20 seconds per IP
โข Password reset: 3 requests per hour per email
โข General API: 300 requests per 5 minutes per IP
โข Disable rate limiting in production
โข Use same limits for external vs internal APIs
โข Skip rate limiting for "trusted" IPs (้ค้ explicitly whitelisted)
---

## RULE #02.005: Oauth Integration Pattern

RULE:
MUST: โข Use OmniAuth gem for all OAuth providers
โข Store `provider`, `uid`, `oauth_token`, `oauth_expires_at` on User
โข Generate random password for OAuth users (via `SecureRandom.hex`)
โข Return JWT token after OAuth callback
โข Validate OAuth tokens on every external API call
โข Store OAuth refresh tokens in database (security risk)
โข Share OAuth tokens across users
โข Skip token expiration checks
โข Use OAuth for internal user creation (only for login)
---

## RULE #02.006: Password Reset Flow

RULE:
MUST: โข Generate token via `SecureRandom.urlsafe_base64(32)`
โข Store hashed token in database (NOT plain text)
โข Set `reset_password_sent_at` timestamp
โข Expire tokens after 2 hours
โข Clear token after successful reset
โข Send reset email with token URL
โข Store tokens in plain text
โข Reuse tokens across multiple resets
โข Skip token expiration check
โข Send token in API response (only via email)
---

## RULE #02.007: Portal User Separation

RULE:
MUST: โข Use separate `portal_users` table (NOT users table)
โข Associate portal users with `Contact` record
โข Implement account lockout for portal users (5 failed attempts = 30 min lockout)
โข Log all portal user activities via `PortalAccessLog`
โข Use `portal_type` enum: `'supplier'` or `'customer'`
โข Mix portal users and admin users in same table
โข Grant admin access to portal users
โข Skip activity logging for portal users
โข Allow portal users to access internal APIs
---

## RULE #02.008: Login Activity Tracking

RULE:
MUST: โข Update `last_login_at` timestamp on successful login
โข Store in UTC timezone
โข Track for both User and PortalUser
โข Use for account activity monitoring
โข Update on token refresh (only on actual login)
โข Track in local timezone
โข Skip updates (used for security monitoring)
---

# Chapter 3: System Administration

**Last Updated:** 2025-11-18 00:22 AEST

## RULE #03.001: Company Settings Singleton Pattern

RULE:
MUST: MUST implement as singleton:
MUST access via instance method:
โข Create multiple CompanySetting records (singleton = one record only)
โข Hardcode configuration values instead of reading from settings
โข Use `CompanySetting.first` (use `CompanySetting.instance`)
โข Call `CompanySetting.create` manually (use `instance` method)
---

## RULE #03.002: Timezone Handling - Backend Time Calculations

RULE:
MUST: MUST use CompanySetting timezone methods:
MUST use Time.use_zone context:
โข Use `Date.today` or `Time.now` without timezone context
โข Store dates/times in UTC without timezone conversion
โข Assume server timezone matches company timezone
โข Use JavaScript `new Date()` for date calculations (see B02.003)
---

## RULE #03.003: Timezone Handling - Frontend Time Display

RULE:
MUST: MUST use Intl API with explicit timezone:
MUST import and use timezone utilities:
โข Use `Date.toLocaleDateString()` without timeZone parameter (uses browser timezone!)
โข Use `Date.toLocaleString()` without explicit timezone
โข Use date libraries without timezone configuration (moment.js, date-fns)
โข Assume user's browser timezone matches company timezone
---

## RULE #03.004: Working Days Configuration & Business Day Calculations

RULE:
MUST: MUST implement working_day? and business_day? methods:
MUST use in date calculations:
โข Hardcode working days as Monday-Friday only (some industries work Sundays, skip Saturdays)
โข Use Rails' `business_day?` method (doesn't respect company settings)
โข Calculate task dates without checking working_days
โข Allow cascade to schedule tasks on non-working days (exception: locked tasks)
---

## RULE #03.005: User Roles & Permission System

RULE:
MUST: MUST implement permission helper methods:
MUST check permissions in controllers:
โข Allow users to change their own role (admin-only operation)
โข Grant permissions based on string matching role names
โข Skip permission checks in controllers ("I'll handle it in the UI")
โข Use role checking in frontend only (backend MUST validate)
---

## RULE #03.006: Assignable Roles for Task Assignment

RULE:
MUST: MUST use assignable_role for task filtering:
โข Confuse system role (permissions) with assignable_role (task filtering)
โข Use system role for task assignment
โข Allow users with assignable_role: none to be assigned tasks
โข Hardcode role names in task queries
---

## RULE #03.007: Password Complexity Requirements

RULE:
MUST: MUST validate password complexity:
MUST generate random password for OAuth users:
โข Allow passwords shorter than 12 characters
โข Allow passwords without uppercase, lowercase, digit, and special character
โข Require OAuth users to set passwords (they don't use them)
โข Store passwords in plain text (use bcrypt via has_secure_password)
---

## RULE #03.008: Timezone Options Limitation

RULE:
MUST: MUST use this exact list:
MUST use select with these options:
โข Allow free-text timezone entry (validation nightmare)
โข Show all 400+ IANA timezones (overwhelming, unnecessary)
โข Use timezone abbreviations (AEST, AEDT - ambiguous)
โข Default to UTC (construction companies operate in specific regions)
---

## RULE #03.009: Working Days UI - Sunday Default True

RULE:
MUST: MUST initialize with Sunday = true:
MUST show checkboxes for all 7 days:
โข Hardcode Monday-Friday as only working days
โข Hide Sunday checkbox (some companies DO work Sundays)
โข Default all days to true (Saturday rarely worked)
โข Prevent users from customizing working days
---

# Chapter 4: Contacts & Relationships

**Last Updated:** 2025-11-18 00:22 AEST

## RULE #04.001: Contact Types Are Multi-select Arrays

RULE:
MUST: โข Use `contact_types` as PostgreSQL array column
โข Allow multiple types: `['customer', 'supplier']` for hybrid contacts
โข Set `primary_contact_type` automatically if blank (first type in array)
โข Validate types against `CONTACT_TYPES = ['customer', 'supplier', 'sales', 'land_agent']`
โข Use array operations for querying: `where("'supplier' = ANY(contact_types)")`
โข Use single contact_type field (legacy pattern)
โข Store types as comma-separated strings
โข Assume a contact has only one type
โข Query with `contact_type =` (use array containment instead)
---

## RULE #04.002: Bidirectional Relationships Require Reverse Sync

RULE:
MUST: โข Create reverse relationship after creating forward relationship
โข Update reverse relationship when forward is updated
โข Delete reverse relationship when forward is deleted
โข Use Thread-local flags to prevent infinite recursion: `Thread.current[:creating_reverse_relationship]`
โข Validate unique relationship pairs: `[source_contact_id, related_contact_id]`
โข Prevent self-relationships: `source_contact_id != related_contact_id`
โข Create one-way relationships without reverse
โข Allow circular reference loops during cascade updates
โข Delete reverse relationship without checking Thread flag
โข Allow duplicate relationships (same source + related pair)
---

## RULE #04.003: Xero Sync Uses Priority-based Fuzzy Matching

RULE:
MUST: โข Priority 1: Match by `xero_id` (exact match)
โข Priority 2: Match by `tax_number` (normalized ABN/ACN, 11 digits)
โข Priority 3: Match by `email` (case-insensitive exact match)
โข Priority 4: Fuzzy match by `full_name` using FuzzyMatch gem (>85% similarity threshold)
โข Rate limit: 1.2 second delay between Xero API calls (60 req/min limit)
โข Log all sync activities with metadata to `ContactActivity`
โข Set `last_synced_at` timestamp on successful sync
โข Clear `xero_sync_error` on success, set on failure
โข Respect `sync_with_xero` flag (skip if false)
โข Match only by name (too unreliable without fuzzy matching)
โข Sync without rate limiting (will hit Xero API limits)
โข Override manual `xero_id` links without confirmation
โข Sync contacts with `sync_with_xero = false`
โข Delete local contacts that don't exist in Xero
---

## RULE #04.004: Contact Deletion MUST Check Purchase Order Dependencies

RULE:
MUST: โข Check for linked suppliers via `contact.suppliers` association
โข Check if suppliers have purchase orders: `suppliers.joins(:purchase_orders).distinct`
โข Block deletion if ANY purchase orders exist
โข Block deletion if ANY purchase orders have been paid or invoiced
โข Return detailed error message listing suppliers and PO counts
โข Allow deletion of contacts without supplier dependencies
โข Delete contacts with active supplier relationships that have POs
โข Cascade delete purchase orders when deleting contact
โข Allow deletion without checking payment/invoice status
โข Delete last contact from a construction/job
---

## RULE #04.005: Contact Merge MUST Consolidate All Related Records

RULE:
MUST: โข Merge `contact_types` arrays (union, no duplicates)
โข Fill missing info from source to target (email, phone, address, etc.)
โข Keep best `rating` if both are suppliers (higher wins)
โข Combine `notes` with merge trail: `"[Merged from Contact #123] original notes"`
โข Update foreign keys for: `PricebookItem`, `PurchaseOrder`, `PriceHistory`
โข Delete source contacts after successful merge
โข Log activity with "contact_merged" type and metadata
โข Return updated target contact
โข Overwrite target data with blank source data
โข Merge without updating related records
โข Delete source without logging activity
โข Allow merge if validation fails on target
---

## RULE #04.006: Portal Users MUST Have Secure Password Requirements

RULE:
MUST: โข Minimum 12 characters
โข At least one uppercase, lowercase, digit, and special character
โข Lock account after 5 failed login attempts
โข Lockout duration: 30 minutes
โข Reset failed attempts counter on successful login
โข Use `has_secure_password` with bcrypt
โข Validate email uniqueness and `contact_id` uniqueness scoped to `portal_type`
โข Allow weak passwords (<12 chars or missing character types)
โข Store passwords in plain text
โข Allow unlimited login attempts
โข Share portal accounts across contacts
---

## RULE #04.007: Primary Contact/address/person MUST Be Unique Per Contact

RULE:
MUST: โข Validate `is_primary` uniqueness scoped to `contact_id` in before_save callback
โข Automatically unmark other primaries when setting new primary
โข Use database index on `[contact_id, is_primary]` for performance
โข Ensure at least one contact remains on construction (cannot delete last)
โข Allow multiple primary persons/addresses per contact
โข Delete the only remaining contact from a construction
โข Set `is_primary = true` without unmarking others
---

## RULE #04.008: Contact Activity Logging MUST Track All Significant Changes

RULE:
MUST: โข Log activity types: `created`, `updated`, `synced_from_xero`, `synced_to_xero`, `purchase_order_created`, `supplier_linked`, `contact_merged`
โข Include `occurred_at` timestamp (required)
โข Store structured metadata in JSONB column
โข Use `ContactActivity.log_xero_sync` class method for Xero sync activities
โข Combine with SMS messages in activity timeline endpoint
โข Skip logging for "minor" updates (all changes matter)
โข Log without `occurred_at` timestamp
โข Store sensitive data in metadata (passwords, tokens, etc.)
โข Delete activity records (archive only for compliance)
---

# Chapter 5: Price Books & Suppliers

**Last Updated:** 2025-11-18 00:22 AEST

## RULE #05.001: Price Changes MUST Create Price History Automatically

RULE:
MUST: โข Use `after_update` callback to detect price changes
โข Create PriceHistory with `old_price`, `new_price`, `change_reason`
โข Set `price_last_updated_at` to current timestamp
โข Track `changed_by_user_id` for audit trail
โข Allow skipping via `skip_price_history_callback` flag when needed
โข Update `current_price` without creating history
โข Skip price history for "small" price changes
โข Delete price history records (archive only)
โข Allow price updates without tracking who made the change
---

## RULE #05.002: Prevent Duplicate Price History - Unique Constraint + Time Window

RULE:
MUST: โข Use unique index: `(pricebook_item_id, supplier_id, new_price, created_at)`
โข Add custom validation preventing entries within 5 seconds
โข Handle race conditions gracefully (return existing record)
โข Log duplicate attempts for monitoring
โข Rely only on application-level validation
โข Allow duplicate price history from concurrent requests
โข Fail hard on duplicate attempts (graceful degradation)
---

## RULE #05.003: Smartpolookupservice - 6-strategy Cascading Fallback

RULE:
MUST: โข Execute strategies in priority order (most specific โ most general)
โข Stop immediately on first match (don't continue searching)
โข Track which strategy succeeded for analytics
โข Collect warnings for all failed strategies
โข Skip intermediate strategies
โข Continue searching after finding a match
โข Return multiple matches (return best only)
โข Fail if early strategies miss (cascade to less specific)
---

## RULE #05.004: Supplier Matching - Normalized Name Comparison with Business Suffix Removal

RULE:
MUST: โข Remove business entity types: "Pty Ltd", "Limited", "Inc", "Corporation", "Co"
โข Remove location identifiers: "Australia", "Australian", "Qld", "Queensland"
โข Remove organizational terms: "Group", "Services", "& Associates"
โข Lowercase and remove special characters
โข Use Levenshtein distance for similarity scoring
โข Match on raw supplier names without normalization
โข Include business suffixes in similarity calculation
โข Skip normalization for "exact" match detection
โข Use case-sensitive comparison
---

## RULE #05.005: Price Volatility Detection - Coefficient of Variation on 6-month Window

RULE:
MUST: โข Use rolling 6-month window of prices
โข Calculate CV = (Standard Deviation / Mean) ร 100
โข Classify: stable (<5%), moderate (5-15%), volatile (>15%)
โข Require minimum 3 data points for valid calculation
โข Return 'unknown' for insufficient data
โข Use fixed time windows (calendar months/quarters)
โข Calculate volatility on fewer than 3 price points
โข Include prices older than 6 months
โข Use absolute price change instead of percentage
---

## RULE #05.006: Risk Scoring - Multi-factor Weighted Calculation (0-100 Scale)

RULE:
MUST: โข Calculate all 4 components independently
โข Apply fixed weights (freshness=40%, reliability=20%, volatility=20%, missing=20%)
โข Return score 0-100 with level: low/medium/high/critical
โข Use database-level scoping for efficient filtering
โข Cache calculation results for 1 hour
โข Change weights without updating all documentation
โข Skip any of the 4 components
โข Return risk score without risk level
โข Calculate risk client-side (compute server-side)
---

## RULE #05.007: Bulk Updates - Transaction Wrapper with Price History Batch Creation

RULE:
MUST: โข Wrap all updates in `ActiveRecord::Base.transaction`
โข Batch create price histories in single insert
โข Rollback entirely on any validation error
โข Return detailed success/failure report per item
โข Use `skip_price_history_callback` to prevent duplicate history
โข Update items one-by-one without transaction
โข Create price history one record at a time (N+1 performance issue)
โข Continue processing after first error
โข Commit partial updates
---

## RULE #05.008: Onedrive Image Proxy - Cache Control with 1-hour Expiry

RULE:
MUST: โข Set `Cache-Control: public, max-age=3600` (1 hour)
โข Store OneDrive `file_id` permanently (not URL)
โข Refresh URL on each request via Microsoft Graph API
โข Handle expired credentials gracefully (503 Service Unavailable)
โข Return appropriate Content-Type from OneDrive metadata
โข Store OneDrive direct URLs (expire after 1 hour)
โข Cache beyond 1 hour (OneDrive credential lifespan)
โข Proxy without Cache-Control header
โข Return errors for missing images (return 404 gracefully)
---

# Chapter 6: Jobs & Construction Management

**Last Updated:** 2025-11-18 00:22 AEST

## RULE #06.001: Task Dependencies - No Circular References

RULE:
MUST: โข Validate `no_circular_dependencies` before saving TaskDependency
โข Use graph traversal (BFS) to detect cycles
โข Check entire predecessor chain for successor_task
โข Reject dependency if circular reference detected
โข Allow Task A โ B โ C โ A chains
โข Skip circular dependency validation
โข Allow self-dependencies (task depending on itself)
---

## RULE #06.002: Construction MUST Have at Least One Contact

RULE:
MUST: โข Validate `must_have_at_least_one_contact` on update
โข Allow creation without contacts (initial save)
โข Require at least one contact before job can be used
โข Show validation error if all contacts removed
โข Allow Construction to exist without contacts after initial creation
โข Skip contact validation on updates
โข Delete all contacts without replacement
---

## RULE #06.003: Live Profit Calculation - Dynamic Not Cached

RULE:
MUST: โข Calculate `live_profit = contract_value - sum(all_purchase_orders.total)`
โข Recalculate `profit_percentage = (live_profit / contract_value) * 100`
โข Use `calculate_live_profit` and `calculate_profit_percentage` methods
โข Return calculated values in API responses
โข Store live_profit or profit_percentage in database
โข Cache profit values (they change with every PO update)
โข Use stale profit calculations
---

## RULE #06.004: Task Status Transitions - Automatic Date Setting

RULE:
MUST: โข Set `actual_start_date = Date.current` when status โ `in_progress` (if nil)
โข Set `actual_end_date = Date.current` when status โ `complete`
โข Set `progress_percentage = 100` when status โ `complete`
โข Use `before_save :update_actual_dates` callback
โข Allow `complete` status without actual_end_date
โข Allow `in_progress` without actual_start_date
โข Manually set these dates in controller
---

## RULE #06.005: Task Spawning - Status-based Child Task Creation

RULE:
MUST: โข Spawn subtasks when parent status โ `in_progress`
โข Spawn photo task when parent status โ `complete`
โข Spawn certificate task when parent status โ `complete` (with cert_lag_days)
โข Use `Schedule::TaskSpawner` service
โข Set `spawned_type` field to identify task type
โข Link via `parent_task_id`
โข Create photo/cert tasks manually
โข Spawn tasks without checking schedule_template_row configuration
โข Skip TaskSpawner service
---

## RULE #06.006: Schedule Cascade - Dependency-based Date Propagation

RULE:
MUST: โข Use `ScheduleCascadeService` to recalculate dependent task dates
โข Respect dependency types (FS/SS/FF/SF)
โข Apply lag_days to calculations
โข Skip manually_positioned tasks (user-set dates)
โข Recursively cascade to downstream tasks
โข Use company timezone and working days
โข Skip cascade when task dates change
โข Ignore dependency types
โข Override manually_positioned tasks
โข Cascade to different projects
---

## RULE #06.007: Onedrive Folder Creation - Async with Status Tracking

RULE:
MUST: โข Use `CreateJobFoldersJob` background job
โข Track status: `not_requested` โ `pending` โ `processing` โ `completed` / `failed`
โข Use `onedrive_folder_creation_status` enum field
โข Set `onedrive_folders_created_at` timestamp on completion
โข Make idempotent (check if folders already exist)
โข Use exponential backoff for retries
โข Create folders synchronously in controller
โข Skip status tracking
โข Create duplicate folders
โข Fail silently without updating status
---

## RULE #06.008: Schedule Template Instantiation - All-or-nothing Transaction

RULE:
MUST: โข Use `ActiveRecord::Base.transaction` for all template instantiation
โข Rollback entire operation if any task fails to create
โข Rollback if dependency creation fails
โข Rollback if date calculation fails
โข Return `{ success: true/false, errors: [] }` response
โข Create partial schedules (some tasks without others)
โข Leave orphaned tasks if dependencies fail
โข Continue after validation errors
---

# Chapter 7: Estimates & Quoting

**Last Updated:** 2025-11-18 00:22 AEST

## RULE #07.001: Fuzzy Job Matching - Three-tier Confidence Thresholds

RULE:
MUST: โข Use Levenshtein distance + word matching + substring bonuses
โข Auto-match at โฅ70% confidence (high certainty)
โข Suggest candidates at 50-70% confidence (ambiguous)
โข Return no match at <50% confidence (low similarity)
โข Set `matched_automatically: true` for auto-matches
โข Store `match_confidence_score` for all matches
โข Auto-match below 70% confidence
โข Skip confidence scoring
โข Match without normalizing strings (lowercase, trim, remove special chars)
โข Allow duplicate auto-matches
---

## RULE #07.002: External API Key Security - Sha256 Hashing Only

RULE:
MUST: โข Hash API keys with SHA256 before storage
โข Validate incoming keys by hashing and comparing digests
โข Store keys in `external_integrations` table
โข Track usage with `last_used_at` timestamp
โข Support key deactivation without deletion
โข Store plaintext API keys in database
โข Log API keys in server logs
โข Return API keys in API responses
โข Use reversible encryption (one-way hash only)
---

## RULE #07.003: Estimate Import - Validate Before Auto-matching

RULE:
MUST: โข Validate `job_name` is present and non-empty
โข Validate `materials` array has at least 1 item
โข Validate each material has: `category`, `item`, `quantity`
โข Return 422 Unprocessable Entity for invalid data
โข Log validation errors with request details
โข Attempt to match with missing job_name
โข Create estimate with zero line items
โข Skip validation on external API endpoint
โข Create estimate with nil or zero quantities
---

## RULE #07.004: Po Generation from Estimate - Transaction Safety

RULE:
MUST: โข Wrap entire conversion in `ActiveRecord::Base.transaction`
โข Rollback if any PO creation fails
โข Rollback if any line item creation fails
โข Rollback if supplier lookup fails critically
โข Mark estimate as `imported` only on successful commit
โข Create partial POs (some categories succeed, others fail)
โข Leave estimate in `matched` status if POs were created
โข Continue after critical errors
โข Create POs without line items
---

## RULE #07.005: Ai Plan Review - Async Processing Required

RULE:
MUST: โข Enqueue `AiReviewJob` for all plan reviews
โข Create `EstimateReview` record with `status: 'pending'` immediately
โข Return review_id to client for polling
โข Update status to `processing` โ `completed` / `failed`
โข Set timeout of 5 minutes for Claude API call
โข Run plan review in synchronous HTTP request
โข Block API response waiting for Claude
โข Skip background job for "small" reviews
โข Leave review in `processing` status indefinitely
---

## RULE #07.006: Line Item Categorization - Normalized Category Matching

RULE:
MUST: โข Normalize categories to lowercase before grouping
โข Map common variations: "plumbing" = "plumber" = "plumb"
โข Use category normalization service
โข Handle nil/blank categories with "Uncategorized" group
โข Store original category in line item, use normalized for matching
โข Group POs by case-sensitive categories ("Plumbing" โ "plumbing")
โข Skip category normalization in SmartPoLookupService
โข Create separate POs for "Electrical" and "electrical"
โข Fail import if category is missing
---

## RULE #07.007: Estimate Status State Machine - Strict Transitions

RULE:
MUST: โข Start at `pending` status on creation
โข Transition to `matched` when linked to construction
โข Transition to `imported` when POs generated
โข Allow `rejected` from any state
โข Prevent reverse transitions (no imported โ matched)
โข Skip `matched` status and go directly to `imported`
โข Mark as `imported` before POs are created
โข Change status back from `imported` to `pending`
โข Allow PO generation from `pending` status
---

# Chapter 8: AI Plan Review

**Last Updated:** 2025-11-18 00:22 AEST

## RULE #08.001: Estimate Must Be Matched to Construction

RULE:
MUST: โข Validate `estimate.construction_id` is present before starting review
โข Return 422 status with clear error message if not matched
โข Show "Match to Job" button in UI if unmatched
โข Allow AI review on unmatched estimates
โข Start review without construction context
---

## RULE #08.002: Onedrive Plan Folder Structure

RULE:
MUST: MUST search folders:
โข Search entire OneDrive (security risk)
โข Use different folder names without updating constant
โข Skip folder validation
---

## RULE #08.003: Pdf File Size Limit

RULE:
MUST: โข Check file size before download
โข Skip files > 20MB
โข Return error if NO valid PDFs found after filtering
โข Attempt to send files > 20MB to Claude API
โข Download large files unnecessarily
โข Proceed without plan documents
---

## RULE #08.004: Async Processing with Background Jobs

RULE:
MUST: โข Return 202 Accepted immediately with review_id
โข Enqueue AiReviewJob with estimate_id
โข Set initial status to 'pending', update to 'processing' in job
โข Frontend MUST poll for status (every 5 seconds recommended)
โข Process review synchronously (causes request timeout)
โข Block HTTP request waiting for Claude API response
โข Assume review completes instantly
---

## RULE #08.005: Claude API Model and Prompt Structure

RULE:
MUST: โข Use exact model ID: `claude-3-5-sonnet-20241022`
โข Send PDFs as base64-encoded documents with MIME type `application/pdf`
โข Request JSON response format with specific schema
โข Include estimate line items in prompt for comparison context
โข Set max_tokens to 4096 minimum
โข Use older Claude models (lack PDF support)
โข Send PDFs as text (loses formatting)
โข Omit response format instructions
โข Exceed token limits with oversized prompts
---

## RULE #08.006: Discrepancy Detection Logic

RULE:
MUST: MUST categorize as:
MUST use fuzzy matching:
โข Remove non-alphanumeric characters from item descriptions
โข Case-insensitive comparison
โข Match by category + description
โข Require exact string match (causes false negatives)
โข Ignore category in matching (causes false positives)
โข Use < 10% threshold for mismatches (too strict)
---

## RULE #08.007: Confidence Score Calculation

RULE:
MUST: MUST calculate:
MUST store:
โข `confidence_score` - Final score (0-100)
โข `items_matched` - Count of matched items
โข `items_mismatched` - Count of quantity mismatches
โข `items_missing` - Count of missing items
โข `items_extra` - Count of extra items
โข Return confidence > 100 or < 0
โข Use equal penalty weights for all discrepancy types
โข Skip confidence calculation
---

## RULE #08.008: Error Handling and Status Updates

RULE:
MUST: MUST handle errors:
โข `NoConstructionError` - Estimate not matched
โข `OneDriveNotConnectedError` - OneDrive credential missing
โข `PDFNotFoundError` - No valid PDFs in plan folders
โข `FileTooLargeError` - All PDFs exceed 20MB limit
โข `Anthropic::Error` - Claude API errors (rate limit, auth, etc.)
โข `StandardError` - Generic catch-all
MUST update review record:
โข Leave review in 'processing' state on error (orphaned record)
โข Expose sensitive error details to client
โข Retry automatically without user intervention
---

## RULE #08.009: Prevent Duplicate Processing Reviews

RULE:
MUST: MUST check:
โข Query for existing review with `status: processing`
โข Return 422 error if found
โข Allow new review only if previous is completed/failed
โข Allow concurrent reviews on same estimate
โข Overwrite existing processing review
---

# Chapter 9: Purchase Orders

**Last Updated:** 2025-11-18 00:22 AEST

## RULE #09.001: Payment Status Calculation

RULE:
NEVER: NEVER set `payment_status` directly
ALWAYS use `determine_payment_status(amount)`
---

## RULE #09.002: Smart Lookup - Supplier Selection Priority

RULE:
NEVER: NEVER randomly select supplier
ALWAYS use SmartPoLookupService priority cascade
---

## RULE #09.003: Line Items - Totals Calculation

RULE:
NEVER: NEVER save PO without recalculating totals
ALWAYS use `before_save` callback
---

## RULE #09.004: Schedule Task Linking

RULE:
NEVER: NEVER link without unlinking previous
ALWAYS use transaction for task linking
---

## RULE #09.005: Price Drift Monitoring

RULE:
NEVER: NEVER ignore price drift
ALWAYS calculate drift percentage
---

## RULE #09.006: Po Number Generation - Race Condition Protection

RULE:
NEVER: NEVER generate PO numbers without lock
ALWAYS use `pg_advisory_xact_lock` in transaction
---

## RULE #09.007: Status State Machine

RULE:
NEVER: NEVER skip status steps
ALWAYS validate transitions
---

# Chapter 10: Gantt & Schedule Master

**Last Updated:** 2025-11-18 00:22 AEST

## RULE #10.001: Predecessor ID Conversion

RULE:
NEVER: NEVER use sequence_order directly in predecessor lookups
ALWAYS convert: `predecessor_id = sequence_order + 1`
---

## RULE #10.002: Isloadingdata Lock Timing

RULE:
NEVER: NEVER reset isLoadingData in drag handler
ALWAYS reset in useEffect with 1000ms timeout
---

## RULE #10.003: Company Settings - Working Days & Timezone

RULE:
NEVER: NEVER hardcode working days or ignore company timezone
ALWAYS read from: `company_settings.working_days` and `company_settings.timezone`
---

## RULE #10.004: Lock Hierarchy

RULE:
NEVER: NEVER cascade to locked tasks
ALWAYS check all 5 locks before cascade
---

## RULE #10.005: Task Heights Configuration

RULE:
MUST: MUST set all three to same value:
NEVER have mismatched height values
---

## RULE #10.006: Auto-scheduling

RULE:
NEVER: NEVER enable: `gantt.config.auto_scheduling = true`
ALWAYS set: `gantt.config.auto_scheduling = false`
---

## RULE #10.007: Api Pattern - Single Update + Cascade Response

RULE:
NEVER: NEVER make multiple API calls for cascade updates
ALWAYS use: Single update + cascade response pattern
---

## RULE #10.008: Useref Anti-loop Flags

RULE:
MUST: MUST use all 7 useRef flags correctly:
---

## RULE #10.009: Predecessor Format

RULE:
NEVER: NEVER save without predecessor_ids
ALWAYS include predecessor_ids in every update
---

## RULE #10.010: Cascade Triggers

RULE:
---

## RULE #10.011: Debounced Render Pattern

RULE:
NEVER: NEVER call gantt.render() directly
ALWAYS use debounced render:
---

## RULE #10.012: Column Documentation - Cc_update Table

RULE:
NEVER: NEVER change Schedule Master columns without updating CC_UPDATE table
ALWAYS update NewFeaturesTab.jsx when column implementation changes
---

# Chapter 11: Project Tasks & Checklists

**Last Updated:** 2025-11-18 00:22 AEST

## RULE #11.001: Task Status Lifecycle & Automatic Date Updates

RULE:
MUST: MUST update dates automatically:
โข Allow status to skip lifecycle stages (not_started โ complete without in_progress)
โข Overwrite existing actual dates when status changes again
โข Leave progress_percentage < 100 when status is complete
---

## RULE #11.002: Task Dependencies & Circular Dependency Prevention

RULE:
MUST: MUST validate:
โข Allow task to depend on itself (self-dependency)
โข Allow circular chains (A depends on B, B depends on C, C depends on A)
โข Allow cross-project dependencies
โข Allow duplicate dependencies (same predecessor + successor pair)
---

## RULE #11.003: Automatic Task Spawning from Templates

RULE:
MUST: MUST implement via TaskSpawner service:
MUST trigger spawning on status changes:
โข Spawn tasks multiple times (check if already spawned)
โข Spawn tasks without checking template configuration
โข Create circular parent-child relationships
โข Skip sequence ordering for subtasks (causes display chaos)
---

## RULE #11.004: Supervisor Checklist Template-to-instance Flow

RULE:
MUST: MUST copy templates to instances during job instantiation:
โข Share checklist items across tasks (each task gets own copies)
โข Allow checklist item deletion after task starts
โข Skip category validation (required for filtering)
โข Store User FK for completed_by (store username string for flexibility)
---

## RULE #11.005: Response Type Validation & Photo Upload

RULE:
MUST: MUST validate before marking complete:
MUST use Cloudinary for photo storage:
โข Allow completion without required response data
โข Store photos in Rails backend (use Cloudinary)
โข Skip folder organization in Cloudinary (use job-specific folders)
โข Allow checklist item updates after completion (completed_at is immutable)
---

## RULE #11.006: Auto-complete Predecessors Feature

RULE:
MUST: MUST implement via callback:
MUST show checkbox in task form:
โข Auto-complete tasks with incomplete subtasks (check has_subtasks)
โข Skip audit trail (add completion_notes explaining auto-completion)
โข Allow infinite recursion (predecessors don't trigger their own predecessors)
โข Auto-complete milestones (they should be explicitly completed)
---

## RULE #11.007: Materials Status Calculation

RULE:
MUST: MUST include in task serialization:
MUST show status badges:
โข Store materials_status in database (always calculate)
โข Show materials status for tasks without critical_po flag
โข Allow task to start if materials_status = 'delayed' (warn user)
โข Skip materials check during schedule cascade calculations
---

## RULE #11.008: Sequence Order for Task Display

RULE:
MUST: MUST set sequence on creation:
MUST index for efficient sorting:
โข Use random sequence numbers (breaks visual grouping)
โข Allow gaps larger than 1.0 between top-level tasks
โข Use sequence > 9.9 for subtasks (use 9 or fewer subtasks per parent)
โข Resort entire project when adding one task (use smart insertion)
---

## RULE #11.009: Task Update Audit Trail

RULE:
---

## RULE #11.010: Duration Days Validation

RULE:
MUST: MUST validate:
โข Allow duration_days = 0 (causes same-day start/end, confusing)
โข Allow negative durations (logically impossible)
โข Skip duration validation on updates
โข Use decimal durations (always integer days)
---

## RULE #11.011: Tags System for Flexible Categorization

RULE:
MUST: MUST use GIN index for efficient queries:
MUST include tags in serialization:
โข Store tags as comma-separated string (use JSONB array)
โข Allow duplicate tags in array
โข Skip GIN index (queries will be slow)
โข Use tags for data that should be proper associations (e.g., don't tag "assigned_to_john", use assigned_to FK)
---

# Chapter 12: Weather & Public Holidays

**Last Updated:** 2025-11-18 00:22 AEST

## RULE #12.001: Unique Holidays Per Region

RULE:
MUST: โข Validate uniqueness: `validates :date, uniqueness: { scope: :region }`
โข Use region codes: QLD, NSW, VIC, SA, WA, TAS, NT, NZ
โข Store date in UTC (no time component)
โข Allow duplicate holidays for same date + region
โข Use inconsistent region codes
โข Store holidays with time components
---

## RULE #12.002: Rain Log - One Entry Per Construction Per Day

RULE:
MUST: โข Enforce uniqueness at database level: `UNIQUE(construction_id, date)`
โข Check for existing log before auto-creation
โข Use `find_or_initialize_by` pattern for updates
โข Create multiple rain logs for same job + date
โข Override existing automatic logs without checking source
โข Allow future-dated rain logs
---

## RULE #12.003: Rainfall Severity Auto-calculation

RULE:
MUST: MUST calculate severity as:
โข Light: `< 5mm`
โข Moderate: `5mm to 15mm`
โข Heavy: `> 15mm`
โข Auto-calculate on create if `rainfall_mm` present
โข Recalculate on update if `rainfall_mm` changes
โข Allow nil severity if `rainfall_mm` is nil or 0
โข Allow manual severity override without rainfall_mm
โข Use different thresholds without updating constants
โข Skip calculation for automatic entries
---

## RULE #12.004: Manual Rain Logs Require Notes

RULE:
MUST: โข Validate presence: `validates :notes, presence: true, if: :source_manual?`
โข Display notes in UI for audit trail
โข Include who created the entry (`created_by_user_id`)
โข Allow blank notes for manual entries
โข Skip audit trail for manual modifications
โข Allow automatic entries to have editable notes
---

## RULE #12.005: Weather API - Historical Data Only

RULE:
MUST: โข Validate date is not in future before API call
โข Use `Date.yesterday` for automatic checks
โข Raise `ArgumentError` if future date provided
โข Call weather API for today or future dates
โข Use weather forecasts (not historical data)
โข Proceed with API call if date validation fails
---

## RULE #12.006: Location Extraction Priority

RULE:
MUST: MUST follow priority:
โข Use random location extraction order
โข Fail silently if location cannot be determined
โข Use company address as fallback (wrong location)
---

## RULE #12.007: Gantt Integration - Working Day Calculation

RULE:
MUST: โข Load company `working_days` configuration
โข Load `PublicHoliday` dates for relevant region (3-year range)
โข Skip task to next working day if lands on weekend OR holiday
โข Respect lock hierarchy (locked tasks can stay on holidays)
โข Check only weekends without holidays
โข Check only holidays without weekends
โข Override locked task dates
โข Use different holiday lookups across services
---

## RULE #12.008: Weather API Response Storage

RULE:
MUST: โข Store complete API JSON response
โข Include location confirmation data
โข Preserve all weather metrics (temp, condition, etc.)
โข Use for future analysis and verification
โข Store only rainfall value
โข Discard API response after extraction
โข Modify API response before storage
---

# Chapter 13: OneDrive Integration

**Last Updated:** 2025-11-18 00:22 AEST

## RULE #13.001: Folder Template System

RULE:
NEVER: NEVER hardcode folder names
ALWAYS respect template customizations
---

## RULE #13.002: Root Folder Management

RULE:
NEVER: NEVER create folders at OneDrive root level
ALWAYS use `root_folder_id` from credential
---

## RULE #13.003: Organization-wide Authentication

RULE:
NEVER: NEVER require each user to authenticate separately
ALWAYS store single credential for entire organization
---

## RULE #13.004: Pricebook Image Sync

RULE:
NEVER: NEVER rely solely on OneDrive for image display
ALWAYS upload to Cloudinary after OneDrive upload
---

## RULE #13.005: File Upload Chunking

RULE:
NEVER: NEVER use simple upload for files >4MB
ALWAYS use resumable upload session
---

# Chapter 14: Outlook/Email Integration

**Last Updated:** 2025-11-18 00:22 AEST

## RULE #14.001: Organization-wide Singleton Oauth Credential

RULE:
MUST: MUST implement as singleton:
MUST auto-refresh tokens before expiration:
โข Store multiple Outlook credentials (one organization = one credential)
โข Store tokens unencrypted
โข Let tokens expire without auto-refresh
โข Hardcode token expiration buffer (always use 5-minute safety margin)
---

## RULE #14.002: Four-strategy Email-to-job Matching

RULE:
MUST: MUST implement all 4 strategies:
MUST auto-assign on email creation:
โข Skip matching strategies (must try all 4 in order)
โข Match to inactive/archived jobs
โข Auto-assign to wrong construction (false positive worse than nil)
โข Allow email creation without attempting match
---

## RULE #14.003: Microsoft Graph API Usage Pattern

RULE:
MUST: MUST use Graph API v1.0:
MUST request these scopes:
โข Use Outlook REST API v2.0 (deprecated, use Graph API)
โข Request more scopes than needed (principle of least privilege)
โข Skip $select parameter (bandwidth waste - emails can be large)
โข Use synchronous API calls without pagination
---

## RULE #14.004: Email Threading Support Via Message-id

RULE:
MUST: MUST include threading fields:
MUST populate threading fields:
โข Allow duplicate message_id (unique constraint required)
โข Skip message_id extraction (breaks threading)
โข Store references as array (use text with space-separated values per RFC 2822)
---

## RULE #14.005: Webhook Support for Email Services

RULE:
MUST: MUST implement webhook receiver:
โข Return error status for webhook (email providers will retry, causing duplicates)
โข Skip duplicate detection (check message_id uniqueness)
โข Process webhook synchronously (use background job for heavy parsing)
---

## RULE #14.006: Inbound-only Architecture (current Limitation)

RULE:
---

# Chapter 15: Chat & Communications

**Last Updated:** 2025-11-18 00:22 AEST

## RULE #15.001: Chatmessage Multi-channel Architecture

RULE:
MUST: MUST define channel types:
MUST route messages correctly:
---

## RULE #15.002: Message-to-job Linking

RULE:
MUST: MUST provide save-to-job endpoints:
MUST include construction_id foreign key:
MUST allow bulk conversation saving:
---

## RULE #15.003: Sms Twilio Integration

RULE:
MUST: MUST centralize Twilio operations:
MUST handle incoming SMS webhooks:
MUST support Australian phone formats:
---

## RULE #15.004: Sms Status Tracking

RULE:
MUST: MUST define status states:
MUST accept Twilio status webhooks:
MUST show status icons:
---

## RULE #15.005: Unread Message Tracking

RULE:
MUST: MUST add read timestamp:
MUST provide unread count endpoint:
MUST poll for unread count:
---

## RULE #15.006: Message Polling (no Websockets)

RULE:
MUST: MUST poll at 3-second intervals:
MUST poll SMS messages:
NEVER use WebSockets:
โข WebSocket infrastructure not implemented
โข ActionCable not configured
โข All real-time updates via polling
---

## RULE #15.007: Contact-sms Fuzzy Matching

RULE:
MUST: MUST support partial phone matches:
---

## RULE #15.008: Message Deletion Authorization

RULE:
MUST: MUST verify ownership:
NEVER allow:
โข Admins deleting other users' messages (not implemented)
โข Bulk message deletion without ownership check
โข Deletion of messages saved to jobs without audit trail
---

## RULE #15.009: Email Ingestion Storage

RULE:
MUST: MUST store email metadata:
MUST include fields:
---

## RULE #15.010: Authentication Placeholder - Critical TODO

RULE:
MUST: MUST implement proper authentication:
NEVER use in production:
โข `User.first` placeholder
โข Hardcoded user IDs
โข Session-less chat without auth
---

# Chapter 16: Xero Accounting Integration

**Last Updated:** 2025-11-18 00:22 AEST

## RULE #16.001: Oauth Token Management

RULE:
NEVER: NEVER store API keys in plaintext
ALWAYS encrypt tokens using ActiveRecord Encryption
---

## RULE #16.002: Two-way Contact Sync

RULE:
NEVER: NEVER assume single-direction sync
ALWAYS check `sync_with_xero` flag before syncing
ALWAYS update `last_synced_at` timestamp
---

## RULE #16.003: Invoice Matching

RULE:
NEVER: NEVER sync payments without invoice match
ALWAYS validate invoice total vs PO total
ALWAYS store `xero_invoice_id` on PurchaseOrder
---

## RULE #16.004: Webhook Signature Verification

RULE:
NEVER: NEVER process webhooks without signature verification
ALWAYS use `XERO_WEBHOOK_KEY` from environment
---

## RULE #16.005: Rate Limiting & Error Handling

RULE:
NEVER: NEVER retry immediately on 429 errors
ALWAYS implement exponential backoff
ALWAYS log failed requests for debugging
---

## RULE #16.006: Tax Rates & Chart of Accounts

RULE:
NEVER: NEVER hardcode tax codes
ALWAYS fetch from Xero and cache locally
---

## RULE #16.007: Background Job Processing

RULE:
NEVER: NEVER sync contacts in HTTP request
ALWAYS use `XeroContactSyncJob` via Solid Queue
ALWAYS provide job progress tracking
---

## RULE #16.008: Payment Sync Workflow

RULE:
NEVER: NEVER create Xero payment before local Payment record
ALWAYS link Payment to PurchaseOrder
---

# Chapter 17: Payments & Financials

**Last Updated:** 2025-11-18 00:22 AEST

## RULE #17.001: Payment Method Enum

RULE:
MUST: MUST restrict to valid methods:
MUST provide method selector:
---

## RULE #17.002: Xero Payment Sync

RULE:
MUST: MUST validate and sync:
---

## RULE #17.003: Payment Model Structure

RULE:
MUST: MUST include core fields:
MUST use DECIMAL(15,2) for precision:
---

## RULE #17.004: Automatic Payment Status Updates

RULE:
MUST: MUST trigger on payment save/destroy:
MUST define payment status states:
---

## RULE #17.005: Xero Invoice Fuzzy Matching

RULE:
MUST: MUST implement matching hierarchy:
MUST update PO with invoice data:
---

## RULE #17.006: Financial Precision with Decimal(15,2)

RULE:
MUST: MUST use DECIMAL type:
MUST validate precision:
NEVER use FLOAT:
โข Causes rounding errors in currency calculations
โข Example: `0.1 + 0.2 = 0.30000000000000004` (FLOAT)
โข DECIMAL: `0.10 + 0.20 = 0.30` (exact)
---

## RULE #17.007: Payment Status Badge Display

RULE:
MUST: MUST use semantic colors:
---

## RULE #17.008: Payment Summary Calculation

RULE:
MUST: MUST include summary:
MUST show summary prominently:
---

## RULE #17.009: Budget Variance Tracking

RULE:
MUST: MUST calculate variances:
MUST highlight overages:
---

## RULE #17.010: Cascade Delete Payments

RULE:
MUST: MUST set dependent: :destroy:
NEVER orphan payments:
โข Deleting PO without deleting payments breaks referential integrity
โข Payment without PO is meaningless
โข Use `dependent: :destroy` not `dependent: :nullify`
---

# Chapter 18: Workflows & Automation

**Last Updated:** 2025-11-18 00:22 AEST

## RULE #18.001: Batch Processing with Rate Limiting

RULE:
MUST: MUST batch and throttle:
---

## RULE #18.002: Solid Queue Background Job System

RULE:
MUST: MUST configure Solid Queue:
MUST inherit from ApplicationJob:
---

## RULE #18.003: Workflow State Machine

RULE:
MUST: MUST implement state machine:
MUST auto-advance on step completion:
---

## RULE #18.004: Idempotent Background Jobs

RULE:
MUST: MUST check completion status:
MUST verify record doesn't exist:
---

## RULE #18.005: Price Update Automation

RULE:
MUST: MUST implement price application:
---

## RULE #18.006: Model Callback Automation

RULE:
MUST: MUST update dependent data:
MUST trigger child creation:
MUST track changes:
---

## RULE #18.007: Job Status Tracking

RULE:
MUST: MUST provide status visibility:
MUST show percentage:
---

## RULE #18.008: Workflow Metadata Storage

RULE:
MUST: MUST support all workflow types:
MUST collect metadata:
---

# Chapter 19: Custom Tables & Formulas

**Last Updated:** 2025-11-18 00:22 AEST

## RULE #19.001: Dynamic Table Creation Pattern

RULE:
MUST: MUST use auto-generated unique name:
MUST create ActiveRecord model at runtime:
โข Use table names without prefix
โข Allow reserved names: `["user", "users", "table", "tables", "column", "columns", "record", "records"]`
โข Reuse database_table_name across tables
---

## RULE #19.002: Column Type System

RULE:
MUST: MUST map column types correctly:
MUST use TableBuilder for physical schema changes:
---

## RULE #19.003: Formula Evaluation System

RULE:
MUST: MUST support curly brace references:
MUST evaluate formulas safely:
MUST flag columns with cross-table refs:
---

## RULE #19.004: Lookup Column Pattern

RULE:
MUST: MUST create associations dynamically:
MUST batch-load related records:
MUST return id + display value:
---

## RULE #19.005: Record CRUD with Formula Calculation

RULE:
MUST: MUST calculate formulas on save:
MUST transform computed values on read:
---

## RULE #19.006: Table Deletion Safety

RULE:
MUST: MUST validate before deletion:
MUST drop database table:
---

## RULE #19.007: Column Validation Rules

RULE:
MUST: MUST enforce validation rules:
MUST validate record data before save:
---

## RULE #19.008: Foreign Key Constraints

RULE:
MUST: MUST add foreign keys for lookups:
NEVER use on_delete: :cascade for lookup columns (data loss risk)
---

# Chapter 20: UI/UX Standards & Patterns

**Last Updated:** 2025-11-18 00:22 AEST

## RULE #20.001: Column Resizing Standards

RULE:
MUST: ---

## RULE #20.002: Column Search/filter Requirements (required)

RULE:
MUST: ---

## RULE #20.003: Checkbox Column Must Be First, Locked, Minimal Size

RULE:
MUST: The first column MUST be a checkbox for row selection with locked position and minimal size.

Width: 32px (minimal size to fit checkbox). Padding: px-1 (minimal horizontal padding). Non-resizable (locked size). Non-reorderable (always first). Centered alignment (header and cells).

## RULE #20.004: Table Header Requirements

RULE:
MUST: ---

## RULE #20.005: Column Reordering Standards

RULE:
NEVER: โข Put entire header in one onClick handler
โข Make drag handle sortable
โข Forget `e.stopPropagation()` on drag handle
---

## RULE #20.006: Column Visibility Toggle (required)

RULE:
NEVER: โข Allow hiding ALL columns
โข Hide actions column
โข Forget localStorage persistence
---

## RULE #20.007: Column Width Persistence (required)

RULE:
MUST: ---

## RULE #20.008: Scroll Behavior Standards

RULE:
MUST: MUST implement for scrollable tables:
โข Use `flex` layout with `flex-1 min-h-0 flex flex-col` on container
โข Scrollable area: `overflow-y-scroll overflow-x-auto`
โข Sync horizontal scroll between main container and sticky scrollbar via refs
โข Track scrollWidth with `ResizeObserver` for dynamic updates
โข Custom scrollbar styling via webkit pseudo-elements
โข Thin scrollbars: `scrollbar-width: thin` for Firefox
โข Use `overflow: hidden` on flex containers (prevents scrolling)
โข Forget `min-h-0` on flex children (causes overflow issues)
โข Skip scroll sync between container and sticky scrollbar
โข Use inline scroll handlers without refs (performance issue)
---

## RULE #20.009: Column Width Standards

RULE:
MUST: MUST set widths consistently:
โข `<th>`: `style={{ width: `${width}px`, minWidth: `${width}px` }}`
โข `<td>`: `style={{ width: `${width}px`, minWidth: `${width}px`, maxWidth: `${width}px` }}`
---

## RULE #20.010: Cell Content Standards

RULE:
MUST: ---

## RULE #20.011: Row Interaction Standards

RULE:
MUST: MUST implement:
โข Selection column minimum width: 50px (never smaller)
โข Selection column always visible (exclude from visibility toggles)
โข Selection column excluded from column reordering (always leftmost)
โข Add explicit size classes to checkboxes (`h-4 w-4` OK, but browser default preferred)
โข Make selection column draggable
โข Include selection column in columnOrder state
โข Allow selection column to be hidden via visibility toggles
โข Allow selection column to be reordered (must stay leftmost)
---

## RULE #20.012: Column Visibility Standards

RULE:
MUST: ---

## RULE #20.013: Search & Filter UI Standards

RULE:
MUST: ---

## RULE #20.014: Table Toolbar Layout Standards (required)

RULE:
NEVER: โข Put search on right side
โข Use different button heights
โข Stack toolbar vertically
โข Add gap between search and first button
---

## RULE #20.015: Empty States

RULE:
MUST: MUST differentiate:
---

## RULE #20.016: State Persistence Standards

RULE:
MUST: MUST persist to localStorage:
โข Use generic keys (collision risk)
โข Persist without try/catch
โข Forget defaults
---

## RULE #20.017: Sorting Standards

RULE:
MUST: MUST support:
โข Primary/secondary sort
โข 3-state cycle: asc โ desc โ none
---

## RULE #20.018: Dark Mode Requirements

RULE:
NEVER: โข Use light-mode-only colors
โข Use pure white/black (use gray-50/gray-900)
---

## RULE #20.019: Performance Standards

RULE:
MUST: MUST memoize when:
โข Filtering large datasets (>100 rows)
โข Sorting complex data
โข Computing derived values
โข Filter/sort without memoization
โข Create inline functions in map()
---

## RULE #20.020: Accessibility Standards

RULE:
MUST: MUST support:
โข Tab through interactive elements
โข Enter/Space to trigger actions
โข `scope="col"` on `<th>` elements
โข `aria-label` on icon-only buttons
โข Semantic HTML (`<table>`, `<thead>`, `<tbody>`)
โข `sr-only` text for icons
---

## RULE #20.021: Table Container Must Have Visible Borders on All Sides

RULE:
MUST: Table container MUST have visible borders on all four sides (top, right, bottom, left).

Full border on all four sides of table container. Border color: gray-200 (dark: gray-700). Horizontal margin (mx-4) to align with search bar above. Borders frame the entire table content including top and bottom. Creates a complete bordered box around the table.

## RULE #20.022: Native Browser Scrollbars Styled with Blue Theme

RULE:
MUST: Native browser scrollbars MUST be styled with blue theme matching the header color.

Light mode: Track #E0E7FF (light blue), Thumb #2563EB (blue-600 matching header), Hover #1D4ED8. Dark mode: Track #1E293B (dark slate), Thumb #1E40AF (blue-800), Hover #1E3A8A. Removed sticky horizontal scrollbar due to duplicate display issue.

## RULE #20.023: Search Functionality Standards

RULE:
MUST: ---

## RULE #20.024: Form Standards

RULE:
MUST: MUST include for all inputs:
โข Label with `htmlFor` matching input `id`
โข Dark mode styling
โข Focus states (indigo ring)
โข Error state styling
---

## RULE #20.025: Table Headers MUST Provide Visual Cursor Feedback

RULE:
MUST: All interactive table header elements must display appropriate cursor styles to indicate their functionality.

Column headers that support resizing must show col-resize cursor. Drag handles (three-dot icons) must show grab cursor when hovering and grabbing when dragging. Sortable headers must show pointer cursor.

## RULE #20.026: Table Headers and Content MUST Use Differentiated Font Sizes

RULE:
MUST: Table headers must use 18px bold font. Table rows must use 14px regular font. Both must use system font stack for native appearance.

Header font: 18px bold weight for visual hierarchy and emphasis. Row font: 14px regular weight for optimal data density and readability. Font family must use system font stack: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica Neue, Arial, sans-serif. Apply styles inline for maximum specificity.

## RULE #20.027: Loading State Standards

RULE:
MUST: ---

## RULE #20.028: Content and Title Columns MUST Be Clickable to View Full Details

RULE:
MUST: Only the Content and Title columns should open a modal when clicked. Other columns (Type, Chapter, Section, Status, Severity, Actions, Select) must not trigger the modal.

Modal opens ONLY when clicking Content or Title cells - these are the columns with truncated data. Click handlers with stopPropagation prevent modal on other columns. Cursor pointer only appears on Content and Title columns. Select column checkboxes and Action buttons remain functional without opening modal.

## RULE #20.029: Status Badge Standards

RULE:
MUST: ---

## RULE #20.030: Empty State Standards

RULE:
MUST: MUST differentiate:
---

## RULE #20.031: Navigation Standards

RULE:
MUST: ---

## RULE #20.032: Chapter 19 Documentation Maintenance (required)

RULE:
MUST: MUST update Chapter 19 when:
โข Adding new table features
โข Modifying existing table patterns
โข Creating new components
โข Changing standard UI patterns
โข Adding new requirements
โข Discovering missing features
โข Make table changes without updating Chapter 19
โข Create custom patterns not documented
โข Skip timestamp update
โข Forget to commit Bible with code
---

## RULE #20.033: Touch Target Sizes & Click Areas

RULE:
NEVER: โข Create interactive elements < 44px without compensating padding
โข Place elements closer than 8px
โข Assume mouse users only
---

## RULE #20.034: Data-dense Table Layout Pattern

RULE:
MUST: MUST use compact layout for data-heavy tables:
โข Compact padding on rows and headers
โข Cell truncation with hover tooltips
โข Row expansion for full content
โข Use spacious padding (`py-6`) for data-dense tables
โข Skip expansion mechanism for truncated content
---

## RULE #20.035: Zebra Striping (alternating Row Colors)

RULE:
MUST: MUST use zebra striping for wide tables (> 7 columns):
โข Alternating row colors for horizontal tracking
โข Sufficient contrast in both light and dark modes
โข Maintain pattern when filtering/sorting
โข Use too subtle colors (insufficient contrast)
โข Remove zebra on hover (both should be visible)
โข Use zebra on narrow tables (< 5 columns)
---

## RULE #20.036: Sticky Horizontal Scrollbar Pattern

RULE:
MUST: MUST ALWAYS:
1. MUST use ref flags to prevent infinite scroll loops:
โข `isScrollingStickyRef` - Set when sticky scrollbar scrolls
โข `isScrollingMainRef` - Set when main container scrolls
โข Check flags at start of handlers and return early if set
2. MUST hide native horizontal scrollbar when using custom sticky scrollbar:
[Code example - see code_example field]
[Code example - see code_example field]
3. MUST measure actual table element for scrollbar width:
[Code example - see code_example field]
4. MUST position sticky scrollbar with `position: sticky` and `bottom: 0`
5. MUST use ResizeObserver to update scrollbar on column resize
1. NEVER use placeholder values in scroll loop - causes infinite loops
2. NEVER measure container scrollWidth - use actual table offsetWidth instead
3. NEVER use overflow-x-hidden on main container - breaks horizontal scrolling
4. NEVER forget to sync scrollLeft in both directions (main โ sticky)
๐ Implementation Checklist:
โข [ ] Scroll loop prevention refs created (`isScrollingStickyRef`, `isScrollingMainRef`)
โข [ ] Main scroll handler syncs to sticky scrollbar
โข [ ] Sticky scroll handler syncs to main container
โข [ ] ResizeObserver updates scrollbar width on changes
โข [ ] Native horizontal scrollbar hidden (CSS + inline styles)
โข [ ] Sticky scrollbar positioned with `position: sticky, bottom: 0`
โข [ ] Table has `minWidth` based on sum of column widths
โข [ ] Default column widths ensure horizontal overflow on most screens

## RULE #20.037: Modern Table Header Aesthetics

RULE:
MUST: MUST apply glass-morphism effect to table headers:
โข Semi-transparent background with backdrop blur
โข Subtle shadow and borders
โข Small font size with medium weight
โข Subtle colors in light and dark modes
โข Use solid opaque backgrounds (loses modern effect)
โข Use heavy font weights (`font-bold`, `font-semibold`)
โข Use bright or saturated header colors
---

## RULE #20.038: Table Border Framing

RULE:
MUST: MUST add complete border framing for full-width tables:
โข Left and right borders on `<table>` element
โข Consistent border colors in light and dark modes
โข Provides visual container boundary
โข Skip borders on full-width tables
โข Use incomplete framing (border-b or border-t only)
โข Apply borders to container div instead of table element
---

## RULE #20.039: Expand/collapse Row Details Pattern

RULE:
MUST: MUST implement for tables with detailed content:
โข Expand icon with click entire row to toggle
โข Expanded row spans all columns with visual separation
โข Use `Set` for tracking expansion state (performance)
โข Properly formatted content in expanded view
โข Make only icon clickable (bad UX)
โข Use array for expandedRows (slow lookup)
โข Skip colSpan (content constrained to first column)
โข Forget click event propagation on nested elements
---

## RULE #20.040: Cascading Filter Pattern

RULE:
MUST: MUST use cascading filters for multi-level hierarchical data:
When to Use:
โข Tables with 2+ filterable dimensions (Chapter โ Type, Category โ Subcategory, etc.)
โข Data has clear parent-child relationships
โข Filtering one dimension narrows options in dependent dimensions
How Cascading Works:
โข Filters go left-to-right (broader โ narrower)
โข Parent filter (left) affects child filter options (right)
โข Changing parent filter resets child filters to "All"
โข Show dynamic counts: "MUST (18)", "NEVER (5)", "PROTECTED (0)"
โข Disable options with 0 count
Filter Hierarchy Example:
```
Chapter (Level 1) โ Type (Level 2) โ Status (Level 3)
โ โ โ
Affects Affects [End]
Type options Status options
```
โข Use bidirectional cascading (Chapter โ โ Type = circular dependency)
โข Skip memoization (causes performance issues)
โข Forget to reset downstream filters when upstream changes
โข Make filters cascade backwards (right-to-left)
Example (BibleTableView):
โข User selects "Chapter 9" โ Type filter shows: MUST (18), NEVER (5), PROTECTED (0 - disabled)
โข User selects "MUST" โ Shows only 18 Chapter 9 MUST rules
โข User changes to "Chapter 19" โ Type resets to "All", recalculates for Ch 19

## RULE #20.041: No Actions Column - Use Inline Bulk Actions Instead

RULE:
NEVER: โข Add an Actions column to tables with Edit/Delete buttons per row
โข Place action buttons in the rightmost column
โข Duplicate edit/delete functionality in both row actions and bulk actions
โข Show Delete button immediately when rows are selected
โข Use inline bulk action buttons that appear when rows are selected
โข Position bulk actions next to Columns button (h-[42px] alignment)
โข Implement Delete-after-Edit safety pattern
โข Hide Delete button until Edit is clicked first
Reference: TrinityTableView.jsx removed Actions column, added inline bulk buttons

## RULE #20.042: All Custom Action Buttons MUST Use H-[42px] Alignment

RULE:
ALWAYS: ALL custom action buttons in Trinity tables (Add, Import, Export, Sync, etc.) MUST use h-[42px] for perfect toolbar alignment with search bar and Columns button

# Chapter 21: Agent System & Automation

**Last Updated:** 2025-11-18 00:22 AEST

## RULE #21.001: Agent Definitions Are Database-driven

RULE:
MUST: โข Store all agent metadata in database
โข Update run history after each agent execution
โข Use API endpoints to manage agents
โข Track success/failure rates
โข Maintain agent priority order
โข Hardcode agent configurations in code
โข Skip recording agent runs
โข Modify `.claude/agents/*.md` files without updating database
โข Create agents without database entries
---

## RULE #21.002: Agent Invocation Protocol

RULE:
MUST: โข Check if agent exists and is active
โข Record run start timestamp
โข Execute agent task
โข Record success or failure with details
โข Return comprehensive result
โข Invoke inactive agents
โข Skip recording run results
โข Return vague error messages
โข Execute agents without user context
---

## RULE #21.003: Run History Tracking

RULE:
MUST: โข Record total_runs, successful_runs, failed_runs
โข Store last_run_at timestamp
โข Save last_status and last_message
โข Include detailed last_run_details (JSONB)
โข Calculate success_rate automatically
โข Skip recording runs
โข Overwrite historical run data
โข Record runs for testing/debugging
โข Fake success/failure status
---

## RULE #21.004: Agent Types and Specialization

RULE:
MUST: โข Assign agent_type: `development`, `diagnostic`, `deployment`, or `planning`
โข Define clear focus area (e.g., "Rails API Backend Development")
โข Specify tools available to agent
โข Document when to use each agent
โข Provide example invocations
โข Create overlapping agent responsibilities
โข Use generic agent for specialized tasks
โข Skip documenting agent capabilities
โข Create agents without clear purpose
---

## RULE #21.005: Agent Priority and Display Order

RULE:
MUST: โข Set priority field (0-100)
โข Display agents sorted by: priority DESC, name ASC
โข Show active agents first
โข Hide inactive agents from main list
โข Display agents alphabetically only
โข Show inactive agents in main list
โข Change priority without reason
---

## RULE #21.006: Agent Shortcuts and Invocation

RULE:
MUST: โข Support `run {agent-id}` (e.g., `run backend-developer`)
โข Support shortened versions (e.g., `backend dev`, `gantt`)
โข Document shortcuts in `example_invocations` field
โข Parse user input case-insensitively
โข Require exact agent_id match
โข Skip documenting shortcuts
โข Create conflicting shortcuts
---

## RULE #21.007: Recently Run Check (smart Testing)

RULE:
MUST: โข Check `last_run_at` timestamp
โข Compare to threshold (e.g., 60 minutes)
โข Skip redundant tests if recent successful run
โข ALWAYS re-run if last run failed
โข Ask user if uncertain
โข Skip tests without checking recency
โข Ignore failed runs in recency check
โข Use stale results without user awareness
---

## RULE #21.008: Shortcut Clarity - Agentshortcutstab Updates

RULE:
MUST: โข Update `frontend/src/components/settings/AgentShortcutsTab.jsx` when adding new shortcuts
โข Add new shortcuts to the `baseCommands` array
โข Ensure shortcuts match agent file definitions exactly
โข Use sequential IDs (avoid duplicates)
โข Document the shortcut pattern in the command field
โข Follow the format: `{ id: N, command: 'What Claude executes', shortcut: 'what user types, comma-separated' }`
โข Leave shortcuts undocumented
โข Create duplicate IDs in baseCommands array
โข Use shortcuts that contradict agent definitions
โข Hardcode shortcuts outside the table
---

## RULE #21.009: Creating New Agents - Complete Checklist

RULE:
MUST: MUST UPDATE (4 files):
โข Create an agent in only one location
โข Skip updating run-history.json
โข Forget to add to the controllers fallback list
โข Miss updating the frontend component
---
---

## RULE #21.010: Backend Developer Agent

RULE:
Triggers: /backend, backend dev
What it does:
1. Reads Trinity Bible chapters for backend architecture rules
2. Searches Lexicon for known backend bugs and API patterns
3. Analyzes Rails controllers, models, and database migrations
4. Implements API endpoints following RESTful conventions
5. Runs backend tests (RSpec) and fixes any failures
6. Updates database schema and handles migrations
7. Documents changes in Lexicon with dev_note entries

## RULE #21.011: Frontend Developer Agent

RULE:
Triggers: /frontend, frontend dev
What it does:
1. Reads Trinity Bible RULE #19 (Table Pattern) and UI chapters
2. Searches Lexicon for frontend component patterns and known UI bugs
3. Analyzes React components and identifies compliance issues
4. Implements/updates components following Table Pattern rules
5. Ensures dark mode support and responsive design
6. Runs npm build and fixes any ESLint/TypeScript errors
7. Documents component changes and patterns in Lexicon

## RULE #21.012: Production Bug Hunter Agent

RULE:
Triggers: /bug-hunter, bug hunter
What it does:
1. Checks Heroku production logs for errors and exceptions
2. Searches Lexicon for similar bugs previously encountered
3. Identifies root cause by analyzing stack traces
4. Reproduces bug locally if possible
5. Implements fix following Bible rules and patterns
6. Runs diagnostic tests to verify fix works
7. Documents bug and solution in Lexicon with bug_fix entry
8. Provides deployment recommendation

## RULE #21.013: Deploy Manager Agent

RULE:
Triggers: /deploy, deployment
What it does:
1. Runs full test suite (backend + frontend) to ensure stability
2. Checks git status and creates clean commit if needed
3. Uses git subtree to split backend directory for Heroku
4. Pushes to Heroku with force flag to deploy backend
5. Monitors Heroku logs during deployment
6. Runs database migrations on production if needed
7. Verifies deployment health with API health checks
8. Reports deployment status and any issues encountered

## RULE #21.014: Planning Collaborator Agent

RULE:
Triggers: /plan, planning
What it does:
1. Analyzes feature request and breaks down into tasks
2. Reads relevant Bible chapters for architecture guidance
3. Searches Lexicon for similar features and patterns
4. Identifies affected components (backend/frontend/database)
5. Creates step-by-step implementation plan
6. Estimates complexity and potential challenges
7. Provides recommendations for testing strategy
8. Suggests Bible chapter updates if new patterns emerge

## RULE #21.015: Gantt Bug Hunter Agent

RULE:
Triggers: /gantt, gantt bug hunter
What it does:
1. Reads Trinity Bible Chapter 7 (Gantt Chart rules)
2. Searches Lexicon for Gantt-specific bugs and patterns
3. Tests drag-and-drop functionality and cascade events
4. Validates timezone handling (Brisbane/Australia/Brisbane)
5. Checks working days enforcement and public holidays
6. Tests lock state and concurrent editing scenarios
7. Runs Gantt-specific diagnostic tests
8. Documents any Gantt bugs found in Lexicon

## RULE #21.016: Trinity Sync Validator Agent

RULE:
Triggers: /trinity, trinity sync
What it does:
1. Compares Trinity Bible database records vs markdown files
2. Checks Lexicon database vs markdown file consistency
3. Identifies missing, duplicate, or outdated entries
4. Validates chapter numbers and entry_types are correct
5. Checks for orphaned records in database
6. Runs export_bible and export_lexicon if needed
7. Reports sync status and any discrepancies found

## RULE #21.017: Ui Compliance Auditor Agent

RULE:
Triggers: /ui-audit, ui compliance
What it does:
1. Reads Trinity Bible Chapter 20 (UI/UX Standards & Patterns rules)
2. Reads Trinity Lexicon Chapter 20 (known UI/UX bugs and issues)
3. Reads Trinity Teacher Chapter 20 (UI/UX implementation examples)
4. Analyzes all Chapter 20 requirements across all three Trinity books
5. Scans all React components in frontend/src/pages and /components
6. Checks for standard table component usage and clear buttons
7. Identifies violations, missing features, and non-compliant patterns
8. Creates comprehensive TodoWrite list with specific actionable tasks
9. Prioritizes tasks by severity (critical, high, medium, low)
10. Provides step-by-step fix instructions for each violation
11. Generates detailed compliance report with before/after examples
12. Documents findings in Lexicon for future reference

## RULE #21.018: Run All Agents in Parallel

RULE:
Triggers: /all-agents, /ag
What it does:
Launches Backend Developer, Frontend Developer, Production Bug Hunter, Gantt Bug Hunter, Deploy Manager, Planning Collaborator, Trinity Sync Validator, and UI Compliance Auditor simultaneously.
Each agent runs independently and reports back with their findings. Use this for comprehensive project health checks and multi-area debugging.

## RULE #21.019: Modifying Existing Agents - Complete Checklist

RULE:
MUST UPDATE (3 locations - Database is source of truth):
NEW APPROACH (Following B01.013 - Single Source of Truth):
1. Database (Trinity - ONLY source of truth)
```ruby
# Update the agent in Trinity database
Trinity.find_by(
category: 'teacher',
chapter_number: 21,
section_number: '21.15'
).update!(
title: 'Updated Agent Name',
description: 'Full markdown content for agent...'
)
```
2. Export to .md file
```bash
# Generate .claude/agents/*.md from database
cd backend && bundle exec rake agents:export_definitions
```
3. Trinity Bible (Agent behavior summary)
```ruby
# Update high-level description in Bible
Trinity.find_by(
category: 'bible',
chapter_number: 21,
title: 'Agent Name'
).update!(
description: 'High-level what it does...'
)
```
โข Single source of truth (Trinity database)
โข .md files auto-generated from database
โข No manual sync needed
โข Frontend can read from API
โข Manually edit .claude/agents/*.md files
โข Keep agent data in multiple places
โข Update only one location

