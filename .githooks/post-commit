#!/bin/bash

# Post-commit hook to automatically increment version and include package.json changes
# This hook runs after a commit and amends it with version updates

# Skip if this is already an amended commit (prevent infinite loop)
if [ -f .git/AMENDING ]; then
  rm .git/AMENDING
  exit 0
fi

# Check authorship first - only proceed if last commit is by current user
LAST_COMMIT_AUTHOR=$(git log -1 --format='%ae')
CURRENT_USER_EMAIL=$(git config user.email)

# Check if commit has been pushed
if git branch -r --contains HEAD | grep -q "origin/$(git rev-parse --abbrev-ref HEAD)"; then
  exit 0
fi

if [ "$LAST_COMMIT_AUTHOR" != "$CURRENT_USER_EMAIL" ]; then
  exit 0
fi

# Increment frontend version
echo "üì¶ Incrementing frontend version..."
cd frontend && node scripts/increment-version.js && cd ..

# Check if there are unstaged changes to package files
if git diff --name-only | grep -q "frontend/package.*\.json"; then
  echo "üì¶ Amending commit with version changes..."

  # Mark that we're amending to prevent infinite loop
  touch .git/AMENDING

  # Stage package.json changes
  git add frontend/package.json frontend/package-lock.json 2>/dev/null

  # Amend the commit without changing the message
  git commit --amend --no-edit --no-verify

  echo "‚úÖ Package version changes added to commit"

  # Auto-push to remote branch
  CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
  echo "üöÄ Pushing to origin/$CURRENT_BRANCH..."
  git push origin "$CURRENT_BRANCH" --force-with-lease

  if [ $? -eq 0 ]; then
    echo "‚úÖ Successfully pushed to remote"
  else
    echo "‚ö†Ô∏è  Failed to push to remote"
  fi
fi
