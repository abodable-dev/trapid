================================================================================
TRAPID CODEBASE INVESTIGATION - COMPLETE
Investigation Date: November 14, 2025
Scope Level: VERY THOROUGH
================================================================================

INVESTIGATION SCOPE:
✓ Authentication system (models, controllers, JWT, OAuth)
✓ User model and role-based permissions
✓ Contact/Supplier models and relationships
✓ Purchase Order models and lifecycle
✓ Invoice and payment tracking
✓ Rating and review systems
✓ Frontend components
✓ Database schema analysis
✓ API endpoint documentation

================================================================================
DOCUMENTATION CREATED:
================================================================================

1. AUTHENTICATION_AND_CONTACTS_INVESTIGATION.md (39 KB, COMPREHENSIVE)
   - 10 major sections covering all systems
   - Complete database schema documentation
   - All model relationships explained
   - 13 backend models detailed
   - 8 contact-related models documented
   - Full API endpoint routes
   - Frontend component listing
   - Production readiness assessment
   - Key file locations with absolute paths

2. AUTH_AND_CONTACTS_QUICK_REFERENCE.md (12 KB, QUICK LOOKUP)
   - Quick reference guide for developers
   - File path index
   - Role and permission quick table
   - Common task walkthroughs
   - API endpoints summary
   - Database schema visualization
   - Production readiness checklist
   - Password requirements
   - Payment methods and statuses

3. This summary file (INVESTIGATION_SUMMARY.txt)

================================================================================
KEY FINDINGS:
================================================================================

AUTHENTICATION:
- JWT Token-based with 24-hour expiry
- BCrypt password hashing
- OAuth support (Microsoft Office 365)
- Password complexity: 12+ chars, 1 uppercase, 1 lowercase, 1 digit, 1 special
- ISSUE: Authorization middleware is PLACEHOLDER (not production-ready)

USER ROLES (6 types):
- user: Basic user
- admin: Full system access
- product_owner: Product management
- estimator: Estimation features
- supervisor: Supervision/site tasks
- builder: Builder/field tasks

CONTACT SYSTEM (8 models):
- Contact: Main multi-type model (customer, supplier, sales, land_agent)
- ContactPerson: Individual people in organization
- ContactRelationship: Bidirectional network relationships (9 types)
- ContactActivity: Audit log with polymorphic performer
- ContactGroup: Xero contact groups
- ContactRole: Custom roles for job assignments
- ConstructionContact: Job-specific contact linking
- SupplierContact: Supplier-contact junction (M2M)

SUPPLIER SYSTEM:
- Status: IN TRANSITION from separate model to Contact-based
- Metrics: rating (0-5), response_rate (0-100%), avg_response_time (hours)
- Matching: confidence_score, match_type, is_verified
- Trade categories and default suppliers for categories
- Markup percentage support

PURCHASE ORDERS (Complete Lifecycle):
- Statuses (8): draft → pending → approved → sent → received → invoiced → paid/cancelled
- Payment statuses (4): pending, part_payment, complete, manual_review
- Financial tracking: sub_total, tax, total, budget, variance calculations
- Xero integration for invoice/payment tracking
- Automatic callbacks: calculate_totals, calculate_variances, update_construction_profit
- Line items with price drift detection (warns if >10% from pricebook)

PAYMENTS:
- Payment model with multiple methods: bank_transfer, check, credit_card, cash, eft, other
- Xero sync tracking: xero_payment_id, xero_synced_at, xero_sync_error
- Callback: After payment change, recalculates PO payment_status
- Scopes: recent, by_purchase_order, synced_to_xero, with_sync_errors

RATING & REVIEW SYSTEMS:
- Supplier ratings: 0-5 stars with response_rate and response_time metrics
- Price item risk scoring: 0-100 composite from 4 factors
  * Price Freshness (40%)
  * Supplier Reliability (20%)
  * Price Volatility (20%)
  * Missing Info (20%)
- Risk levels: low (<25), medium (25-50), high (50-75), critical (>75)
- Estimate reviews: AI-powered with status (pending, processing, completed, failed)
- Contact activity log: 7 activity types tracked

DATABASE SCHEMA:
13 key tables detailed with full field specifications:
- users (6 roles, OAuth fields, password reset tokens)
- contacts (contact_types array, supplier metrics, Xero sync)
- contact_persons, contact_addresses, contact_groups
- contact_relationships (bidirectional)
- contact_activities (audit log)
- suppliers (legacy, transitioning)
- supplier_contacts (junction)
- purchase_orders (full lifecycle)
- purchase_order_line_items (with tax, price drift)
- payments (with Xero sync)
- pricebook_items (with risk scoring, images, QR codes)
- price_histories (audit trail)
- estimate_reviews (AI analysis)

AUTHENTICATION GEMS:
- bcrypt (~> 3.1.7): Password hashing
- jwt (~> 2.7): Token generation/validation
- omniauth (~> 2.1): OAuth framework
- omniauth-microsoft-office365: Office 365 provider
- omniauth-rails_csrf_protection: CSRF protection

FRONTEND COMPONENTS (17+ specialized):
- Auth: AuthContext, Login, Signup, AuthCallback, Logout, Profile
- Contacts: Page, Detail, Persons, Addresses, Groups, Relationships, Merge, LinkXero
- Suppliers: Page, Detail, Edit, New
- Purchase Orders: Page, Detail, Edit
- Price Books: Page, Item Detail with history tracking

================================================================================
CRITICAL ISSUES IDENTIFIED:
================================================================================

1. AUTHENTICATION MIDDLEWARE PLACEHOLDER
   Location: /Users/rob/Projects/trapid/backend/app/controllers/application_controller.rb
   Current Code:
     def authorize_request
       @current_user = User.first || User.create!(...)  # Returns default user!
     end
   Status: NOT PRODUCTION READY
   Impact: No actual JWT validation occurring
   Fix Needed: Implement JWT token extraction and validation from Authorization header

2. SUPPLIER-CONTACT TRANSITION IN PROGRESS
   Status: Dual model system (Supplier + Contact)
   Impact: Some tables reference both supplier_id and contact_id
   Mitigation: SupplierContact junction bridges during transition
   Note: All new development should use Contact model with contact_types=['supplier']

================================================================================
PRODUCTION READINESS CHECKLIST:
================================================================================

Authentication & Security:
- [ ] Implement actual JWT token validation in middleware
- [ ] Add rate limiting to auth endpoints
- [ ] Implement password reset email flow
- [ ] Add OAuth callback security validation
- [ ] Implement CSRF token validation
- [ ] Add login attempt rate limiting

Contact & Supplier Management:
- [ ] Implement contact merge conflict resolution
- [ ] Add contact deduplication service
- [ ] Complete Xero sync error handling
- [ ] Implement bidirectional sync with Xero
- [ ] Add audit logging for sensitive changes

Purchase Order & Payment:
- [ ] Invoice matching algorithm refinement
- [ ] Complete Xero invoice/payment sync
- [ ] Add PO approval workflow validation
- [ ] Implement payment reconciliation
- [ ] Add budget variance alerting

Authorization & Permissions:
- [ ] Add role-based API endpoint protection
- [ ] Implement resource-level permissions
- [ ] Add audit trail for permission changes
- [ ] Implement SSO integration
- [ ] Add MFA support

================================================================================
FILE LOCATIONS (ABSOLUTE PATHS):
================================================================================

Backend Models (13 files):
/Users/rob/Projects/trapid/backend/app/models/user.rb
/Users/rob/Projects/trapid/backend/app/models/contact.rb
/Users/rob/Projects/trapid/backend/app/models/contact_person.rb
/Users/rob/Projects/trapid/backend/app/models/contact_relationship.rb
/Users/rob/Projects/trapid/backend/app/models/contact_activity.rb
/Users/rob/Projects/trapid/backend/app/models/supplier.rb
/Users/rob/Projects/trapid/backend/app/models/supplier_contact.rb
/Users/rob/Projects/trapid/backend/app/models/purchase_order.rb
/Users/rob/Projects/trapid/backend/app/models/purchase_order_line_item.rb
/Users/rob/Projects/trapid/backend/app/models/payment.rb
/Users/rob/Projects/trapid/backend/app/models/pricebook_item.rb
/Users/rob/Projects/trapid/backend/app/models/price_history.rb
/Users/rob/Projects/trapid/backend/app/models/estimate_review.rb

Backend Controllers & Services:
/Users/rob/Projects/trapid/backend/app/services/json_web_token.rb
/Users/rob/Projects/trapid/backend/app/controllers/api/v1/authentication_controller.rb
/Users/rob/Projects/trapid/backend/app/controllers/api/v1/omniauth_callbacks_controller.rb
/Users/rob/Projects/trapid/backend/app/controllers/application_controller.rb

Frontend Components:
/Users/rob/Projects/trapid/frontend/src/contexts/AuthContext.jsx
/Users/rob/Projects/trapid/frontend/src/pages/Login.jsx
/Users/rob/Projects/trapid/frontend/src/pages/Signup.jsx
/Users/rob/Projects/trapid/frontend/src/pages/AuthCallback.jsx
/Users/rob/Projects/trapid/frontend/src/pages/ContactsPage.jsx
/Users/rob/Projects/trapid/frontend/src/pages/ContactDetailPage.jsx
/Users/rob/Projects/trapid/frontend/src/pages/SuppliersPage.jsx
/Users/rob/Projects/trapid/frontend/src/pages/SupplierDetailPage.jsx
/Users/rob/Projects/trapid/frontend/src/pages/PurchaseOrdersPage.jsx
/Users/rob/Projects/trapid/frontend/src/pages/PurchaseOrderDetailPage.jsx
/Users/rob/Projects/trapid/frontend/src/pages/PriceBooksPage.jsx
/Users/rob/Projects/trapid/frontend/src/components/contacts/ (multiple)

Database:
/Users/rob/Projects/trapid/backend/db/schema.rb (current schema)
/Users/rob/Projects/trapid/backend/db/migrate/ (all migrations)

Routes:
/Users/rob/Projects/trapid/backend/config/routes.rb

================================================================================
HOW TO USE THE DOCUMENTATION:
================================================================================

For Detailed Technical Reference:
→ Read: AUTHENTICATION_AND_CONTACTS_INVESTIGATION.md
  Use for: Deep understanding, schema analysis, relationships, code examples

For Quick Development Reference:
→ Read: AUTH_AND_CONTACTS_QUICK_REFERENCE.md
  Use for: Daily development, common tasks, API endpoints, quick lookups

For API Development:
→ Look in: AUTH_AND_CONTACTS_QUICK_REFERENCE.md → "API Endpoints Summary"
→ Reference: backend/config/routes.rb for complete route definitions

For Adding New Roles:
→ Look in: Both docs → "User Roles" sections
→ Files: backend/app/models/user.rb (update ROLES constant)

For Contact Operations:
→ Reference: AUTHENTICATION_AND_CONTACTS_INVESTIGATION.md → "Contact & Supplier System"
→ Models: All contact_*.rb files in backend/app/models/

For Purchase Order Workflows:
→ Reference: AUTH_AND_CONTACTS_QUICK_REFERENCE.md → "Purchase Orders" section
→ Key file: backend/app/models/purchase_order.rb
→ Methods: approve!, send_to_supplier!, mark_received!, apply_invoice!

For Payment Processing:
→ Reference: AUTHENTICATION_AND_CONTACTS_INVESTIGATION.md → "Payment Tracking" section
→ Key file: backend/app/models/payment.rb

================================================================================
QUESTIONS TO ASK WHEN USING THIS INFORMATION:
================================================================================

Authentication:
- "How do I validate a JWT token?" → See JsonWebToken service
- "How do I add a new role?" → See User model, ROLES constant

Contacts:
- "How do I create a bidirectional relationship?" → See ContactRelationship model
- "How do I merge contacts?" → See Contact model, contacts_controller merge action

Suppliers:
- "Should I use Supplier or Contact model?" → Use Contact with contact_types=['supplier']
- "How do I match suppliers to contacts?" → See Supplier model, match_status method

Purchase Orders:
- "What's the full PO lifecycle?" → See Purchase Order statuses in both docs
- "How do I approve a PO?" → Use PurchaseOrder#approve! method

Payments:
- "How are payments linked to POs?" → See Payment model, belongs_to :purchase_order
- "How does Xero sync work?" → See Payment model, xero_synced_at, xero_sync_error

Permissions:
- "How do I check if user can do X?" → Use User permission methods (can_create_templates?, etc.)

================================================================================
INVESTIGATION COMPLETE
================================================================================

Total Files Analyzed: 60+
Database Migrations Reviewed: 84
Schema Tables Documented: 13+
Models Documented: 13 core
Associated Models: 8 contact-related
Controllers/Services: 4 auth-related
Frontend Components: 17+ specialized

Documentation Status: COMPREHENSIVE & COMPLETE
Ready for: Development, Production Planning, Audits, Feature Planning

================================================================================
